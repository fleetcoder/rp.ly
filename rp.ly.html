<!DOCTYPE html>
<html>
  <head><meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>rp.ly</title>

    <link href=/file/app.f6299154743b22e4ec60751bc6631bb6.css rel=stylesheet>
    <script type=text/javascript src=/file/manifest.2ae2e69a05c33dfc65f8.js></script>
    <script type=text/javascript src=/file/vendor.0eb5480a7e9a156e90f2.js></script>
    <script type=text/javascript src=/file/app.be9945027a8323d84e7d.js></script>
    <script type=text/javascript src=/file/socket.io.js></script>
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/file/rply57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/file/rply72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/file/rply114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/file/rply144.png" />
  </head>
  <body>

    <div id="app"><router-view class="view"></router-view></div>

    <style id="style">
      div.mint-cell-wrapper > div.mint-cell-value > input {
        background-color: #eee
      }
      .startbuttons {
        margin: 15px
      }
      .mint-header {
        background-color: green
      }
      #app {
        margin:0;
      }
      .mint-button--primary {
        background-color: gray
      }
      .mint-button--normal {
        background-color: rgb(174,223,253)
      }
      .mint-button--default {
        background-color: rgb(174,223,253)
      }
      .is-hidden {
        display: none
      }
      .file-upload .input-wrapper {
        background-color: gray
      }
      .img {
        width:100%;
        height:auto
      }
      .contact {
        list-style:none;
        text-align:right;
        margin-top:30px;
      }
      .contacts {
        margin-top:15px;
      }
      .addcontact {
        padding:10px;
      }
      .fieldlist div.mint-cell-wrapper > div.mint-cell-value > input {
        background-color: #fff
      }
      .caption {
      }
      .feedimg {
        width:100%;
        height:auto
        padding:0;
        margin:0;
      }
      .imagecell {
        position:relative;
        overflow:hidden;
        padding:0;
        margin:0;
      }
      .options {
        padding-right:20px;
      }
      .vidframe {
        margin:30px;
      }
      .groupimg {
        width:300px;
        height:auto
        padding:100px;
        margin:0;
      }
      .hosted-field {
        height: 50px;
        box-sizing: border-box;
        width: 100%;
        padding: 12px;
        display: inline-block;
        box-shadow: none;
        font-weight: 500;
        font-size: 14px;
        border-radius: $radius-default;
        border: 1px solid #dddddd;
        line-height: 20px;
        background: #fcfcfc;
        margin-bottom: 12px;
        background: linear-gradient(to right, white 50%, #fcfcfc 50%);
        background-size: 200% 100%;
        background-position: right bottom;
        transition: all 300ms ease-in-out;
      }
      .hosted-fields--label {
        font-family: courier, monospace;
        text-transform: uppercase;
        font-size: 14px;
        display: block;
        margin-bottom: 6px;
      }
      .button-container {
        display: block;
        text-align: center;
      }
      .braintree-hosted-fields-focused {
        border: 1px solid #64d18a;
        border-radius: $radius-default;
        background-position: left bottom;
      }
      .braintree-hosted-fields-invalid {
        border: 1px solid #ed574a;
      }
      .braintree-hosted-fields-valid {
      }
      #cardForm {
        max-width: 50.75em;
        margin: 0 auto;
        padding: 1.875em;
      }
      .dropbox {
        outline: 2px dashed grey;
        outline-offset: -10px;
        background: #DDD;
        color: dimgray;
        padding: 10px 10px;
        position: relative;
        cursor: pointer;
        margin-top: 10px;
      }
      .input-file {
        opacity: 0;
        width: 100%;
        position: absolute;
        cursor: pointer;
      }
      .dropbox:hover {
        background: #AEA;
      }
      .img-thumbnail {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        width: 150px;
      }
      .list-unstyled {
        list-style:none;
      }
      .uploadlabel {
        font-size: 1.4em;
      }
      #savepostbutton {
        margin-top: 10px;
      }
    </style>

    <script id="client">
      
      const STATUS_INITIAL = 0, STATUS_SAVING = 1, STATUS_SUCCESS = 2, STATUS_FAILED = 3;
      
      const freeTrial = {
        data() {
          return {
            spinnerHidden : true,
            email: '',
            emailstatus: '',
            sent : false,
            phone : '',
            inputhidden: true,
            inputnamehidden: true,
            code: '',
            name:'',
            loginHidden: true,
            registerHidden: true,
            sentcode: ''
          }
        },
        created() {
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'freeTrialStart', {
              code : this.code,
              email : this.email,
              phone : this.phone,
              name: this.name
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
              }
            })
          },
          validateEmail(email) {
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email)
          },
          myLogin(){
            if (this.email.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.email).toLowerCase())) {
                this.emailstatus = 'success'
                Vue.http.post( 'freeTrialLogin', {
                  email : this.email,
                  phone : this.phone,
                  name: this.name
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.sent = true
                  this.inputhidden = false
                  this.sentcode = 'A code was just sent to your email address'
                  this.loginHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.email.match(/\d/g).length===10) {
                this.emailstatus = 'success'
                this.phone = this.email
                this.email = ''
                Vue.http.post( 'freeTrialLogin', {
                  email : this.email,
                  phone : this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inputhidden = false
                  this.sent = true
                  this.sentcode = 'A code was just sent to your phone'
                  this.loginHidden = true
                 /* MintUI.Toast({
                    message: 'Check your text messages for a link!',
                    iconClass: 'icon icon-success',
                    duration: 10000
                   })*/
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          doLogin(){
            this.loginHidden = false
            this.registerHidden = true
          },
          doRegister(){
            this.loginHidden = true
            this.registerHidden = false
          },
          doTrial(){
            if (this.email.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.email).toLowerCase())) {
                this.emailstatus = 'success'
                Vue.http.post( 'freeTrial', {
                  email : this.email,
                  phone : this.phone,
                  name: this.name
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.sentcode = 'A code was just sent to your email address'
                  this.registerHidden = true
                  this.sent = true
                  this.inputhidden = false
                  this.inputnamehidden = false
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.email.match(/\d/g).length===10) {
                this.emailstatus = 'success'
                this.phone = this.email
                this.email = ''
                Vue.http.post( 'freeTrial', {
                  email : this.email,
                  phone : this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.sentcode = 'A code was just sent to your phone'
                  this.registerHidden = true
                  this.inputhidden = false
                  this.inputnamehidden = false
                  this.sent = true
                 /* MintUI.Toast({
                    message: 'Check your text messages for a link!',
                    iconClass: 'icon icon-success',
                    duration: 10000
                   })*/
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          }
        },
        template: `
          <div>
            <mt-cell><h1>rp.ly</h1>&nbsp;&nbsp;&nbsp;&nbsp;<p>Âµblog</p></mt-cell>
            <mt-button type="default" class="startbuttons" v-on:click="doLogin()">Log In</mt-button><mt-button type="default" class="startbuttons" v-on:click="doRegister()">Register</mt-button>
            <mt-field v-bind:class="{'is-hidden':registerHidden}" label="Register:" placeholder="Email or Phone Number..." type="email" :state="emailstatus" v-model="email"></mt-field>
            <mt-button v-bind:class="{'is-hidden':registerHidden}" v-on:click="doTrial()" size="large">Submit</mt-button>
            <mt-field v-bind:class="{'is-hidden':loginHidden}" label="Log In:" placeholder="Email or Phone Number..." type="email" :state="emailstatus" v-model="email"></mt-field>
            <mt-button v-bind:class="{'is-hidden':loginHidden}" v-on:click="myLogin()" size="large">Submit</mt-button>
            <mt-cell v-bind:class="{'is-hidden':inputhidden}">{{sentcode}}</mt-cell>
            <mt-field v-bind:class="{'is-hidden':inputnamehidden}" label="Name:" placeholder="Your name..." v-model="name"></mt-field>
            <mt-field v-bind:class="{'is-hidden':inputhidden}" label="Code:" placeholder="***" v-model="code"></mt-field>
            <mt-button v-bind:class="{'is-hidden':inputhidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <div class="vid"></div></div>`
      }
      const connect = {
        data() {
          return {
            code:'',
            spinnerHidden:false,
            sentcode: ''
          }
        },
        props: {},
        created() {
          if (!(window.location.href.match(/\/g\//g) === null)) {
            window.location.href = 'https://' + window.location.hostname + '/#/connect/' + this.$route.params.code
            return
          }
          this.spinnerHidden = false
          Vue.http.post( 'doConnect', {
            code:this.$route.params.code
          }).then( ( response ) => {
            if (response.body[0] == 'OK') {
              window.location.href = '/'
            } else {
              this.sentcode = 'A code was just sent to your ' + response.body[0]
            }
            this.spinnerHidden = true
          })
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'doCode', {
              code:this.code,
              connect:this.$route.params.code
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
              }
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="rp.ly">
            </mt-header>
            <mt-cell>{{sentcode}}</mt-cell>
            <mt-field label="Code:" placeholder="***" v-model="code"></mt-field>
            <mt-button v-on:click="doCode()" size="large">Submit Code</mt-button>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const GroupPage = {
        data() {
          return {
            grp:'',
            spinnerHidden:false,
            inviteText: ' invited you to join ',
            submitText: '',
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            imgHidden: true,
            groupPic: '',
            signupHidden : false,
            ownname: '',
            grpname: '',
            emailstatus : '',
            docodehidden : true,
            code: '',
            signupBtnHidden : false
          }
        },
        props: {},
        created() {
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            if (response.body[3] == 'AUTHED') {
              this.signupHidden = true
              this.signupBtnHidden = false
            } else {
              this.signupHidden = false
              this.signupBtnHidden = false
            }
            this.ownname = response.body[0]
            this.grpname = response.body[1]
            this.inviteText = response.body[0] + this.inviteText + response.body[1]
            this.submitText = 'Join ' + response.body[0] + "'s Group"
            this.groupPic = response.body[2]
            this.imgHidden = false
            this.spinnerHidden = true
          })
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'freeTrialStart', {
              code : this.code,
              grp : this.$route.params.grp,
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
              }
            })
          },
          doJoin() {
            this.spinnerHidden = false
            this.inviteText = ''
            this.docodehidden = false
            if (this.signupHidden) {
              Vue.http.post( 'doJoin', {
                grp : this.$route.params.grp,
                name : this.newName,
                email : this.newEmail,
                phone : this.newPhone
              }).then( ( response ) => {
                if (response.body[0] == 'error') {
                  MintUI.Toast({
                    message: 'Error',
                    iconClass: 'icon icon-error',
                    duration: 2000
                  })
                  return
                }
                MintUI.Toast({
                  message: 'You have been added to the group',
                  iconClass: 'icon icon-success',
                  duration: 2000
                })
                this.spinnerHidden = true
                router.push('/')
              })
            } else if (this.newEmail.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newEmail).toLowerCase())) {
                this.emailstatus = 'success'
                Vue.http.post( 'doJoin', {
                  grp : this.$route.params.grp,
                  name : this.newName,
                  email : this.newEmail,
                  phone : this.newPhone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inviteText = 'A code was just sent to your email address'
                  this.spinnerHidden = true
                  this.signupHidden = true
                  this.signupBtnHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.newEmail.match(/\d/g).length===10) {
                this.emailstatus = 'success'
                this.newPhone = this.newEmail
                this.newEmail = ''
                Vue.http.post( 'doJoin', {
                  grp : this.$route.params.grp,
                  name : this.newName,
                  email : this.newEmail,
                  phone : this.newPhone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inviteText = 'A code was just sent to your phone'
                  this.spinnerHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          checkConName() {
            this.validName = "success"
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newContact).toLowerCase())) {
                this.validContact = "success"
                this.newEmail = this.newContact
              } else {
                this.validContact = "error"
              }
            } else {
              if (this.newContact.substring(0, 2) == '+1') {
                this.newContact = this.newContact.substring(2)
              }
              if (!(this.newContact.match(/\d/g) === null))
                if (this.newContact.match(/\d/g).length===10) {
                  this.validContact = "success"
                  this.newPhone = this.newContact
                } else {
                  this.validContact = "error"
                }
            }
          }
        },
        template: `
          <div>
            <mt-header title="rp.ly">
            </mt-header>
            <mt-cell v-bind:class="{'is-hidden':imgHidden}" title=""><img class="groupimg" :src="groupPic" /></mt-cell>
            <mt-cell :title="inviteText"></mt-cell>
            <mt-field v-bind:class="{'is-hidden':signupHidden}" :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
            <mt-field v-bind:class="{'is-hidden':signupHidden}" :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
            <mt-button v-bind:class="{'is-hidden':signupBtnHidden}" v-on:click="doJoin()" size="large">{{submitText}}</mt-button>
            <mt-field v-bind:class="{'is-hidden':docodehidden}" label="Code:" placeholder="***" v-model="code"></mt-field>
            <mt-button v-bind:class="{'is-hidden':docodehidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const listPosts = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean },
        methods: {
          openImage(idx){
            router.push( '/showPosts/' + idx )
          },
          showLink(){
            this.$emit('on-show-menu')
          },
          delPosts( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delPosts', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          }
        },
        template: `
          <div>
            <mt-header title="rp.ly">
              <a v-on:click="showLink()" slot="right">
                <mt-button icon="more"></mt-button>
              </a>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell class="imagecell" v-for="(item, idx) in items" :title="item.name">
              <p class="caption" v-text="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <figure class="imagecell" v-bind:class="{'is-hidden':item.imageHidden}">
                <img v-on:click="openImage(idx)" class="feedimg" :src="imageLink(item)" />
                <figcaption class="caption" v-text="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </figure>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
            </mt-cell>
          </div>`
      }
      const showPosts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            title : '',
            image : '',
            sound : '',
            soundHidden : false,
            imageHidden : false
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.items[ this.idx ].id
            this.title = this.items[ this.idx ].title
            this.image = this.items[ this.idx ].image
            this.sound = this.items[ this.idx ].sound
            if (this.sound == '') {
              this.soundHidden = true
            }
            if (this.image == '') {
              this.imageHidden = true
            }
            this.$emit('on-tabs-hidden')
          },
          delPosts(){
            var showposts = this
            MintUI.MessageBox({
              title: 'Delete',
              message: 'Are you sure you want to delete this post?',
              showCancelButton: true,
              confirmButtonText: 'Confirm Delete',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                showposts.spinnerHidden = false
                Vue.http.post( 'delPosts', {
                  id:showposts.id
                }).then( ( response ) => {
                  showposts.spinnerHidden = true
                  showposts.items.splice( showposts.idx, 1 )
                  router.push('/')
                })
              }
            })

          }
        },
        template: `
          <div>
            <mt-header title="rp.ly">
              <router-link to="/" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell  :title="title"></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':imageHidden}"><img class="img" :src="'myFile?field=image&name=' + image" /></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':soundHidden}"><audio-player :src="'myFile?field=sound&name=' + sound" /></mt-cell>
            <mt-button size="large" v-on:click="delPosts()">Delete Photo</mt-button>

          </div>`
      }
      const modPosts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            title : '',
            image : '',
            sound : ''
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.title = this.items[ this.idx ].title
          this.image = this.items[ this.idx ].image
          this.sound = this.items[ this.idx ].sound

          this.$emit('on-tabs-hidden')
        },
        methods: {
          modPosts(){
            this.spinnerHidden = false
            Vue.http.post( 'modPosts', {
              id : this.id,
              title : this.title
            }).then( ( response ) => {
              this.$emit('on-update-list')
              router.push( '/' )
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => { 
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="rp.ly">
              <router-link :to="'/showPosts/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Title:" placeholder="Title.." v-model="title"></mt-field>
            <mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
            <file-upload btn-label="Image" @change="stagedUpload('image')" :url="uploadTo + '&field=image'"></file-upload>
            <mt-cell title="Sound:"><audio-player :src="'myFile?staged=1&field=sound&name=' + sound" /></mt-cell>
            <audio-recorder :upload-url="uploadTo + '&field=sound'"/>
            <mt-button v-on:click="modPosts()" size="large">Save</mt-button>
          </div>`
      }
      const Posts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadMulti',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            title : '',
            image : '',
            cgroups:[{id:1,user_id:1,name:'Admins',perms:[],members:[]},{id:2,user_id:1,name:'Group 2',perms:[],members:[]},{id:3,user_id:1,name:'Group 3',perms:[],members:[]}],
            contacts:[{id:1,user_id:1,name:'Me',email:'',phone:'',groups:[1,2,3]}],
            lastgroups : [],
            saveHidden: false,
            uploadHidden: false,
            imgHidden: true,
            linkVisible: false,
            feedsVisible: false,
            feedLink: '',
            addFeed: '',
            feeds: [],
            textHidden: false,
            audioHidden: false,
            showAddContact: false,
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            doExpire: true,
            expireHours: '24',
            optionsBtnHidden: false,
            optionsHidden: true,
            sponsorVisible: false,
            subs: [],
            btAuth: '',
            plan: 'fans50',
            plans:[{label: '$3 / 6 months',value: 'fans50'},{label: '$3 / month',value: 'fans300'}],
            cangrps: [],
            sponsorGroup: '',
            sponsorGroupName: '',
            btLoaded:false,
            formHidden: true,
            btSpinnerHidden:false,
            subsVisible: false,
            subsHidden: true,
            settingsSpinnerHidden:true,
            uploadedFiles: [],
            uploadError: null,
            currentStatus: null,
            uploadFieldName: 'photos'
          }
        },
        computed: {
          isInitial() {
            return this.currentStatus === STATUS_INITIAL
          },
          isSaving() {
            return this.currentStatus === STATUS_SAVING
          },
          isSuccess() {
            return this.currentStatus === STATUS_SUCCESS
          },
          isFailed() {
            return this.currentStatus === STATUS_FAILED
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-posts' : showPosts
        },
        created() {
          if (!(window.location.href.match(/\/grp\//g) === null)) {
            var grp = window.location.pathname.substr(window.location.pathname.lastIndexOf('/') + 1)
            window.location.href = 'https://' + window.location.hostname + '/#/group/' + grp
            return
          }
          if (this.$route.path == '/myContacts') {
            router.push('/')
            setTimeout(function (el){
              el.selected = 'tab2'
            }, 300, this)
          }
          Vue.http.get('isAuthed').then((response) => {
            if(parseInt(response.body) != 1) {
              router.push('auth')
            } else {
              this.getPosts()
              this.getContacts()
              this.getSettings()
            }
          })
        },
        methods: {
          closeSponsor() {
            this.sponsorVisible = !this.sponsorVisible
          },
          showOptions() {
            this.optionsBtnHidden = true
            this.optionsHidden = false
          },
          onExpireChange(){
            //this.doExpire = !this.doExpire
          },
          showSubs() {
            this.linkVisible = false
            this.subsVisible = true
          },
          showLink() {
            if (this.subs.length < 1) {
              if (typeof braintree !== "undefined") {
                this.settingsSpinnerHidden = false
                Vue.http.post( 'btSubs', {
                }).then( ( response ) => {
                  this.subs = response.body[0]
                  this.subsHidden = false
                  this.settingsSpinnerHidden = true
                })
              }
            }
            this.linkVisible = true
          },
          aftRec(data){
            MintUI.Toast({
              message: 'Click - Record 1 - and then click the floppy disk',
              iconClass: 'icon icon-success',
              duration: 10000
            })
          },
          getSettings() {
            Vue.http.get( 'getSettings').then( ( response ) => { 
              if ( !!response.body ) {
                this.feedLink = response.body.feedLink
                this.feeds = JSON.parse(response.body.feedSubs)
              }
            })
          },
          getContacts() {
            Vue.http.get( 'getContacts').then( ( response ) => { 
              if ( !!response.body ) {
                this.contacts = response.body[0]
                this.reloadGroups()
              }
            })
            Vue.http.get( 'getGroups').then( ( response ) => { 
              if ( !!response.body ) {
                this.cgroups = response.body[0]
                this.reloadGroups()
                if (this.cgroups[this.cgroups.length - 1].name == 'Group 1') {
                  MintUI.MessageBox({
                    title: 'Looks like you are new here',
                    message: 'Would you like to set up your first photo gallery?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes take me there',
                    cancelButtonText: 'No thanks'
                  }).then(action => {
                    if (action === 'confirm') {
                      router.push( 'groups' )
                    }
                  })
                }
              }
            })
          },
          reloadGroups() {
            this.lastgroups = []
            for (var i = 0; i < this.cgroups.length; i++) {
              this.cgroups[i].members = []
              this.cgroups[i].perms = []
              for (var j = 0; j < this.contacts.length; j++) {
                this.lastgroups.push([])
                if (this.contacts[j].groups.indexOf(this.cgroups[i].id) > -1) {
                  this.cgroups[i].members.push(this.contacts[j].id)
                  this.lastgroups[j].push(this.cgroups[i].id)
                }
                this.cgroups[i].perms.push({label: ' ',value: this.contacts[j].id})
              }
            }
          },
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getPosts() {
            this.spinnerHidden = false
            Vue.http.get( 'getPosts').then( ( response ) => { 
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  var socket = io( '/rply/' + response.body[3] )
                  socket.on( 'new item', this.cometAdd )
                }
                if (this.$route.path == '/myContacts') {
                  //this.selected = 'tab2'
                }
                for (var j = 0; j < response.body[4].length; j++) {
                  var grid = response.body[4][j]
                  Vue.http.post( 'joinGroup', {
                    grp:grid
                  }).then( ( response ) => {
                    this.cangrps.push({gname:response.body[1] + '',glink:response.body[4],guser:response.body[0]})
                  })
                }
              }
              this.spinnerHidden = true
            })
            
          },
          showSponsor(gr){
            this.sponsorGroup = gr.glink
            this.sponsorGroupName = 'Subscribe to ' + gr.gname
            this.sponsorVisible = true
            if (false === this.btLoaded) {
              Vue.http.post( 'btSetup', {
              }).then( ( response ) => {
                this.btAuth = response.body[0]
                this.subs = response.body[1]
                this.createHostedFields()
                this.btLoaded = true
                this.formHidden = false
                this.btSpinnerHidden = true
              })
            }
          },
          addPosts(){
            if (this.postto.length == 0) {
              MintUI.Toast({
                message: 'Select group(s) for your post',
                iconClass: 'icon icon-success',
                duration: 4000
              })
              return
            }
            var exp = this.expireHours
            if (this.doExpire === false) {
              exp = 0
            }
            this.spinnerHidden = false
            this.saveHidden = true
            this.groupsHidden = true
            this.uploadHidden = true
            this.imgHidden = true
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : this.title,
              expirehours: exp
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getPosts()
              this.title = ''
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
              this.reset()
            })
          },
          createHostedFields() {
            var postsobj = this
            if (typeof braintree !== "undefined" && this.btAuth != '') {
              braintree.setup(this.btAuth, "custom", {
                id: "cardForm",
                hostedFields: {
                  number: {
                    selector: "#card-number",
                    placeholder: "4111 1111 1111 1111"
                  },
                  cvv: {
                    selector: "#cvv",
                    placeholder: "111"
                  },
                  expirationDate: {
                    selector: "#expiration-date",
                    placeholder: "MM/YY"
                  },
                  postalCode: {
                    selector: "#postal-code",
                    placeholder: "32323"
                  },
                  styles: {
                    'input': {
                      'font-size': '16px',
                      'font-family': 'courier, monospace',
                      'font-weight': 'lighter',
                      'color': '#ccc'
                    },
                    ':focus': {
                      'color': 'black'
                    },
                    '.valid': {
                      'color': '#8bdda8'
                    }
                  }
                },
                onReady: function (integration) {
                  checkout = integration
                },
                onPaymentMethodReceived: function (nonce) {
                  
                  Vue.http.post( 'doSponsor', {
                    method:JSON.stringify(nonce),
                    plan_id:postsobj.plan,
                    group_id:postsobj.sponsorGroup
                  }).then( ( response ) => {
                    MintUI.Toast({
                      message: 'Thank you! Bills as FLEETCODER on your Credit Card Statement.',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                  })
                  checkout.teardown(function () {
                    checkout = null
                    postsobj.createHostedFields()
                    postsobj.sponsorVisible = false
                  })
                }
              })
            }
          },
          doSponsor(nonce){
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : this.title,
              expirehours: exp
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getPosts()
              this.title = ''
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
            })
            onPaymentMethodReceived
          },
          dropFeed(idx){
            Vue.http.post( 'dropFeed', {
              feed : idx
            }).then( ( response ) => {
              this.feeds = response.body
            })
          },
          doLogout(){
            Vue.http.post( 'logout', {
            }).then( ( response ) => {
              window.location.href = '/'
            })
          },
          doAddFeed(){
            Vue.http.post( 'addFeeds', {
              feed : this.addFeed
            }).then( ( response ) => {
              this.feeds = response.body
              this.addFeed = ''
            })
          },
          showFeeds(){
            this.linkVisible = false
            this.feedsVisible = true
          },
          closeSettings(){
            this.linkVisible = false
          },
          closeFeeds(){
            this.feedsVisible = false
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => { 
              if ( !!response.body ) {
                this[field] = response.body
                this.imgHidden = false
                this.uploadHidden = true
              }
            })
          },
          dropSponsor(idx){
            var postsobj = this
            MintUI.MessageBox({
              title: 'Stop Subscription',
              message: 'Are you sure?',
              showCancelButton: true,
              confirmButtonText: 'Stop Subscription',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                this.spinnerHidden = false
                Vue.http.post( 'delSponsor', {
                  id:postsobj.subs[idx].id
                }).then( ( response ) => {
                  this.subs.splice( idx, 1 )
                  this.spinnerHidden = true
                })
              }
            })
          },
          quickContact(){
            this.showAddContact = true
          },
          cancelContact(){
            this.showAddContact = false
            this.newName = ''
            this.newEmail = ''
            this.newPhone = ''
            this.newContact = ''
          },
          checkConName() {
            this.validName = "success"
          },
          saveContact(){
            this.spinnerHidden = false
            Vue.http.post( 'quickAddContacts', {
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone
            }).then( ( response ) => {
              this.newName = ''
              this.newEmail = ''
              this.newPhone = ''
              this.newContact = ''
              this.getContacts()
              this.getPosts()
              this.showAddContact = false
            })
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
                var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (re.test(String(this.newContact).toLowerCase())) {
                  this.validContact = "success"
                  this.newEmail = this.newContact
                } else {
                  this.validContact = "error"
                }
              } else {
                if (this.newContact.substring(0, 2) == '+1') {
                  this.newContact = this.newContact.substring(2)
                }
                if (!(this.newContact.match(/\d/g) === null))
                  if (this.newContact.match(/\d/g).length===10) {
                    this.validContact = "success"
                    this.newPhone = this.newContact
                  } else {
                    this.validContact = "error"
                  }
              }
            
          },
          setGroups() {
            for (var j = 0; j < this.contacts.length; j++) {
              this.contacts[j].groups = []
              for (var i = 0; i < this.cgroups.length; i++) {
                if (this.cgroups[i].members.indexOf(this.contacts[j].id) > -1) {
                  if ("undefined" != typeof this.lastgroups[j]) {
                    if(this.lastgroups[j].indexOf(this.cgroups[i].id) !== -1){
                      
                    } else {
                      this.contacts[j].groups.push(this.cgroups[i].id)
                      console.log(this.contacts[j].name + ' added ' + this.cgroups[i].name)
                      Vue.http.post( 'modContactGroups', {
                        id : this.contacts[j].id,
                        groups : JSON.stringify(this.contacts[j].groups.concat(this.lastgroups[j]))
                      }).then( ( response ) => {
                        if ( !!response.body ) {
                          this.groups = response.body[0]
                        }
                      })
                    }
                  }
                } else {
                  if ("undefined" != typeof this.lastgroups[j]) {
                    if(this.lastgroups[j].indexOf(this.cgroups[i].id) !== -1){
                      console.log(this.contacts[j].name + ' removed ' + this.cgroups[i].name)
                      const index = this.lastgroups[j].indexOf(this.cgroups[i].id)
                      if (index > -1) {
                        this.lastgroups[j].splice(index, 1)
                      }
                      Vue.http.post( 'modContactGroups', {
                        id : this.contacts[j].id,
                        groups : JSON.stringify(this.lastgroups[j])
                      }).then( ( response ) => {
                        if ( !!response.body ) {
                          this.groups = response.body[0]
                        }
                      })
                    }
                  }
                }
              }
            }
            this.lastgroups = []
            for (var j = 0; j < this.contacts.length; j++) {
              this.lastgroups.push([])
              this.lastgroups[j] = []
              for (var i = 0; i < this.cgroups.length; i++) {
                if (this.cgroups[i].members.indexOf(this.contacts[j].id) > -1) {
                  this.lastgroups[j].push(this.cgroups[i].id)
                }
              }
            }
          },
          closeSubs(){
            this.subsVisible = false
          },
          reset() {
            this.currentStatus = STATUS_INITIAL
            this.uploadedFiles = []
            this.uploadError = null
          },
          save(formData) {
            this.currentStatus = STATUS_SAVING
            this.$http.post ( this.uploadTo + '?field=image', formData ).then(function (x) {
              this.uploadedFiles = x.body[0]
              this.currentStatus = STATUS_SUCCESS
            })
          },
          filesChange(fieldName, fileList) {
            const formData = new FormData()
            if (!fileList.length) return
            Array
              .from(Array(fileList.length).keys())
              .map(x => {
                formData.append(fieldName, fileList[x], fileList[x].name)
              })
            this.save(formData)
          }
        },
        mounted() {
          this.reset()
        },
        template: `
          <div>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:editHidden="editHidden" @on-update-list="getPosts" @on-tabs-hidden="hideTabs" @on-show-menu="showLink" />
                <mt-cell v-for="grp in cangrps" :title="'Would you like to see every post by ' + grp.guser + ' in ' + grp.gname + '?'"><mt-button type="primary" size="small" v-on:click="showSponsor(grp)">Become a Sponsor</mt-button></mt-cell>
                <mt-cell>&nbsp;</mt-cell>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="rp.ly"></mt-header>
                <mt-cell>
                  <ul class="contacts">
                    <li class="contact" v-for="friend in contacts">{{ friend.name }}</li>
                  </ul>
                  <mt-checklist v-for="(group,idx) in cgroups" :title="cgroups[idx].name"
                    v-model="cgroups[idx].members"
                    :options="cgroups[idx].perms"
                    align="right"
                    v-on:change="setGroups()">
                  </mt-checklist>
                </mt-cell>
                <mt-cell is-link to="/contacts" title="Contacts"></mt-cell>
                <mt-cell is-link to="/groups" title="Groups"></mt-cell>
                <mt-cell></mt-cell>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab3">
                <mt-header title="rp.ly"></mt-header>
                <mt-field v-bind:class="{'is-hidden':!textHidden}" placeholder="Title.." v-model="title"></mt-field>
                <mt-cell v-bind:class="{'is-hidden':imgHidden}" title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
                <mt-cell>
                  <form enctype="multipart/form-data" novalidate v-if="isInitial">
                    <div class="dropbox">
                      <label class="uploadlabel" for="image_uploads">Click here to choose photos, or drag files here</label>
                      <input id="image_uploads" type="file" multiple :name="uploadFieldName" :disabled="isSaving" @change="filesChange($event.target.name, $event.target.files); fileCount = $event.target.files.length"
                        accept="image/*" class="input-file">
                    </div>
                  </form>
                  <p class="dropboxp" v-if="isSaving">
                    Uploading {{ fileCount }} files...
                    <mt-spinner type="snake"></mt-spinner>
                  </p>
                  <div v-if="isSuccess">
                    <h2>Uploaded {{ uploadedFiles.length }} file(s) successfully.</h2>
                    <p>
                      <a href="javascript:void(0)" @click="reset()">Upload again</a>
                    </p>
                    <ul class="list-unstyled">
                      <li v-for="item in uploadedFiles">
                        <img :src="'myFile?staged=1&field=image&multiname=' + item.url" class="img-responsive img-thumbnail" :alt="item.originalName">
                      </li>
                    </ul>
                  </div>
                  <div v-if="isFailed">
                    <h2>Uploaded failed.</h2>
                    <p>
                      <a href="javascript:void(0)" @click="reset()">Try again</a>
                    </p>
                    <pre>{{ uploadError }}</pre>
                  </div>
                </mt-cell>
                <audio-recorder v-bind:class="{'is-hidden':!audioHidden}" :upload-url="'uploadFile?field=sound'" :after-recording="aftRec" />
                <mt-checklist v-bind:class="{'is-hidden':groupsHidden}"
                  v-model="postto"
                  :options="groups"
                  align="right">
                </mt-checklist>
                <mt-button v-bind:class="{'is-hidden':saveHidden}" v-on:click="quickContact()" size="large">Add Contact</mt-button>
                <mt-cell title="Expire after"><mt-field v-model="expireHours" label="hours"></mt-field><mt-switch v-model="doExpire" @change="onExpireChange()"></mt-switch></mt-cell>
                <mt-button v-bind:class="{'is-hidden':optionsBtnHidden}" v-on:click="showOptions()" size="large">Options</mt-button>
                <mt-cell v-bind:class="{'is-hidden':optionsHidden}"><mt-switch class="options" v-model="audioHidden">Podcast</mt-switch><mt-switch class="options" v-model="textHidden">Caption</mt-switch></mt-cell>
                <mt-button v-bind:class="{'is-hidden':saveHidden}" v-on:click="addPosts()" size="large" id="savepostbutton">Save</mt-button>
                <mt-cell>&nbsp;</mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            
            <mt-tabbar fixed="true" v-model="selected" v-bind:class="{'is-hidden':tabsHidden}">
              <mt-tab-item id="tab1">
                <img slot="icon" src="/file/home.svg">
                Gallery
              </mt-tab-item>
              <mt-tab-item id="tab2">
                <img slot="icon" src="/file/users.svg">
                Manage
              </mt-tab-item>
              <mt-tab-item id="tab3">
                <img slot="icon" src="/file/plus-circle.svg">
                Publish
              </mt-tab-item>
            </mt-tabbar>

            <mt-popup v-model="sponsorVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSponsor()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell :title="sponsorGroupName"></mt-cell>
              <mt-spinner v-bind:class="{'is-hidden':btSpinnerHidden}" type="snake"></mt-spinner>
              <form action="/" method="post" id="cardForm" v-bind:class="{'is-hidden':formHidden}">
                <label class="hosted-fields--label" for="card-number">Card Number</label>
                <div id="card-number" class="hosted-field"></div>
                <label class="hosted-fields--label" for="expiration-date">Expiration Date</label>
                <div id="expiration-date" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">CVV</label>
                <div id="cvv" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">Postal Code</label>
                <div id="postal-code" class="hosted-field"></div>
                <mt-radio v-model="plan" :options="plans"></mt-radio>
                <div class="button-container">
                  <input type="submit" class="button button--small button--green" value="Submit" id="submit"/>
                </div>
                <label class="hosted-fields--label">Cancel any time from the Settings menu</label>
              </form>
            </mt-popup>

            <mt-popup v-model="feedsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeFeeds()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(url, idx) in feeds">
                <mt-field v-model="url"></mt-field>
                <a v-on:click="dropFeed(idx)">
                  <mt-button>X</mt-button>
                </a>
              </mt-cell>
              <mt-field placeholder="Paste a feed link..." v-model="addFeed"></mt-field>
              <mt-button v-on:click="doAddFeed()" size="large">Save Feed</mt-button>
            </mt-popup>

            <mt-popup v-model="subsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSubs()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(artist, idx) in subs">
                <mt-cell :title="artist.name">
                  <a v-on:click="dropSponsor(idx)">
                    <mt-button>X</mt-button>
                  </a>
                </mt-cell>
              </mt-cell>
            </mt-popup>
            
            <mt-popup v-model="linkVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSettings()" slot="left">
                  <mt-button>X</mt-button>
                </a>
              </mt-header>
              <mt-cell></mt-cell>
              <mt-spinner v-bind:class="{'is-hidden':settingsSpinnerHidden}" type="snake"></mt-spinner>
              <mt-button v-bind:class="{'is-hidden':subsHidden}" v-on:click="showSubs()" size="large">Subscriptions</mt-button>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}"></mt-cell>
              <mt-cell title="Manage what you see in your rp.ly newsfeed by adding other rp ly sites or blogs"></mt-cell>
              <mt-button v-on:click="showFeeds()" size="large">Feeds</mt-button>
              <mt-cell></mt-cell>
              <mt-cell title="Your RSS feed link - paste it into any rp ly site, podcast app or feed reader to see your rp.ly feed there"></mt-cell>
              <mt-field v-model="feedLink"></mt-field>
              <mt-cell></mt-cell>
              <mt-button v-on:click="doLogout()" size="large">Logout</mt-button>
              <mt-cell></mt-cell>
            </mt-popup>
            
            <mt-popup class="addcontact" v-model="showAddContact" position="middle">
              <mt-field :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
              <mt-field :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
              <mt-button v-on:click="cancelContact()">Cancel</mt-button>&nbsp;<mt-button v-on:click="saveContact()" type="primary">Add Contact</mt-button>
            </mt-popup>
          
          </div>`
      }
      const listContacts = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean },
        methods: {
          delContacts( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delContacts', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="Contacts">
              <router-link to="/myContacts" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell-swipe v-for="(item, idx) in items" :title="item.name" is-link :to="'/showContacts/' + idx" :right="[
              {
                content: 'Delete',
                style: { background: 'red', color: '#fff' },
                handler: () => delContacts( item.id, idx )
              }
            ]">
            </mt-cell-swipe>
          </div>`
      }
      const showContacts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            email : '',
            phone : ''
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.items[ this.idx ].id
            this.name = this.items[ this.idx ].name
            this.email = this.items[ this.idx ].email
            this.phone = this.items[ this.idx ].phone
            this.$emit('on-tabs-hidden')
          }
        },
        template: `
          <div>
            <mt-header title="Contacts">
              <router-link to="/contacts" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
              <router-link :to="'/modContacts/' + idx" slot="right">
                <mt-button icon="more"></mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell title="Name:" :value="name"></mt-cell>
            <mt-cell title="Email:" :value="email"></mt-cell>
            <mt-cell title="Phone:" :value="phone"></mt-cell>
          </div>`
      }
      const modContacts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            email : '',
            phone : ''
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.name = this.items[ this.idx ].name
          this.email = this.items[ this.idx ].email
          this.phone = this.items[ this.idx ].phone

          this.$emit('on-tabs-hidden')
        },
        methods: {
          modContacts(){
            this.spinnerHidden = false
            Vue.http.post( 'modContacts', {
              id : this.id,
              name : this.name,
              email : this.email,
              phone : this.phone
            }).then( ( response ) => {
              this.$emit('on-update-list')
              router.push( '/' )
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => { 
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="Contacts">
              <router-link :to="'/showContacts/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Name:" placeholder="Name.." v-model="name"></mt-field>
            <mt-field label="Email:" placeholder="Email..(optional)" v-model="email" type="email"></mt-field>
            <mt-field label="Phone:" placeholder="Phone..(optional)" v-model="phone"></mt-field>
            <mt-button v-on:click="modContacts()" size="large">Save</mt-button>
          </div>`
      }
      const Contacts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            name : '',
            email : '',
            phone : '',
            validEmail: '',
            validPhone: ''
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-contacts' : showContacts
        },
        created() {
          this.getContacts()
        },
        methods: {
          checkEmail() {
            this.validEmail = ''
            var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (re.test(String(this.email).toLowerCase())) {
              this.validEmail = "success"
            } else {
              this.validEmail = "error"
            }
          },
          checkPhone() {
            this.validPhone = ''
            if (this.phone.match(/\d/g).length===10) {
              this.validPhone = "success"
            } else {
              this.validPhone = "error"
            }
          },
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getContacts() {
            this.spinnerHidden = false
            Vue.http.get( 'getContacts').then( ( response ) => { 
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.abilities.indexOf("modSource Code") > -1) {
                  this.editHidden = false
                }
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rply/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
              }
              this.spinnerHidden = true
            })
          },
          addContacts(){
            this.spinnerHidden = false
            Vue.http.post( 'addContacts', {
              recips:JSON.stringify(this.postto),
              name : this.name,
              email : this.email,
              phone : this.phone
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getContacts()
              this.name = ''
              this.email = ''
              this.phone = ''
              Posts.getContacts()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => { 
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>

            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:editHidden="editHidden" @on-update-list="getContacts" @on-tabs-hidden="hideTabs"  />
                <mt-cell>&nbsp;</mt-cell>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="Contacts"></mt-header>
                <mt-field placeholder="Name.." v-model="name"></mt-field>
                <mt-field :state="validEmail" @keyup.native="checkEmail" placeholder="Email..(optional)" v-model="email" type="email"></mt-field>
                <mt-field :state="validPhone" @keyup.native="checkPhone" placeholder="Phone..(optional)" v-model="phone"></mt-field>
                <mt-button v-on:click="addContacts()" size="large">Save</mt-button>
                <mt-cell>&nbsp;</mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            
            <mt-tabbar fixed="true" v-model="selected" v-bind:class="{'is-hidden':tabsHidden}">
              <mt-tab-item id="tab1">
                <img slot="icon" src="/file/home.svg">
                Contacts
              </mt-tab-item>
              <mt-tab-item id="tab2">
                <img slot="icon" src="/file/plus-circle.svg">
                Add Contact
              </mt-tab-item>
            </mt-tabbar>
          
          </div>`
      }
      const listGroups = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean },
        methods: {
          delGroups( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delGroups', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="Groups">
              <router-link to="/myContacts" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell-swipe v-for="(item, idx) in items" :title="item.name" is-link :to="'/showGroups/' + idx" :right="[
              {
                content: 'Delete',
                style: { background: 'red', color: '#fff' },
                handler: () => delGroups( item.id, idx )
              }
            ]">
            </mt-cell-swipe>
          </div>`
      }
      const showGroups = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            image : ''
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.items[ this.idx ].id
            this.name = this.items[ this.idx ].name
            this.$emit('on-tabs-hidden')
          },
          goEdit(idx) {
            router.push( '/modGroups/' + idx )
          }
        },
        template: `
          <div>
            <mt-header title="Groups">
              <router-link to="/groups" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
              <router-link :to="'/modGroups/' + idx" slot="right">
                <mt-button icon="more"></mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell title="Name:" :value="name"></mt-cell>
            <mt-button size="large" v-on:click="goEdit(idx)">Settings</mt-button>
          </div>`
      }
      const modGroups = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            image : '',
            showAddContact: false,
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            showShareGroup: false,
            groupLink: '',
            maxRes: '2000',
            doScale: true
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.name = this.items[ this.idx ].name
          this.image = this.items[ this.idx ].image
          var maxres = parseInt(this.items[ this.idx ].maxres)
          if (maxres > 0) {
            this.maxRes = this.items[ this.idx ].maxres
          }
          if (maxres === 0) {
            this.doScale = false
          }
          this.$emit('on-tabs-hidden')
        },
        methods: {
          closeShareGroup(){
            router.push( '/' )
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
                var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (re.test(String(this.newContact).toLowerCase())) {
                  this.validContact = "success"
                  this.newEmail = this.newContact
                } else {
                  this.validContact = "error"
                }
              } else {
                if (this.newContact.substring(0, 2) == '+1') {
                  this.newContact = this.newContact.substring(2)
                }
                if (!(this.newContact.match(/\d/g) === null))
                  if (this.newContact.match(/\d/g).length===10) {
                    this.validContact = "success"
                    this.newPhone = this.newContact
                  } else {
                    this.validContact = "error"
                  }
              }
            
          },
          checkConName() {
            this.validName = "success"
          },
          cancelContact(){
            this.showAddContact = false
            this.newName = ''
            this.newEmail = ''
            this.newPhone = ''
            this.newContact = ''
          },
          quickContact(){
            this.showAddContact = true
          },
          saveContact(){
            this.spinnerHidden = false
            Vue.http.post( 'quickAddContacts', {
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone,
              groups : JSON.stringify([this.id])
            }).then( ( response ) => {
              this.newName = ''
              this.newEmail = ''
              this.newPhone = ''
              this.newContact = ''
              this.showAddContact = false
            })
          },
          modGroups(){
            this.spinnerHidden = false
            if (this.name == 'Group 1') {
              MintUI.Toast({
                message: 'Error, choose a different group name',
                iconClass: 'icon icon-error',
                duration: 2000
              })
              return
            }
            var exp = this.expireHours
            if (this.doExpire === false) {
              exp = 0
            }

            var sca = this.maxRes
            if (this.doScale === false) {
              sca = 0
            }
            Vue.http.post( 'modGroups', {
              id : this.id,
              name : this.name,
              maxres : sca
            }).then( ( response ) => {
              this.$emit('on-update-list')
              this.showShareGroup = true
              this.groupLink = response.body
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => { 
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="Groups">
              <router-link :to="'/showGroups/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Name:" placeholder="Name.." v-model="name"></mt-field>
            <mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
            <file-upload btn-label="Set Group Image" @change="stagedUpload('image')" :url="uploadTo + '?field=image'"></file-upload>
            <mt-button v-on:click="quickContact()" size="large">Add Contact</mt-button>
            <mt-cell title="Scale down uploaded files"><mt-field v-model="maxRes" label="maximum pixels"></mt-field><mt-switch v-model="doScale"></mt-switch></mt-cell>
            <mt-button v-on:click="modGroups()" size="large">Save Group</mt-button>
            <mt-popup class="addcontact" v-model="showAddContact" position="middle">
              <mt-field :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
              <mt-field :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
              <mt-button v-on:click="cancelContact()">Cancel</mt-button>&nbsp;<mt-button v-on:click="saveContact()" type="primary">Add Contact</mt-button>
            </mt-popup>
            <mt-popup class="addcontact" v-model="showShareGroup" position="middle">
              <mt-cell title="Copy and share this group link:"></mt-cell>
              <mt-field v-model="groupLink"></mt-field>
              <mt-button v-on:click="closeShareGroup()">Close</mt-button>
            </mt-popup>
          </div>`
      }
      const Groups = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            name : '',
            image: ''
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-groups' : showGroups
        },
        created() {
          this.getGroups()
        },
        methods: {
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getGroups() {
            this.spinnerHidden = false
            Vue.http.get( 'getGroups').then( ( response ) => { 
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.abilities.indexOf("modSource Code") > -1) {
                  this.editHidden = false
                }
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rplygroups/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
                for (var i = 0; i < this.items.length; i++) {
                  if ("undefined" !== typeof this.items[i].image) {
                    this.items[i].image = ''
                  }
                }
                if (this.items[this.items.length - 1].name == 'Group 1') {
                  router.push('/modGroups/' + (this.items.length - 1))
                }
              }
              this.spinnerHidden = true
            })
          },
          addGroups(){
            this.spinnerHidden = false
            if (this.name == 'Group 1') {
              MintUI.Toast({
                message: 'Error, choose a different group name',
                iconClass: 'icon icon-error',
                duration: 2000
              })
              return
            }
            Vue.http.post( 'addGroups', {
              recips:JSON.stringify(this.postto),
              name : this.name
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getGroups()
              this.name = ''
              Posts.getContacts()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => { 
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>

            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:editHidden="editHidden" @on-update-list="getGroups" @on-tabs-hidden="hideTabs"  />
                <mt-cell>&nbsp;</mt-cell>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="Groups"></mt-header>
                <mt-field placeholder="Name.." v-model="name"></mt-field>
                <mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
                <file-upload btn-label="Image" @change="stagedUpload('image')" :url="uploadTo + '&field=image'"></file-upload>
                <mt-button v-on:click="addGroups()" size="large">Save</mt-button>
                <mt-cell>&nbsp;</mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            
            <mt-tabbar fixed="true" v-model="selected" v-bind:class="{'is-hidden':tabsHidden}">
              <mt-tab-item id="tab1">
                <img slot="icon" src="/file/home.svg">
                Groups
              </mt-tab-item>
              <mt-tab-item id="tab2">
                <img slot="icon" src="/file/plus-circle.svg">
                Add Group
              </mt-tab-item>
            </mt-tabbar>
          
          </div>`
      }
      const router = new VueRouter({routes:[
        { path: '', component: Posts,
          children: [{
            path: 'showPosts/:idx',
            component: showPosts
        },{
            path: 'modPosts/:idx',
            component: modPosts
        },{
            path: 'myContacts',
            component: listPosts
        },{
            path: '',
            component: listPosts
        }]},{
          path: '/groups', component: Groups,
                    children: [{
                      path: '/showGroups/:idx',
                      component: showGroups
                  },{
                      path: '/modGroups/:idx',
                      component: modGroups
                  },{
                      path: '',
                      component: listGroups
                  }]
        },{
          path: '/contacts', component: Contacts,
                    children: [{
                      path: '/showContacts/:idx',
                      component: showContacts
                  },{
                      path: '/modContacts/:idx',
                      component: modContacts
                  },{
                      path: '',
                      component: listContacts
                  }]
        },{
            path: '/connect/:code',
            component: connect
        },{
            path: '/group/:grp',
            component: GroupPage
        },{
            path: '/auth',
            component: freeTrial
        }
      ]})
      const vueApp = new Vue({
        router
      }).$mount('#app')
    </script>
    
  </body>
  <script type="python" id="server">


@app.route('/delSponsor', methods=['GET','POST'])
def delSponsor():
  result = gateway.subscription.cancel(request.form.get('id'))
  return 'OK'

@app.route('/btSubs', methods=['GET','POST'])
def btSubs():
  subs = []
  if not os.getenv('BT_ID') is None:
    curr = current_user()
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      collection = gateway.customer.search(
        braintree.CustomerSearch.email == curr['email']
      )
      if len(list(collection.items)) > 0:
        customer = list(collection.items)[0]
    if len(list(collection.items)) > 0:
      for sub in customer.credit_cards[0].subscriptions:
        if sub.status == 'Active':
          owner = {'name':''}
          grpn = ''
          grpid = ''.join(x for x in sub.id if x.isdigit())
          items = get_one( 'groups', grpid )
          if len(items) > 0:
            owner = get_user(items[0]['user_id'])
            grpn = items[0]['name']
          subs.append({'name':owner['name'] + '/' + grpn + ' renews ' + str(sub.next_billing_date),'id':str(sub.id)})
  return( json.dumps( [subs] ) )

@app.route('/btSetup', methods=['GET','POST'])
def btSetup():
  subs = []
  tok = ''
  if not os.getenv('BT_ID') is None:
    tok = gateway.client_token.generate()
    return( json.dumps( [tok,subs] ) )
    curr = current_user()
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      collection = gateway.customer.search(
        braintree.CustomerSearch.email == curr['email']
      )
      if len(list(collection.items)) > 0:
        customer = list(collection.items)[0]
    if len(list(collection.items)) > 0:
      for sub in customer.credit_cards[0].subscriptions:
        if sub.status == 'Active':
          subs.append({'name':'bills $3 on ' + str(sub.next_billing_date),'id':str(sub.id)})
  return( json.dumps( [tok,subs] ) )

@app.route('/doSponsor', methods=['GET','POST'])
def doSponsor():
  response = json.loads(request.form.get('method'))
  curr = current_user()
  collection = gateway.customer.search(
    braintree.CustomerSearch.phone == curr['phone']
  )
  if len(list(collection.items)) > 0:
    customer = list(collection.items)[0]
  else:
    collection = gateway.customer.search(
      braintree.CustomerSearch.email == curr['email']
    )
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
  if not len(list(collection.items)) > 0:
    result = gateway.customer.create({
      "first_name": curr['name'],
      "payment_method_nonce": response['nonce'],
      "email": curr['email'],
      "phone": curr['phone']
    })
    if result.is_success:
      customer = result.customer
  if not customer is None:
    result = gateway.subscription.create({
      "payment_method_token": customer.payment_methods[0].token,
      "plan_id": request.form.get('plan_id'),
      "merchant_account_id":'Fleetcoder_instant',
      "id":randomword(6) + request.form.get('group_id')
    })
  if result.is_success:
    if not customer is None:
      notify_sponsor( request.form.get('plan_id'), request.form.get('group_id'), curr['name'] )
    print("success")
  else:
    print(result.errors)
  return 'OK'



@app.route('/doCode', methods=['GET','POST'])
def doCode():
  item = get_one_by( 'connectcodes', request.form.get('code'), 'num' )
  if len(item) > 0:
    for conn in item:
      if conn['code'] == request.form.get('connect'):
        del_one( 'connectcodes', conn['id'] )
        usr = get_one_by( 'contacts', request.form.get('connect'), 'code' )
        if len(usr) > 0 and usr[0]['user_id'] is None:
          u = usr[0]['id']
        else:
          if len(usr) > 0:
            if int(usr[0]['user_id']) > 0:
              exists = get_parent(usr[0]['id'])
              if exists['user_id'] is None:
                u = exists['id']
              else:
                ra = randomword(6)
                u = add_one('contacts',{
                  'name':usr[0]['name'],
                  'email':usr[0]['email'].lower(),
                  'phone':usr[0]['phone'],
                  'groups':json.dumps([2]),
                  'code':ra,
                  'created':str(datetime.now())
                })
                newrec = {
                  'name' : 'Group 1',
                  'user_id' : u,
                  'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
                }
                gr1 = add_one( 'groups', newrec )
                newrec = {
                  'name' : 'Group 2',
                  'user_id' : u,
                  'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
                }
                gr2 = add_one( 'groups', newrec )
                con = mod_one('contacts',{'groups': json.dumps([2,gr1,gr2])},u)
                update_abilities()
                ra = randomword(6)
                copy = get_user(usr[0]['user_id'])
                copy['user_id'] = u
                copy['groups'] = json.dumps([gr1])
                copy['code'] = ra
                del copy['id']
                con = add_one( 'contacts', copy )
        response = make_response(json.dumps( [ 'OK' ] ))
        session.permanent = True
        session['user'] = str(u)
        return response
  return json.dumps( [ 'Error' ] )

@app.route('/doConnect', methods=['GET','POST'])
def doConnect():
  num = randint(100, 999)
  add_one('connectcodes',{
    'num':num,
    'code':request.form.get('code')
  })
  item = get_one_by( 'contacts', request.form.get('code'), 'code' )
  cont = {}
  if 'user' in session:
    if int(session['user']) == int(item[0]['id']):
      return json.dumps( [ 'OK' ] )
    exists = get_parent(item[0]['id'])
    if 'user_id' in exists and exists['user_id'] is None:
      if int(session['user']) == int(exists['id']):
        return json.dumps( [ 'OK' ] )
  cont['phone'] = item[0]['phone']
  cont['email'] = item[0]['email']
  if len(cont['phone']) > 0:
    client = Client(twilio_id, twilio_token)
    rl = "Your code is " + str(num)
    message = client.messages.create(
      body=rl,
      from_='+1' + os.getenv('TWILIO_FROM'),
      to=cont['phone']
    )
    return json.dumps( [ 'phone number' ] )
  if len(cont['email']) > 0:
    em = cont['email']
    message = Mail(
      from_email=' Request at ' + mydomain + ' <' + os.getenv('SENDGRID_FROM') + '>',
      to_emails=em,
      subject='Your ' + mydomain + ' connection code is ' + str(num),
      html_content='<strong>Your code is ' + str(num) + '</strong>')
    sg = SendGridAPIClient(sendgrid_token)
    response = sg.send(message)
    return json.dumps( [ 'email address' ] )
  return json.dumps( [ 'Error' ] )

@app.route('/freeTrial', methods=['GET','POST'])
def freeTrial():
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email")
    cont['name'] = request.form.get("name")
    newuser = ''
    if len(cont['phone']) > 0:
      loginuser = cont['phone']
      usr = get_one_by('contacts',loginuser,'phone')
    if len(cont['email']) > 0:
      loginuser = cont['email']
      usr = get_one_by('contacts',loginuser,'email')
    if len(usr) > 0 and usr[0]['user_id'] is None:
      return json.dumps(['error'])
    num = randint(100, 999)
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email").lower()
    add_one('connectcodes',{
      'num':num,
      'email':cont['email'],
      'phone':cont['phone']
    })
    if len(cont['phone']) > 0:
      client = Client(twilio_id, twilio_token)
      rl = "Your " + mydomain + " code is " + str(num)
      message = client.messages.create(
        body=rl,
        from_='+1' + os.getenv('TWILIO_FROM'),
        to=cont['phone']
      )
    if len(cont['email']) > 0:
      em = cont['email']
      message = Mail(
        from_email=os.getenv('SENDGRID_FROM'),
        to_emails=em,
        subject='Your ' + mydomain + ' connection code is ' + str(num),
        html_content='<strong>Your code is ' + str(num) + '</strong>')
      sg = SendGridAPIClient(sendgrid_token)
      response = sg.send(message)
    return 'OK'

@app.route('/freeTrialLogin', methods=['GET','POST'])
def freeTrialLogin():
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email")
    cont['name'] = request.form.get("name")
    newuser = ''
    if len(cont['phone']) > 0:
      loginuser = cont['phone']
      usr = get_one_by('contacts',loginuser,'phone')
      if len(usr) > 0:
        exists = get_parent(usr[0]['id'])
    if len(cont['email']) > 0:
      loginuser = cont['email']
      usr = get_one_by('contacts',loginuser,'email')
      if len(usr) > 0:
        exists = get_parent(usr[0]['id'])
    if not (len(usr) > 0 and exists['user_id'] is None):
      return json.dumps(['error'])
    num = randint(100, 999)
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email").lower()
    add_one('connectcodes',{
      'num':num,
      'email':cont['email'],
      'phone':cont['phone']
    })
    if len(cont['phone']) > 0:
      client = Client(twilio_id, twilio_token)
      rl = "Your " + mydomain + " code is " + str(num)
      message = client.messages.create(
        body=rl,
        from_='+1' + os.getenv('TWILIO_FROM'),
        to=cont['phone']
      )
    if len(cont['email']) > 0:
      em = cont['email']
      message = Mail(
        from_email=os.getenv('SENDGRID_FROM'),
        to_emails=em,
        subject='Your ' + mydomain + ' connection code is ' + str(num),
        html_content='<strong>Your code is ' + str(num) + '</strong>')
      sg = SendGridAPIClient(sendgrid_token)
      response = sg.send(message)
    return 'OK'

@app.route('/freeTrialStart', methods=['GET','POST'])
def freeTrialStart():
  addgrp = None
  if not request.form.get('grp') is None:
    items = get_one_by( 'groups', request.form.get('grp'), 'key' )
    addgrp = items[0]['id']
  cont = {}
  usr = []
  cont['phone'] = request.form.get("phone")
  cont['email'] = request.form.get("email")
  cont['name'] = request.form.get("name")
  newuser = ''
  if len(cont['phone']) > 0:
    newuser = cont['phone']
    usr = get_one_by('contacts',newuser,'phone')
  if len(cont['email']) > 0:
    newuser = cont['email']
    usr = get_one_by('contacts',newuser,'email')
  os.chdir(appdir)
  tri = get_one_by('connectcodes',request.form.get("code"),'num')
  email = tri[0]['email']
  phone = tri[0]['phone']
  if not (cont['phone'] == phone or cont['email'] == email):
    return '0'
  del_one( 'connectcodes', tri[0]['id'] )
  ra = randomword(6)
  if len(usr) > 0 and usr[0]['user_id'] is None:
    u = usr[0]['id']
  else:
    exists = {}
    if len(usr) > 0:
      exists = get_parent(usr[0]['id'])
    if 'user_id' in exists and exists['user_id'] is None:
      u = exists['id']
    else:
      newgrp = [2]
      u = add_one('contacts',{
        'name':cont['name'],
        'email':cont['email'].lower(),
        'phone':cont['phone'],
        'groups':json.dumps(newgrp),
        'code':ra,
        'created':str(datetime.now())
      })
      newrec = {
        'name' : 'Group 1',
        'user_id' : u,
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      gr1 = add_one( 'groups', newrec )
      newrec = {
        'name' : 'Group 2',
        'user_id' : u,
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      gr2 = add_one( 'groups', newrec )
      con = mod_one('contacts',{'groups': json.dumps(newgrp + [gr1,gr2])},u)
      update_abilities()
  response = make_response(json.dumps( [ 'OK' ] ))
  session.permanent = True
  session['user'] = str(u)
  if not addgrp is None:
    usr = current_user()
    grpdata = get_one('groups',addgrp)
    if 'user_id' in grpdata[0]:
      growner = get_user(grpdata[0]['user_id'])
      share_my_contact(growner,[addgrp])
  return response

@app.route("/isAuthed", methods=['GET'])
def isAuthed():
  os.chdir(appdir)
  if 'user' in session:
    if int(session['user']) > 0:
      return '1'
  return '0'

@app.route("/logout", methods=['POST','GET'])
def logout():
  os.chdir(appdir)
  response = make_response('1')
  session['user'] = '0'
  return response

@app.route('/feed',methods=['GET','POST'])
def feed():
  items = get_one_by( 'settings', 'https://' + mydomain + '/feed?k=' + request.args.get('k'), 'value' )
  if len(items) > 0:
    user = get_user(items[0]['user_id'])
    recs = get_all('posts')
    items = []
    for item in recs:
      if can('get','posts',user,item):
        item['title'] = get_user(item['user_id'])['name'] + ': ' + item['title']
        items.append(item)
    channel = etree.Element('channel')
    etree.SubElement(channel,'title').text = 'Feed'
    etree.SubElement(channel,'link').text = 'https://' + mydomain
    etree.SubElement(channel,'description').text = ''
    for post in items:
      item = etree.Element('item')
      etree.SubElement(item,'title').text = post['title']
      etree.SubElement(item,'pubDate').text = post['created']
      enc = etree.Element('enclosure')
      mtype = mimetypes.MimeTypes().guess_type(post['sound'])[0]
      if not mtype is None:
        if post['sound'][-3:] == 'mp3':
          enc.set('url', 'https://' + mydomain + '/myFile?name=' + post['sound'] + '&field=sound')
          enc.set('length', str(os.path.getsize('myfiles/' + post['sound'])))
          enc.set('type', mtype)
          item.append(enc)
      else:
        enc = etree.Element('enclosure')
        mtype = mimetypes.MimeTypes().guess_type(post['image'])[0]
        if not mtype is None:
          enc.set('url', 'https://' + mydomain + '/myFile?name=' + post['image'] + '&field=image')
          enc.set('length', str(os.path.getsize('myfiles/' + post['image'])))
          enc.set('type', mtype)
          item.append(enc)
      channel.append(item)
    root = etree.Element('rss')
    root.set('version', '2.0')
    root.append(channel)
    return etree.tostring(root, pretty_print=True).decode('utf-8')
  return str(0)

@app.route('/getSettings',methods=['GET','POST'])
def getSettings():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  if not len(items) > 0:
    sett = add_one('settings',{
      'name':'feedLink',
      'value':'https://' + mydomain + '/feed?k=' + randomword(19),
      'user_id':session['user']
    })
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  sett = {}
  for it in items:
    sett[it['name']] = it['value']
  return json.dumps(sett)

@app.route('/getPosts',methods=['GET','POST'])
def getPosts():
  user = current_user()
  recs = get_all('posts')
  posts = []
  cangrps = []
  groups = json.loads(user['groups'])
  ugrps = get_one_by('groups',user['id'],'user_id')
  ugrids = []
  for gr in ugrps:
    ugrids.append(gr['id'])
  for item in recs:
    if can('get','posts',user,item):
      item['title'] = get_user(item['user_id'])['name'] + ': ' + item['title']
      item['imageHidden'] = False
      item['textHidden'] = True
      if item['image'] == '':
        item['imageHidden'] = True
      item['soundHidden'] = False
      if item['sound'] == '':
        item['soundHidden'] = True
      if item['image'] == '' and item['sound'] == '':
        item['textHidden'] = False
      posts.append(item)
      pgrps = json.loads(item['groups'])
      for pgrp in pgrps:
        if not pgrp in cangrps and not pgrp in ugrids and pgrp in groups:
          cangrps.append(pgrp)
    if expired(item):
      notify_del(item['user_id'])
      img = appdir + 'myfiles/' + item['image']
      if os.path.exists(img) and not item['image'] == '':
        os.remove(img)
      mus = appdir + 'myfiles/' + item['sound']
      if os.path.exists(mus) and not item['sound'] == '':
        os.remove(mus)
      del_one( 'posts', item['id'] )
  contacts = get_all('contacts')
  for cgrp in cangrps:
    newrec = {
      'title' : 'this is an example <a href="/">link</a>',
      'image' : '',
      'sound' : '',
      'groups' : '',
      'user_id' : '',
      'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) ),
      'imageHidden' : True,
      'soundHidden' : True,
      'textHidden' : False
    }
    #posts.append(newrec)
  abils = []
  grps = []
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    if len(group) > 0:
      groupname = group[0]['name']
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] is None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not grp == 2:
          glabel = glabel + comma + con['name']
          comma = ', '
    if not glabel == '':
      grps.append({'value':grp,'label':groupname + ': ' + glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  feeds = []
  if 'user' in session:
    settings = get_one_by( 'settings', session['user'], 'user_id' )
    if len(settings) > 1:
      for it in settings:
        if it['name'] == 'feedSubs':
          feeds = json.loads(it['value'])
  for fd in feeds:
    feed = feedparser.parse(fd)
    items = []
    for item in feed.entries:
      item['imageHidden'] = True
      item['textHidden'] = False
      item['soundHidden'] = True
      if 'enclosures' in item:
        if len(item['enclosures']) > 0:
          if 'href' in item['enclosures'][0]:
            if 'type' in item['enclosures'][0]:
              item['media'] = item['enclosures'][0]['href']
              item['mediatype'] = item['enclosures'][0]['type']
              if 'mp3' in item['enclosures'][0]['href']:
                item['soundHidden'] = False
              else:
                item['imageHidden'] = False
      if not 'title' in item:
        h2t.ignore_links = True
        if 'description' in item:
          item['title'] = h2t.handle(str(item['description']))[:100]
        else:
          if 'content' in item:
            item['title'] = h2t.handle(str(item['content']))[:100]
          else:
            continue
      items.append(item)
    posts = posts + items
  #posts.sort(key=lambda p: p['published'], reverse=True)
  return( json.dumps( [posts,grps,abils,user['code'],cangrps] ) )

@app.route('/dropFeed',methods=['GET','POST'])
def dropFeed():
  if not 'user' in session:
    return json.dumps([])
  feeds = []
  items = get_one_by( 'settings', session['user'], 'user_id' )
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
      for idx, fe in enumerate(feeds):
        if int(request.form.get('feed')) == idx:
          feeds.remove(fe)
          mod_one('settings',{'value':json.dumps(feeds)},sid)
  return json.dumps(feeds)

@app.route('/addFeeds',methods=['GET','POST'])
def addFeeds():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  if not len(items) > 1:
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  feeds = []
  sid = 0
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
      feeds.append(request.form.get('feed'))
      mod_one('settings',{'value':json.dumps(feeds)},sid)
  return json.dumps(feeds)

@app.route('/addPosts',methods=['GET','POST'])
def addPosts():
  maxRes = 0
  saveImage = [saveFile( 'image' )]
  senditems = []
  imageupl = saveFile('imagemulti')
  title = request.form.get('title')
  if len(imageupl) > 0:
    saveImage = json.loads(imageupl)
  if not can('add','posts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  for savedImage in saveImage:
    newrec = {
      'title' : title,
      'image' : savedImage,
      'sound' : saveFile( 'sound' ),
      'groups' : request.form.get('recips'),
      'user_id' : session['user'],
      'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
    }
    if (int(request.form.get('expirehours')) > 0):
      now_plus_hours = datetime.now() + timedelta(hours=int(request.form.get('expirehours')))
      newrec['expires'] = str( timezone( 'US/Pacific' ).localize( now_plus_hours ) )
    rid = add_one( 'posts', newrec )
    if rid > 0:
      dt = timezone( 'US/Pacific' ).localize( datetime.now() )
      newrec['id'] = rid
      newrec['title'] = current_user()['name'] + ': ' + newrec['title']
      contacts = get_all('contacts')
      recips = []
      for con in contacts:
        if can('get','posts',con,newrec):
          grp = [value for value in json.loads(request.form.get('recips')) if value in json.loads(con['groups'])][0]
          grpdata = get_one('groups',grp)
          if 'maxres' in grpdata[0]:
            if not grpdata[0]['maxres'] is None:
              maxRes = int(grpdata[0]['maxres'])
          if not 'last_notif' in grpdata[0] or grpdata[0]['last_notif'] == None:
            rid = add_one( 'groups', {'last_notif':''} )
            if rid > 0:
              del_one('groups',rid)
          if not 'key' in grpdata[0] or grpdata[0]['key'] == None:
            newobj = { 'key' : randomword(8) }
            mod_one( 'groups', newobj, grpdata[0]['id'] )
            grpdata[0]['key'] = newobj['key']
          if not 'last_notif' in grpdata[0] or grpdata[0]['last_notif'] == None:
            newobj = { 'last_notif' : str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) ) }
            mod_one( 'groups', newobj, grpdata[0]['id'] )
            grpdata[0]['last_notif'] = newobj['last_notif']
          from dateutil import tz
          tzinfos = {"-08:00": tz.gettz('US/Pacific')}
          dt = parser.parse(grpdata[0]['last_notif'], tzinfos=tzinfos) + timedelta(hours=24)
          if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
            notify_photo( con['id'], grpdata[0]['key'] )
          recips.append( con['id'] )
      if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
        newobj = { 'last_notif' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) ) }
        mod_one( 'groups', newobj, grpdata[0]['id'] )
      item = newrec
      item['title'] = current_user()['name'] + ': ' + item['title']
      item['imageHidden'] = False
      item['textHidden'] = True
      if item['image'] == '':
        item['imageHidden'] = True
      item['soundHidden'] = False
      if item['sound'] == '':
        item['soundHidden'] = True
      if item['image'] == '' and item['sound'] == '':
        item['textHidden'] = False
      senditems.append(item)
      clearSession('sound')
      title = ''
  clearSession('image')
  clearSession('imagemulti')
  if maxRes > 0:
    for savedImage in saveImage:
      filepath = appdir + 'myfiles/' + savedImage
      if filepath[-3:].lower() == 'jpg' or filepath[-3:].lower() == 'jpeg':
        try:
          image=Image.open(filepath)
          original_size = max(image.size[0], image.size[1])
          if original_size >= maxRes:
            resized_file = open(filepath.split('.')[0] + '_resized.jpg', "w")
            if (image.size[0] > image.size[1]):
              resized_width = maxRes
              resized_height = int(round((maxRes/float(image.size[0]))*image.size[1])) 
            else:
              resized_height = maxRes
              resized_width = int(round((maxRes/float(image.size[1]))*image.size[0]))
            image = image.resize((resized_width, resized_height), Image.ANTIALIAS)
            image.save(resized_file, 'JPEG')
          image.save(filepath)
          image.close()
        except (AttributeError, KeyError, IndexError):
          pass
  response = make_response(json.dumps( [ 'OK' ] ))
  for item in senditems:
    sendcomet(recips,item)
  return response

@app.route('/modPosts',methods=['GET','POST'])
def modPosts():
  item = get_one( 'posts', request.form.get('id') )[0]
  if not can('mod','posts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newobj = {
    'title' : request.form.get('title'),
    'image' : saveFile( 'image' ),
    'sound' : saveFile( 'sound' )
  }
  if newobj['image'] == '':
    del newobj['image']
  if newobj['sound'] == '':
    del newobj['sound']
  if mod_one( 'posts', newobj, request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/delPosts',methods=['GET','POST'])
def delPosts():
  item = get_one( 'posts', request.form.get('id') )[0]
  if not can('del','posts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'posts', request.form.get('id') ):
    img = appdir + 'myfiles/' + item['image']
    if os.path.exists(img) and not item['image'] == '':
      os.remove(img)
    mus = appdir + 'myfiles/' + item['sound']
    if os.path.exists(mus) and not item['sound'] == '':
      os.remove(mus)
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/getGroups',methods=['GET','POST'])
def getGroups():
  user = current_user()
  recs = get_all('groups')
  items = []
  for item in recs:
    if can('get','groups',user,item):
      items.append(item)
  contacts = get_all('contacts')
  groups = json.loads(user['groups'])
  abils = []
  grps = []
  for grp in groups:
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] == None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not con['name'] == 'Me':
          glabel = glabel + comma + con['name']
          comma = ', '
      if not glabel == '':
        grps.append({'value':grp,'label':glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  return( json.dumps( [items,grps,abils,user['code']] ) )

@app.route('/joinGroup',methods=['GET','POST'])
def joinGroup():
  os.chdir(appdir)
  authd = ''
  if 'user' in session:
    if int(session['user']) > 0:
      authd = 'AUTHED'
  items = get_one_by( 'groups', request.form.get('grp'), 'key' )
  if not len(items) > 0:
    items = get_one( 'groups', request.form.get('grp') )
  result = []
  if len(items) > 0:
    owner = get_user(items[0]['user_id'])
    imgsrc = ''
    if not items[0]['image'] is None:
      imgsrc = 'https://' + mydomain + '/grpFile?field=image&name=' + items[0]['image']
    result = [owner['name'],items[0]['name'],imgsrc,authd,items[0]['id']]
  return json.dumps(result)

@app.route('/addGroups',methods=['GET','POST'])
def addGroups():
  if not can('add','groups',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  newrec = {
    'name' : request.form.get('name'),
    'groups' : request.form.get('recips'),
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'groups', newrec )
  grps = json.loads(get_user(current_user()['id'])['groups'])
  grps.append(rid)
  mod_one('contacts',{'groups': json.dumps(grps)},current_user()['id'])
  if rid > 0:
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modGroups',methods=['GET','POST'])
def modGroups():
  item = get_one( 'groups', request.form.get('id') )[0]
  if not can('mod','groups',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if not 'image' in item or not 'key' or not 'maxres' in item:
    rid = add_one( 'groups', {'image':'','key':'','maxres':'2000'} )
    if rid > 0:
      del_one('groups',rid)
  scale = '0'
  if (int(request.form.get('maxres')) > 0):
    scale = request.form.get('maxres')
  newobj = {
    'name' : request.form.get('name'),
    'image' : saveFile( 'image' ),
    'maxres' : scale
  }
  if newobj['image'] == '':
    del newobj['image']
  if not 'key' in item or item['key'] == None:
    newobj['key'] = randomword(8)
    item['key'] = newobj['key']
  if mod_one( 'groups', newobj, request.form.get('id') ):
    return( 'https://' + mydomain + '/grp/' + item['key'] )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/delGroups',methods=['GET','POST'])
def delGroups():
  item = get_one( 'groups', request.form.get('id') )[0]
  if not can('del','groups',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'groups', request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/getContacts',methods=['GET','POST'])
def getContacts():
  user = current_user()
  recs = get_all('contacts')
  items = []
  for item in recs:
    if can('get','contacts',user,item):
      if not item['name'] == None and not item['user_id'] == None:
        items.append(item)
  contacts = get_all('contacts')
  groups = json.loads(user['groups'])
  abils = []
  grps = []
  for grp in groups:
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] == None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not con['name'] == 'Me':
          glabel = glabel + comma + con['name']
          comma = ', '
      if not glabel == '':
        grps.append({'value':grp,'label':glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  return( json.dumps( [items,grps,abils,user['code']] ) )

@app.route('/addContacts',methods=['GET','POST'])
def addContacts():
  if not can('add','contacts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : request.form.get('recips'),
    'code':ra,
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    share_my_contact(newrec,[])
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/quickAddContacts',methods=['GET','POST'])
def quickAddContacts():
  if not can('add','contacts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  user = current_user()
  groups = json.loads(user['groups'])
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : json.dumps([groups[1]]),
    'code':ra,
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    share_my_contact(newrec,[])
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/doJoin',methods=['GET','POST'])
def doJoin():
  if request.form.get("phone") == '' and request.form.get("email") == '':
    grpdata = get_one_by( 'groups', request.form.get('grp'), 'key' )
    if 'user_id' in grpdata[0]:
      addgrp = grpdata[0]['id']
      growner = get_user(grpdata[0]['user_id'])
      share_my_contact(growner,[addgrp])
    return 'OK'
  items = get_one_by( 'groups', request.form.get('grp'), 'key' )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  cont = {}
  cont['phone'] = newph
  cont['email'] = request.form.get("email")
  cont['name'] = request.form.get("name")
  newuser = ''
  if len(cont['phone']) > 0:
    loginuser = cont['phone']
    usr = get_one_by('contacts',loginuser,'phone')
  if len(cont['email']) > 0:
    loginuser = cont['email']
    usr = get_one_by('contacts',loginuser,'email')
  num = randint(100, 999)
  cont = {}
  cont['phone'] = request.form.get("phone")
  cont['email'] = request.form.get("email").lower()
  add_one('connectcodes',{
    'num':num,
    'email':cont['email'],
    'phone':cont['phone']
  })
  if len(cont['phone']) > 0:
    client = Client(twilio_id, twilio_token)
    rl = "Your " + mydomain + " code is " + str(num)
    message = client.messages.create(
      body=rl,
      from_='+1' + os.getenv('TWILIO_FROM'),
      to=cont['phone']
    )
  if len(cont['email']) > 0:
    em = cont['email']
    message = Mail(
      from_email=os.getenv('SENDGRID_FROM'),
      to_emails=em,
      subject='Your ' + mydomain + ' connection code is ' + str(num),
      html_content='<strong>Your code is ' + str(num) + '</strong>')
    sg = SendGridAPIClient(sendgrid_token)
    response = sg.send(message)
  return 'OK'
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : json.dumps([items[0]['id']]),
    'code':ra,
    'user_id' : items[0]['user_id'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modContacts',methods=['GET','POST'])
def modContacts():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('mod','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  newobj = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph
  }
  if mod_one( 'contacts', newobj, request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modContactGroups',methods=['GET','POST'])
def modContactGroups():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('mod','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newobj = {
    'groups' : request.form.get('groups')
  }
  mod_one( 'contacts', newobj, request.form.get('id') )
  contacts = get_all('contacts')
  user = current_user()
  groups = json.loads(user['groups'])
  grps = []
  for grp in groups:
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] is None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not grp == 2:
          glabel = glabel + comma + con['name']
          comma = ', '
    if not glabel == '':
      grps.append({'value':grp,'label':glabel})
  update_abilities()
  return( json.dumps( [ grps ] ) )

@app.route('/delContacts',methods=['GET','POST'])
def delContacts():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('del','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'contacts', request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/uploadFile',methods=['GET','POST'])
def uploadFile():
  filedata = {}
  if not os.path.exists(appdir + 'myfiles'):
    os.makedirs(appdir + 'myfiles')
  if request.method == 'POST':
    if (sys.getsizeof(request.get_data()) > 5000):
      fi = tempfile.NamedTemporaryFile(delete=False)
      f = open(fi.name, 'w+b')
      f.write(request.get_data())
      f.close()
      filedata['tmp_name'] = fi.name
      filedata['name'] = time.strftime("%d_%m_%Y_%H_%M_%S_") + '.mp3'
    if 'file' in request.files:
      file = request.files['file']
      if not file.filename == '':
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
  if 'name' in filedata:
    fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
    filepath = appdir + 'myfiles/' + fname
    copyfile(filedata['tmp_name'], filepath)
    if not (filepath[-3:] == 'mp3'):
      try:
        image=Image.open(filepath)
        for orientation in ExifTags.TAGS.keys():
          if ExifTags.TAGS[orientation]=='Orientation':
            break
        exif=dict(image._getexif().items())
        if exif[orientation] == 3:
          image=image.rotate(180, expand=True)
        elif exif[orientation] == 6:
          image=image.rotate(270, expand=True)
        elif exif[orientation] == 8:
          image=image.rotate(90, expand=True)
        image.save(filepath)
        image.close()
      except (AttributeError, KeyError, IndexError):
        # cases: image don't have getexif
        pass
    response = make_response(json.dumps( [ 'OK' ] ))
    setSession(request.args.get('field'),fname)
    return response
  return 'OK'

@app.route('/uploadMulti',methods=['GET','POST'])
def uploadMulti():
  filedata = {}
  filenames = []
  uploaded = []
  if not os.path.exists(appdir + 'myfiles'):
    os.makedirs(appdir + 'myfiles')
  if request.method == 'POST':
    if not request.files.getlist('photos') is None:
      files = request.files.getlist('photos')
      for file in files:
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
          if 'name' in filedata:
            fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
            filepath = appdir + 'myfiles/' + fname
            filenames.append(fname)
            copyfile(filedata['tmp_name'], filepath)
            uploaded.append({'url':fname,'originalName':filedata['name']})
            if not (filepath[-3:] == 'mp3'):
              try:
                image=Image.open(filepath)
                for orientation in ExifTags.TAGS.keys():
                  if ExifTags.TAGS[orientation]=='Orientation':
                    break
                exif=dict(image._getexif().items())
                if exif[orientation] == 3:
                  image=image.rotate(180, expand=True)
                elif exif[orientation] == 6:
                  image=image.rotate(270, expand=True)
                elif exif[orientation] == 8:
                  image=image.rotate(90, expand=True)
                image.save(filepath)
                image.close()
              except (AttributeError, KeyError, IndexError):
                # cases: image don't have getexif
                pass
    response = make_response(json.dumps( [ uploaded ] ))
    setSession('imagemulti',json.dumps(filenames))
    return response
  return 'OK'

@app.route('/stagedFile',methods=['GET','POST'])
def stagedFile():
  return(saveFile(request.args.get('field')))

@app.route('/grpFile',methods=['GET','POST'])
def grpFile():
  thefile = False
  item = get_one_by( 'groups', request.args.get('name'), request.args.get('field') )
  if len(item) > 0:
    thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
    ftype = 'image/jpeg'
    print(thefile,file=sys.stderr)
    return send_file( thefile, mimetype=ftype)
  else:
    return 'Error'

@app.route('/myFile',methods=['GET','POST'])
def myFile():
  thefile = False
  if not request.args.get('staged') is None:
    if not request.args.get('multiname') is None:
      thefile = appdir + 'myfiles/' + request.args.get('multiname')
    else:
      thefile = appdir + 'myfiles/' + saveFile(request.args.get('field'))
  else:
    item = get_one_by( 'posts', request.args.get('name'), request.args.get('field') )
    if len(item) > 0:
      thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
  ftype = 'image/jpeg'
  if thefile and not os.path.isdir(thefile):
    if (thefile[-3:] == 'mp3'):
      ftype = 'audio/mp3'
    print(thefile,file=sys.stderr)
    return send_file( thefile, mimetype=ftype)
  return 'Error'

abilities = [
  {
    'group_id':2,
    'resource':'posts',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'posts',
    'actions':['get'],
    'conditions':[['groups','groups']]
  },
  {
    'group_id':2,
    'resource':'posts',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['get'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['get'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  }
]

  </script>
</html>

