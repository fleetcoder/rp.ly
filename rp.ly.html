<!DOCTYPE html>
<html>
  <head><meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="imagetoolbar" content="no" />

    <title>OurTown</title>

    <link href=/file/app.5c06658fe9ebd0487f37.css rel=stylesheet>
    <script type=text/javascript src=/file/manifest.2ae2e69a05c33dfc65f8.js></script>
    <script type=text/javascript src=/file/vendor.0eb5480a7e9a156e90f2.js></script>
    <script type=text/javascript src=/file/app.2f6ec15c9d909529fbee.js></script>
    <!-- <script type=text/javascript src=/file/socket.io.js></script> -->
    <script type=text/javascript src=/file/moment.js></script>
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/file/rply57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/file/rply72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/file/rply114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/file/rply144.png" />
  </head>
  <body>

    <div id="app"><router-view class="view"></router-view></div>

    <!-- pallette: 222831 393e46 32e0c4 ffd3e1 -->
    <style id="style">
      @font-face {
        font-family: 'Lato';
        src: URL('file/Lato-Regular.ttf') format('truetype');
      }
      body {
        margin: 0px;
        font-family: 'Lato', sans-serif;
      }
      .centercopy {
        font-family: 'Lato', sans-serif;
      }
      p, a, h1, h2, h3, h4, span, div, label {
        font-family: 'Lato', sans-serif;
      }
      .centerbox {
        font-family: 'Lato', sans-serif;
      }
      .imagecell > div:nth-child(2) > div:nth-child(2) {
        display: block;
        text-align: left;
      }
      div.mint-cell-wrapper {
        padding: 0px;
      }
      div.mint-cell-wrapper > div.mint-cell-value > input {
        background-color: #eee;
      }
      .comment {
        -webkit-filter: invert(.75);
                filter: invert(.75);
      }
      .headericon {
        -webkit-filter: invert(.75);
                filter: invert(.75);
      }
      .startbuttons {
        margin: 15px;
      }
      .mint-header {
        background-color: #222831;
      }
      #app {
        margin:0;
      }
      .mint-button--primary {
        background-color: #222831;
      }
      .mint-button--normal {
        background-color: #32e0c4;
      }
      .mint-button--default {
        background-color: #32e0c4;
      }
      .is-hidden {
        display: none;
      }
      .is-flagged {
        color: red;
      }
      .is-linked {
        text-decoration: underline;
      }
      .file-upload .input-wrapper {
        background-color: gray;
        padding-bottom:80px;
      }
      .img {
        width:100%;
        height:auto;
      }
      .contact {
        list-style:none;
        text-align:right;
        margin-top:30px;
      }
      .contacts {
        margin-top:15px;
      }
      .addcontact {
        padding: 10px;
        width: 85%;
      }
      .fieldlist div.mint-cell-wrapper > div.mint-cell-value > input {
        background-color: #fff;
      }
      .caption {
        margin-left: 20px;
      }
      .cant-click{
        pointer-events: none;
      }
      .oimg {
          position:relative;
          width:100%;
          height:auto;
          overflow:hidden;
      }
      .outer {
          position:relative;
          width:100%;
          height:auto;
          overflow:hidden;
      }
      .overlay {
          display: none;
      }
      .text {
          position: absolute;
          top: 50%;
          left: 50%;
          transform:translate(-50%, -50%);
          color:white;
      }
      .imagecell {
        position:relative;
        overflow:hidden;
        padding:0;
        margin:0;
      }
      .options {
        padding-right:20px;
      }
      .vidframe {
        margin:30px;
      }
      .groupimg {
        height:auto;
        padding:30px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-top:30px;
        width: 50%;
        -webkit-filter: drop-shadow(5px 5px 5px #222);
        filter: drop-shadow(5px 5px 5px #222);
      }
      .hosted-field {
        height: 50px;
        box-sizing: border-box;
        width: 100%;
        padding: 12px;
        display: inline-block;
        box-shadow: none;
        font-weight: 500;
        font-size: 14px;
        border-radius: $radius-default;
        border: 1px solid #dddddd;
        line-height: 20px;
        background: #fcfcfc;
        margin-bottom: 12px;
        background: linear-gradient(to right, white 50%, #fcfcfc 50%);
        background-size: 200% 100%;
        background-position: right bottom;
        transition: all 300ms ease-in-out;
      }
      .hosted-fields--label {
        font-family: courier, monospace;
        text-transform: uppercase;
        font-size: 14px;
        display: block;
        margin-bottom: 6px;
      }
      .button-container {
        display: block;
        text-align: center;
      }
      .braintree-hosted-fields-focused {
        border: 1px solid #64d18a;
        border-radius: $radius-default;
        background-position: left bottom;
      }
      .braintree-hosted-fields-invalid {
        border: 1px solid #ed574a;
      }
      .braintree-hosted-fields-valid {
      }
      #cardForm {
        max-width: 50.75em;
        margin: 0 auto;
        padding: 1.875em;
      }
      .dropbox {
        outline: 0;
        outline-offset: -10px;
        background: #ffd3e1;
        color: dimgray;
        padding: 10px 10px;
        position: relative;
        cursor: pointer;
        margin-top: 10px;
      }
      @media only screen and (min-width: 1025px) {
        .dropbox {
          width:1025px;
        }
      }
      .input-file {
        opacity: 0;
        width: 100%;
        position: absolute;
        cursor: pointer;
      }
      .input-headerphoto {
        background-color:blue;
        cursor: pointer;
      }
      .dropbox:hover {
        background: #AEA;
      }
      .img-thumbnail {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        width: 150px;
      }
      .list-unstyled {
        list-style:none;
        margin-right: 40px;
      }
      .uploadlabel {
        font-size: 1.4em;
      }
      #savepostbutton {
        margin-top: 10px;
        margin-bottom: 50px;
      }
      .bottom-button {
        position: fixed;
        bottom: 0;
        height: 75px;
        left: 0;
      }
      .buttonset {
        margin-top: 10px;
      }
      .help_header {
        margin:10px;
      }
      .help_para {
        margin:10px;
        text-align:left;
      }
      .help_popup {
        height:90%;
        width:90%;
        overflow-y: scroll;
      }
      .gettingstarted {
        margin:20px;
        text-align:left;
      }
      .templtext {
        background-color:#ccc;
      }
      .notifswitch {
        margin-right:15px;
      }
      .freqrange {
        margin-top:14px;
        margin-left:10px;
        margin-right:10px;
        margin-bottom:4px;
      }
      .fixedheader {
      }
      @media only screen and (min-width: 1025px) {
        body {
          width: 1025px;
          margin: 0px auto;
        }
        .fixedheader {
          width: 1025px;
          margin: 0px auto;
        }
        .mint-tabbar {
          width: 1025px;
          margin: 0px auto;
        }
      }
      .joinnotif {
        margin-bottom:20px;
      }
      .joinbutton {
        margin-bottom:100px;
      }
      .joinswitches {
        padding-bottom:14px;
      }
      .underpic {
        margin-top:10px;
      }
      .loginlink {
        margin:30px
      }
      .grimg {
        position:relative;
        max-width:40px;
        max-height:40px;
        width:40px;
        height:40px;
        overflow:hidden;
        margin:20px;
      }
      .feedwrap {
        padding-bottom:100px;
      }
      .public_bio {
        margin:10px;
      }
      .public_img {
        margin-top:15px;
      }
      .addphotostab {
        padding-bottom: 50px;
      }
      .choosegroups {
        padding-top: 10px;
      }
      .secondtool {
        padding-right:15px;
      }
      .starttabscontent {
        padding-bottom:50px;
      }
      .firstHelp {
        text-align:left;
      }
      .startVid {
        width: 300px;
        height: auto;
        text-align: center;
      }
      .mailto {
        text-align: center;
      }
      .intro {
        max-width: 250px;
        max-height: 250px;
        height: auto;
      }
      .intro_tall {
        max-width: 250px;
        max-height: 450px;
        height: auto;
      }
      .introright {
      }
      .introleft {
      }
      .introblock {
        margin-bottom:50px;
      }
      .introcopy {
      }
      .signupbox {
      }
      .rplycopy {
        margin: 20px;
      }
      .codeinput {
        margin-right: 10px;
      }
      .vidcaption {
        margin-top:10px;
      }
      .leftfloat {
      }
      .sub_upload {
        margin-top:10px;
      }
      .uplimg {
        margin-top:20px;
        margin-left:40px;
        margin-right:40px;
        margin-bottom:10px;
      }
      a.imagecell > div:nth-child(3) > div:nth-child(2) > p:nth-child(1){
        
      }
      .feedimages {
        width:140px;
        overflow:hidden;
      }
      .article_img {
        width:140px;
        margin-top:0px;
        margin-left:0px;
      }
      .article_hed {
        margin-top:0px;
        margin-left:10px;
        float: right;
        font-size: 18px;
        width: 190px;
        cursor: pointer;
        text-align:left;
      }
      @media only screen and (min-width: 1025px) {
        .feedimages {
          width:280px;
          overflow:hidden;
        }
        .article_img {
          width:280px;
        }
        .article_hed {
          width: 350px;
        }
      }
      .article_mainhed {
        text-align:left;
        font-size: 24px;
        float: left;
        cursor: pointer;
        margin:10px;
      }
      .article_mainhed img {
        display: block;
        text-align: center;
        margin-top:0px;
        margin-left:0px;
        margin-bottom:15px;
        max-height:280px;
        max-width:280px;
        height:auto;
        width:auto;
      }
      .groups_following {
        text-align:left;
        margin-left:30px;
      }
      .addphotostab > a:nth-child(3) > div:nth-child(2) > div:nth-child(1) {
        width: 0px;
      }
      .addphotostab > a:nth-child(3) > div:nth-child(2) > div:nth-child(2) {
        text-align: center;
        width: 100%;
      }
      .addphotostab > a:nth-child(3) > div:nth-child(2) > div:nth-child(2) > div:nth-child(1) {
        width: 100%;
      }
      #issaving {
        margin-left: 40px;
      }
      .addphotostab > a:nth-child(3) > div:nth-child(2) > div:nth-child(2) > form:nth-child(1) {
        width: 100%;
      }
      .feedsinput {
        text-decoration:underline;
      }
      .readstory {
        margin-top: 5px;
        margin-right: 15px;
        margin-bottom: 30px;
      }
      .grouptabs {
        margin-top:20px;
      }
      .readertop {
        padding-top:60px;
      }
      .readerimg {
        max-height:100px;
        max-width:100px;
        height:auto;
        width:auto;
      }
      .readerhed {
        margin-left:25px;
        font-size: 14px;
        float:left;
      }
      .topmenu {
        top:192px;
        width:100%;
        margin-top:0;
        padding-top:0;
      }
      .datepicker {
        margin-top: 20px;
        margin-bottom: 10px;
      }
      *, *:before, *:after {
      -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;
      }

      #calendar {
        -webkit-transform: translate3d(0, 0, 0);
        -moz-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
        width: 100%;
        margin: 10px auto;
      /*   min-height: 570px; */
        height: auto;
        overflow: hidden;
        box-shadow: 0 12px 28px 0 rgba(0, 0, 0, 0.2),0 2px 4px 0 rgba(0, 0, 0, 0.1),inset 0 0 0 1px rgba(255, 255, 255, 0.5);
      }

      .header {
        height: 50px;
        width: 100%;
        background: rgba(255, 255, 255, 1);
        text-align: center;
        position:relative;
        z-index: 100;
      }

      .header h1 {
        margin: 0;
        padding: 0;
        font-size: 20px;
        line-height: 50px;
        font-weight: 100;
        letter-spacing: 1px;
        cursor: pointer;
      }

      .left, .right {
        position: absolute;
        width: 0px;
        height: 0px;
        border-style: solid;
        top: 50%;
        margin-top: -7.5px;
        cursor: pointer;
      }

      .left {
        border-width: 7.5px 10px 7.5px 0;
        border-color: transparent rgba(160, 159, 160, 1) transparent transparent;
        left: 20px;
      }

      .right {
        border-width: 7.5px 0 7.5px 10px;
        border-color: transparent transparent transparent rgba(160, 159, 160, 1);
        right: 20px;
      }

      .left:hover {
         border-color: transparent rgba(0, 0, 0, 1) transparent transparent;
      }

      .right:hover {
        border-color: transparent transparent transparent rgba(0, 0, 0, 1);
      }

      .month {
        /*overflow: hidden;*/
        opacity: 0;
      }

      .month.new {
        animation: fadeIn 1s ease-out;
        opacity: 1;
      }

      .month.in.next {
        -webkit-animation: moveFromTopFadeMonth .4s ease-out;
        -moz-animation: moveFromTopFadeMonth .4s ease-out;
        animation: moveFromTopFadeMonth .4s ease-out;
        opacity: 1;
      }

      .month.out.next {
        -webkit-animation: moveToTopFadeMonth .4s ease-in;
        -moz-animation: moveToTopFadeMonth .4s ease-in;
        animation: moveToTopFadeMonth .4s ease-in;
        opacity: 1;
      }

      .month.in.prev {
        -webkit-animation: moveFromBottomFadeMonth .4s ease-out;
        -moz-animation: moveFromBottomFadeMonth .4s ease-out;
        animation: moveFromBottomFadeMonth .4s ease-out;
        opacity: 1;
      }

      .month.out.prev {
        -webkit-animation: moveToBottomFadeMonth .4s ease-in;
        -moz-animation: moveToBottomFadeMonth .4s ease-in;
        animation: moveToBottomFadeMonth .4s ease-in;
        opacity: 1;
      }

      .week {
       background: rgba(255, 255, 255, 1);
      }

      .day {
        display: inline-block;
        width: 50px;
        padding: 10px;
        text-align: center;
        vertical-align: top;
        cursor: pointer;
        background: rgba(255, 255, 255, 1);
        position: relative;
        z-index: 100;
      }

      .day.other {
       color: rgba(0, 0, 0, .3);
      }

      .day.today {
        color: rgba(156, 202, 235, 1);
      }

      .day-name {
        font-size: 9px;
        text-transform: uppercase;
        margin-bottom: 5px;
        color: rgba(0, 0, 0, 1);
        letter-spacing: .7px;
      }

      .day-number {
        font-size: 24px;
        letter-spacing: 1.5px;
      }


      .day .day-events {
        list-style: none;
        margin-top: 3px;
        text-align: center;
        height: 12px;
        line-height: 6px;
        overflow: hidden;
      }

      .day .day-events span {
        vertical-align: top;
        display: inline-block;
        padding: 0;
        margin: 0;
        width: 5px;
        height: 5px;
        line-height: 5px;
        margin: 0 1px;
      }

      .blue { background: rgba(156, 202, 235, 1); }
      .orange { background: rgba(247, 167, 0, 1); }
      .green { background: rgba(153, 198, 109, 1); }
      .yellow { background: rgba(249, 233, 0, 1); }

      .details {
        position: relative;
        width: 100%;
        background: rgba(164, 164, 164, 1);
        background: #fbfbfb;
        margin-top: 5px;
        border-radius: 4px;
      }

      .details.in {
        -webkit-animation: moveFromTopFade .5s ease both;
        -moz-animation: moveFromTopFade .5s ease both;
        animation: moveFromTopFade .5s ease both;
      }

      .details.out {
        -webkit-animation: moveToTopFade .5s ease both;
        -moz-animation: moveToTopFade .5s ease both;
        animation: moveToTopFade .5s ease both;
      }

      .arrow {
        position: absolute;
        top: -5px;
        left: 50%;
        margin-left: -2px;
        width: 0px;
        height: 0px;
        border-style: solid;
        border-width: 0 5px 5px 5px;
        border-color: transparent transparent rgba(164, 164, 164, 1) transparent;
        transition: all 0.7s ease;
      }

      .events {
        padding: 7px 0;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .events.in {
        -webkit-animation: fadeIn .3s ease both;
        -moz-animation: fadeIn .3s ease both;
        animation: fadeIn .3s ease both;
      }

      .events.in {
        -webkit-animation-delay: .3s;
        -moz-animation-delay: .3s;
        animation-delay: .3s;
      }

      .details.out .events {
        -webkit-animation: fadeOutShrink .4s ease both;
        -moz-animation: fadeOutShink .4s ease both;
        animation: fadeOutShink .4s ease both;
      }

      .events.out {
        -webkit-animation: fadeOut .3s ease both;
        -moz-animation: fadeOut .3s ease both;
        animation: fadeOut .3s ease both;
      }

      .event {
        font-size: 16px;
        letter-spacing: .5px;
        padding: 2px 16px;
        vertical-align: top;
      }

      .event.empty {
        color: #eee;
      }

      .event-category {
        height: 10px;
        width: 10px;
        display: inline-block;
        margin: 6px 0 0;
        vertical-align: top;
      }

      .event span {
        display: inline-block;
        padding: 0 0 0 7px;
      }

      .legend {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 30px;
        background: rgba(255, 255, 255, 1);
        line-height: 30px;
        color:#000;

      }

      .entry {
        position: relative;
        padding: 0 0 0 25px;
        font-size: 13px;
        display: inline-block;
        line-height: 30px;
        background: transparent;
      }

      .entry:after {
        position: absolute;
        content: '';
        height: 5px;
        width: 5px;
        top: 12px;
        left: 14px;
      }

      .entry.blue:after { background: rgba(156, 202, 235, 1); }
      .entry.orange:after { background: rgba(247, 167, 0, 1); }
      .entry.green:after { background: rgba(153, 198, 109, 1); }
      .entry.yellow:after { background: rgba(249, 233, 0, 1); }

      /* Animations are cool!  */
      @-webkit-keyframes moveFromTopFade {
        from { opacity: .3; height:0px; margin-top:0px; -webkit-transform: translateY(-100%); }
      }
      @-moz-keyframes moveFromTopFade {
        from { height:0px; margin-top:0px; -moz-transform: translateY(-100%); }
      }
      @keyframes moveFromTopFade {
        from { height:0px; margin-top:0px; transform: translateY(-100%); }
      }

      @-webkit-keyframes moveToTopFade {
        to { opacity: .3; height:0px; margin-top:0px; opacity: 0.3; -webkit-transform: translateY(-100%); }
      }
      @-moz-keyframes moveToTopFade {
        to { height:0px; -moz-transform: translateY(-100%); }
      }
      @keyframes moveToTopFade {
        to { height:0px; transform: translateY(-100%); }
      }

      @-webkit-keyframes moveToTopFadeMonth {
        to { opacity: 0; -webkit-transform: translateY(-30%) scale(.95); }
      }
      @-moz-keyframes moveToTopFadeMonth {
        to { opacity: 0; -moz-transform: translateY(-30%); }
      }
      @keyframes moveToTopFadeMonth {
        to { opacity: 0; -moz-transform: translateY(-30%); }
      }

      @-webkit-keyframes moveFromTopFadeMonth {
        from { opacity: 0; -webkit-transform: translateY(30%) scale(.95); }
      }
      @-moz-keyframes moveFromTopFadeMonth {
        from { opacity: 0; -moz-transform: translateY(30%); }
      }
      @keyframes moveFromTopFadeMonth {
        from { opacity: 0; -moz-transform: translateY(30%); }
      }

      @-webkit-keyframes moveToBottomFadeMonth {
        to { opacity: 0; -webkit-transform: translateY(30%) scale(.95); }
      }
      @-moz-keyframes moveToBottomFadeMonth {
        to { opacity: 0; -webkit-transform: translateY(30%); }
      }
      @keyframes moveToBottomFadeMonth {
        to { opacity: 0; -webkit-transform: translateY(30%); }
      }

      @-webkit-keyframes moveFromBottomFadeMonth {
        from { opacity: 0; -webkit-transform: translateY(-30%) scale(.95); }
      }
      @-moz-keyframes moveFromBottomFadeMonth {
        from { opacity: 0; -webkit-transform: translateY(-30%); }
      }
      @keyframes moveFromBottomFadeMonth {
        from { opacity: 0; -webkit-transform: translateY(-30%); }
      }

      @-webkit-keyframes fadeIn  {
        from { opacity: 0; }
      }
      @-moz-keyframes fadeIn  {
        from { opacity: 0; }
      }
      @keyframes fadeIn  {
        from { opacity: 0; }
      }

      @-webkit-keyframes fadeOut  {
        to { opacity: 0; }
      }
      @-moz-keyframes fadeOut  {
        to { opacity: 0; }
      }
      @keyframes fadeOut  {
        to { opacity: 0; }
      }

      @-webkit-keyframes fadeOutShink  {
        to { opacity: 0; padding: 0px; height: 0px; }
      }
      @-moz-keyframes fadeOutShink  {
        to { opacity: 0; padding: 0px; height: 0px; }
      }
      @keyframes fadeOutShink  {
        to { opacity: 0; padding: 0px; height: 0px; }
      }
      .del_linkpost {
        margin-top:20px;
      }
      .feedwrap > div:nth-child(2) {
        text-align:left;
      }
      .smallmenu {
        max-height:40px;
        max-width:40px;
        width:40px;
        height:40px;
        margin-right:10px;
      }
      div.mint-tab-container-item:nth-child(1) img {
        margin-top:0px;
        margin-left:0px;
        max-height:140px;
        max-width:140px;
        height:auto;
        width:auto;
      }
      @media only screen and (min-width: 1025px) {
        div.mint-tab-container-item:nth-child(1) img {
          max-height:280px;
          max-width:280px;
        }
      }
      .desktoponly {
        padding-top:40px;
        display:inline-block;
        width:325px;
        float:right;
      }
      .desktopandmobile {
        display:inline;
        width:60%;
        float:left;
      }
      .desktopfooter {
        width:1025px;
      }
      .postest a {
        margin: 10px;
        font-size:12px;
        color: black;
        text-decoration-color: black;
      }
      @media only screen and (max-width: 1025px) {
        .desktoponly {
          padding-top:40px;
          display:inline-block;
          width:40%;
          float:right;
        }
      }
      @media only screen and (min-width: 1025px) {
        .postest a {
          margin: 10px;
          font-size:18px;
        }
        .desktopandmobile {
          width:700px;
        }
      }
      .centerbox {
        margin: 0 auto;
      }
      .postest {
        margin: 0 auto;
        margin-top:20px;
        margin-bottom:20px;
      }
      .welcomebox {
        text-align: center;
        padding-top:100px;
        padding-bottom:100px;
        width:90%;
        background-color:#ddd;
        border-radius:25px;
        font-size:18px;
      }
      .welcometext {
        margin: 20px;
      }
      @media only screen and (min-width: 1025px) {
        .welcomebox {
          font-size:32px;
        }
        .welcometext {
        }
      }
      .withborders {
        border: 1px solid black;
        border-width: 1px 0px 1px 0px;
        padding:10px;
      }
      .grades {
        margin: 0px;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      .desktopGrades {
        box-sizing: border-box;
        padding: 2px;
        width: 50%;
        height: 50%;
      }
      .desktopGrades h1 {
        font-size: 22px;
        margin:5px;
      }
      .desktopGrades p {
        margin:5px;
        font-size:14px;
      }
      .tourfooter {
        margin-top:25px;
        margin-bottom:50px;
        display: inline-block;
      }
      .linkbox {
        background-color:#ddd;
        border-radius: 15px;
        margin:0px;
        padding:4px;
      }
      .linkbox a {
        font-size: 12px;
        color: black;
        text-decoration-color: black;
      }
      @media only screen and (min-width: 1025px) {
        .desktopGrades h1 {
          font-size:32px;
        }
        .desktopGrades p {
          font-size:18px;
        }
        .linkbox {
        }
        .linkbox a {
          font-size: 18px;
        }
      }
      .public_bio img {
        margin-top:0px;
        margin-left:0px;
        max-height:250px;
        max-width:250px;
        height:auto;
        width:auto;
      }
      .public_bio {
        text-align:left;
      }
      div.mint-tab-container-item:nth-child(1) {
        text-align:left;
      }
      .introtext {
        text-align:left;
      }
      .twobytwo {
        text-align: center;
        margin-top: 10px;
        margin-bottom:0px;
      }
      .centerpic {
        overflow: hidden;
        background-image: url("file/councilidaho.jpg");
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center center;
        position: relative;
      }
      .desc {
        position: absolute;
        padding:0px;
        bottom:0;
        display: inline-block;
      }
      .centercopy {
        width:100%;
        background-color:rgba(0, 0, 0, 0.5);
        filter:alpha(opacity=50);
        color: #ccc;
        position:absolute;
        bottom: 0;
      }
      .menugrid {
        padding: 0px;
        margin-top:7px;
        list-style:none;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
      }
      .menugrid li {
        margin:8px;
      }
      .toppanel {
        background-color:#e08f62;
        filter:alpha(opacity=50);
      }
      .midpanel {
        background-color:#ded7b1;
        filter:alpha(opacity=50);
      }
      .botpanel {
        background-color:#9dab86;
        filter:alpha(opacity=50);
      }
      .menubox {
        width:90%;
        font-size:18px;
      }
      .calitem {
        display:inline-block;
      }
      .calitem h1 {
        display:inline-block;
      }
      .calitem img {
        width: 50px;
        display:block;
      }
      .caption > ul img {
        width:70%;
      }
      a.imagecell:nth-child(2) > div:nth-child(3) > div:nth-child(2) > p:nth-child(1) > ul:nth-child(1) img {
        width:70%;
      }
      .caption > ul {
        list-style:none;
        font-size:18px;
        white-space: nowrap;
        float:left;
        margin:20px;
      }
      a.imagecell:nth-child(2) > div:nth-child(3) > div:nth-child(2) > p:nth-child(1) > ul {
        list-style:none;
        font-size:18px;
        white-space: nowrap;
        float:left;
        margin:20px;
      }
      .caption > ul li {
        padding:10px;
      }
      a.imagecell:nth-child(2) > div:nth-child(3) > div:nth-child(2) > p:nth-child(1) > ul li {
        padding:10px;
      }
      .bizRegButt {
        margin-bottom:50px;
      }
      .publicpagemenu {
        top:212px;
        width:100%;
        margin-top:0;
        padding-top:0;
      }
      .create_post_button {
        padding-top:10px;
        padding-bottom:50px;
      }
    </style>

    <script id="client">

      const STATUS_INITIAL = 0, STATUS_SAVING = 1, STATUS_SUCCESS = 2, STATUS_FAILED = 3;

      const freeTrial = {
        data() {
          return {
            spinnerHidden : true,
            email: '',
            emailstatus: '',
            sent : false,
            phone : '',
            inputhidden: true,
            signuphidden: true,
            inputnamehidden: false,
            code: '',
            name:'',
            loginHidden: false,
            registerHidden: false,
            sentcode: '',
            selected: 'tab1',
            pwdstatus: '',
            password: '',
            passwordcheck: '',
            loginpassword: '',
            loginemail: '',
            forgotHidden: true,
            resetHidden: true,
            sentReset: false,
            savedReset: false
          }
        },
        created() {
          if (this.$route.path.includes('login')){
            this.selected = 'tab2'
          }
          if (this.$route.path.substring(1) == 'reset'){
            this.selected = 'tab2'
            this.loginHidden = true
            this.resetHidden = false
          }
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'freeTrialStart', {
              code : this.code,
              email : this.email,
              phone : this.phone,
              name: this.name
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
                this.spinnerHidden = true
              }
            })
          },
          validateEmail(email) {
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email)
          },
          myLogin(){
            if (this.loginemail.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.loginemail).toLowerCase())) {
                this.emailstatus = 'success'
                Vue.http.post( 'freeTrialLogin', {
                  email : this.loginemail,
                  pass : this.loginpassword,
                  name: this.name,
                  phone: this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  if (response.body[0] == 'OK') {
                    this.emailstatus = 'success'
                    this.pwdstatus = 'success'
                    this.loginpassword = ''
                    this.loginemail = ''
                    if (typeof this.$route.params.grp !== 'undefined') {
                      if ('bppuhyny' == this.$route.params.grp) {
                        router.push( '/group/' + this.$route.params.grp )
                      } else {
                        router.push( '/postgroup/' + this.$route.params.grp )
                      }
                    } else {
                      if (typeof this.$route.params.postid !== 'undefined') {
                        router.push( '/showPost/' + this.$route.params.postid )
                      } else {
                        window.location.href = '/'
                      }
                    }
                  } else {
                    this.emailstatus = 'error'
                    this.pwdstatus = 'error'
                    MintUI.Toast({
                      message: 'Sorry, there was a problem logging in with that e-mail address',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                  }
                  this.spinnerHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.email.match(/\d/g).length===10) {
                this.emailstatus = 'success'
                this.phone = this.email
                this.email = ''
                Vue.http.post( 'freeTrialLogin', {
                  email : this.email,
                  phone : this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inputhidden = false
                  this.sent = true
                  this.sentcode = 'A code was just sent to your phone'
                  this.loginHidden = true
                 /* MintUI.Toast({
                    message: 'Check your text messages for a link!',
                    iconClass: 'icon icon-success',
                    duration: 10000
                   })*/
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          doLogin(){
            this.loginHidden = false
            this.registerHidden = true
          },
          doRegister(){
            this.loginHidden = true
            this.registerHidden = false
          },
          doTrial(){
            if (this.password.length > 5) {
              this.pwdstatus = 'success'
            } else {
              MintUI.Toast({
                message: 'Please use a password that is at least 6 characters long',
                iconClass: 'icon icon-error',
                duration: 2000
              })
              this.pwdstatus = 'error'
              return
            }
            if (this.password.normalize() === this.passwordcheck.normalize()) {
              this.pwdstatus = 'success'
            } else {
              MintUI.Toast({
                message: 'Passwords do not match',
                iconClass: 'icon icon-error',
                duration: 2000
              })
              this.pwdstatus = 'error'
              return
            }
            if (this.email.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.email).toLowerCase())) {
                this.emailstatus = 'success'
                Vue.http.post( 'freeTrial', {
                  email : this.email,
                  phone : this.phone,
                  name: this.name,
                  pass: this.password
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    this.inputnamehidden = false
                    this.emailstatus = 'error'
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  if (response.body[0] == 'OK') {
                    this.passwordcheck = ''
                    this.email = ''
                    this.name = ''
                    this.password = ''
                    if (typeof this.$route.params.grp !== 'undefined') {
                      if ('bppuhyny' == this.$route.params.grp) {
                        router.push( '/group/' + this.$route.params.grp )
                      } else {
                        router.push( '/postgroup/' + this.$route.params.grp )
                      }
                    } else {
                      if (typeof this.$route.params.postid !== 'undefined') {
                        router.push( '/showPost/' + this.$route.params.postid )
                      } else {
                        window.location.href = '/'
                      }
                    }
                  } else {
                    this.emailstatus = 'error'
                    MintUI.Toast({
                      message: 'Sorry, there was a problem registering with that e-mail address',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                  }
                  this.spinnerHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.email.match(/\d/g).length===10) {
                this.inputnamehidden = true
                this.emailstatus = 'success'
                this.phone = this.email
                this.email = ''
                Vue.http.post( 'freeTrial', {
                  email : this.email,
                  phone : this.phone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    this.emailstatus = 'error'
                    this.inputnamehidden = false
                    return
                  }
                  this.sentcode = 'A code was just sent to your phone'
                  this.registerHidden = true
                  this.signuphidden = false
                  this.sent = true
                 /* MintUI.Toast({
                    message: 'Check your text messages for a link!',
                    iconClass: 'icon icon-success',
                    duration: 10000
                   })*/
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          goLogin() {
            this.selected = "tab2"
          },
          goForgot() {
            this.resetHidden = true
            this.forgotHidden = false
            this.loginHidden = true
          },
          goLoginForgot() {
            this.resetHidden = true
            this.forgotHidden = true
            this.loginHidden = false
          },
          goLoginReset() {
            this.goLoginForgot()
            window.location.href = 'https://' + window.location.hostname + '/#/login'
          },
          myForgot() {
            Vue.http.post( 'sendResetPwd', {
              email : this.loginemail,
            }).then( ( response ) => {
              if (response.body[0] == 'error') {
                MintUI.Toast({
                  message: 'Error',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                this.emailstatus = 'error'
              } else {
                this.sentReset = true
              }
            })
          },
          doReset() {
            Vue.http.post( 'saveResetPwd', {
              pass : this.password,
            }).then( ( response ) => {
              if (response.body[0] == 'error') {
                MintUI.Toast({
                  message: 'Error',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                this.emailstatus = 'error'
              } else {
                this.savedReset = true
                this.sentReset = false
                this.password = ''
              }
            })
          }
        },
        template: `
          <div class="feedwrap">
            <mt-tabbar fixed="true" v-model="selected">
              <mt-tab-item id="tab1">
                <img slot="icon" src="/file/users.svg" />
                Sign Up
              </mt-tab-item>
              <mt-tab-item id="tab2">
                <img slot="icon" src="/file/home.svg" />
                Log In
              </mt-tab-item>
            </mt-tabbar>
            <mt-tab-container v-model="selected" class="introblock signupbox">
              <mt-tab-container-item id="tab1">
                <mt-header title="OurTown">
                  <a slot="left">
                    <mt-button slot="left" @click="$router.back()" icon="back">back</mt-button>
                  </a>
                </mt-header>
                <h4>Register for an account:</h4>
                <mt-field v-bind:class="{'is-hidden':inputnamehidden}" placeholder="Your name..." v-model="name"></mt-field>
                <mt-field v-bind:class="{'is-hidden':registerHidden}" placeholder="E-mail Address..." type="email" :state="emailstatus" v-model="email"></mt-field>
                <mt-field v-bind:class="{'is-hidden':registerHidden}" placeholder="Password..." type="password" :state="pwdstatus" v-model="password"></mt-field>
                <mt-field v-bind:class="{'is-hidden':registerHidden}" placeholder="Password (again)" type="password" :state="pwdstatus" v-model="passwordcheck"></mt-field>
                <mt-button v-bind:class="{'is-hidden':registerHidden}" v-on:click="doTrial()" size="large">Sign Up</mt-button>
                <mt-cell v-bind:class="{'is-hidden':signuphidden}" class="codeinput">{{sentcode}}</mt-cell>
                <mt-field v-bind:class="{'is-hidden':signuphidden}" class="codeinput" type="number" label="Code:" placeholder="***" v-model="code"></mt-field>
                <mt-button v-bind:class="{'is-hidden':signuphidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
                <div class="loginlink"><a href="javascript:void(0)" @click="goLogin()">Already Registered?</a></div>
                <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="OurTown">
                  <a slot="left">
                    <mt-button slot="left" @click="$router.back()" icon="back">back</mt-button>
                  </a>
                </mt-header>
                <h4 v-bind:class="{'is-hidden':loginHidden}">Log in to your account:</h4>
                <h4 v-bind:class="{'is-hidden':forgotHidden}">Reset your password:</h4>
                <mt-field v-bind:class="{'is-hidden':loginHidden}" placeholder="E-mail Address..." type="email" :state="emailstatus" v-model="loginemail"></mt-field>
                <mt-field v-bind:class="{'is-hidden':loginHidden}" placeholder="Password..." type="password" :state="pwdstatus" v-model="loginpassword"></mt-field>
                <mt-button v-bind:class="{'is-hidden':loginHidden}" v-on:click="myLogin()" size="large">Log In</mt-button>
                <mt-field v-bind:class="{'is-hidden':forgotHidden}" placeholder="E-mail Address..." type="email" :state="emailstatus" v-model="loginemail"></mt-field>
                <mt-button v-bind:class="{'is-hidden':forgotHidden}" v-on:click="myForgot()" size="large">Reset Password</mt-button>
                <mt-button v-bind:class="{'is-hidden':inputhidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
                <div v-bind:class="{'is-hidden':forgotHidden}" class="loginlink"><a href="javascript:void(0)" @click="goLoginForgot()">Log In</a></div>
                <div v-bind:class="{'is-hidden':loginHidden}" class="loginlink"><a href="javascript:void(0)" @click="goForgot()">Forgot Password?</a></div>
                <mt-field v-bind:class="{'is-hidden':resetHidden}" placeholder="Password..." type="password" :state="pwdstatus" v-model="password"></mt-field>
                <mt-field v-bind:class="{'is-hidden':resetHidden}" placeholder="Password (again)" type="password" :state="pwdstatus" v-model="passwordcheck"></mt-field>
                <mt-button v-bind:class="{'is-hidden':resetHidden}" v-on:click="doReset()" size="large">Reset Password</mt-button>
                <div v-bind:class="{'is-hidden':resetHidden}" class="loginlink"><a href="javascript:void(0)" @click="goLoginReset()">Log In</a></div>
                <mt-cell v-bind:class="{'is-hidden':!sentReset}" class="codeinput">A link has been sent to your e-mail address, click the link to reset your password.</mt-cell>
                <mt-cell v-bind:class="{'is-hidden':!savedReset}" class="codeinput">Your password has been reset.</mt-cell>
                <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
              </mt-tab-container-item>
            </mt-tab-container>
          </div>`
      }
      const connect = {
        data() {
          return {
            code:'',
            spinnerHidden:false,
            sentcode: ''
          }
        },
        props: {},
        created() {
          if (!(window.location.href.match(/\/g\//g) === null)) {
            window.location.href = 'https://' + window.location.hostname + '/#/connect/' + this.$route.params.code
            return
          }
          this.spinnerHidden = false
          Vue.http.post( 'doConnect', {
            code:this.$route.params.code
          }).then( ( response ) => {
            if (response.body[0] == 'OK') {
              window.location.href = '/'
            } else {
              this.sentcode = 'A code was just sent to your ' + response.body[0]
            }
            this.spinnerHidden = true
          })
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'doCode', {
              code:this.code,
              connect:this.$route.params.code
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                window.location.href = '/'
              } else {
                alert('Sorry, the code did not match')
              }
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
            </mt-header>
            <mt-cell>{{sentcode}}</mt-cell>
            <mt-field type="number" class="codeinput" label="Code:" placeholder="***" v-model="code"></mt-field>
            <mt-button v-on:click="doCode()" size="large">Submit Code</mt-button>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const tourStart = {
        data() {
          return {
            showIntro: false
          }
        },
        props: {},
        created() {
          var value="set"
          var name="starttour4"
          var nameEQ = name + "="
          var ca = document.cookie.split(';')
          var found = false
          for(var i=0;i < ca.length;i++) {
            var c = ca[i]
            while (c.charAt(0)==' ') c = c.substring(1,c.length)
            if (c.indexOf(nameEQ) == 0) {
              //c.substring(nameEQ.length,c.length)
              found = true
            }
          }
          
          if (!found) {
            var days = 1
            var date = new Date();
            date.setTime(date.getTime()+(60*60*1000));
            var expires = "; expires="+date.toUTCString();
            //document.cookie = name+"="+value+expires+"; path=/; SameSite=None; Secure";
            //this.showIntro = true
          }
          this.showIntro = true
          
        },
        methods: {
          tourNext(){
            router.push( '/group/' + this.$route.params.grp )
          }
        },
        template: `
          <div>
            <mt-header title="OurTown">
            </mt-header>

            <div style="width:100%;">
            <div class="postest">
            <a href="/#/login/bppuhyny">Login</a>
            |<a href="/#/auth/bppuhyny">Sign Up</a>
            <!--|<a href="/#/contactForm/tlicintr">Business Inquiries</a>
            |<a href="/#/pubgroup/jyyktmzx">About</a>-->
            </div>
            <div v-if="showIntro" class="centerbox">
                <div class="welcomebox centerbox centerpic">
                  <div class="">
                    <div class="centerbox centercopy">Welcome to Council, Idaho</div>
                  </div>
                </div>
            </div>
 <!--             <div v-if="showIntro" class="centerbox">
              <div class="centerbox welcometext introtext">
 


<p>Welcome to OurTown, where you'll find information thatâ€™s important to you and your small town: news, events, announcements, businesses, and more.</p>
<p>Look around, post your own event, discover a local business, get involved, and let's make our small town stronger, together!</p>
              </div>
            </div>
            </div> -->
            <!-- <mt-button v-if="showIntro" class="centerbox" v-on:click="tourNext()" size="medium">Get Started</mt-button>
            <div v-if="showIntro" class="centerbox">
              <div class="centerbox welcometext withborders">
                Looking for something specific? Click on one of the groups below.
              </div>
            </div> -->
            <div class="centerbox menubox">

        
              <ul class="menugrid">
              <li>
              <div class="linkbox toppanel">
              <a href="/#/pubgroup/bppuhyny">
              <img class="smallmenu twobytwo" src="https://ourtown.org/grpFile?field=image&amp;name=20210425-004301cil-newspaper.svg" />
              <h1>Local News</h1>
              </a>
              <p>State and regional news of interest</p>
            
              </div>
              </li>
              <li>
              <div class="linkbox toppanel">
              <a href="/#/pubgroup/nibliqms">
              <img class="smallmenu twobytwo" src="https://ourtown.org/grpFile?field=image&amp;name=20210425-004425cil-calendar.svg" />
              <h1>Calendar</h1>
              </a>
        <p>Upcoming events around Council</p>
              </div>
              </li>
              <li>
              <div class="linkbox midpanel">
              <a href="/#/pubgroup/vbkuqsko">
              <img class="smallmenu twobytwo" src="https://ourtown.org/grpFile?field=image&amp;name=20210425-004409cil-pin.svg" />
              <h1>Bulletin Board
              </h1>
              </a>
        <p>Lost and found | Help wanted | Fundraisers</p>
              </div>
              </li>
              <li>
              <div class="linkbox midpanel">
              <a href="/#/pubgroup/ekevbzyq">
              <img class="smallmenu twobytwo" src="https://ourtown.org/grpFile?field=image&amp;name=20210425-004335cil-tag.svg" />
              <h1>Classified Ads
              </h1>
              </a>
        <p>Items for sale | Land | Housing for sale or rent </p>
              </div>
              </li>
              <li>
              <div class="linkbox botpanel">
              <a href="/#/pubgroup/hdkqocon">
              <img class="smallmenu twobytwo" src="https://ourtown.org/grpFile?field=image&amp;name=20210425-004231cil-education.svg" />
              <h1>Support A Student
              </h1>
              </a>
        <p>Help a local student reach their goals!</p>
              </div>
              </li>
              <li>
              <div class="linkbox botpanel">
              <a href="/#/pubgroup/tlicintr">
              <img class="smallmenu twobytwo" src="https://ourtown.org/grpFile?field=image&amp;name=20210425-003105cil-building.svg" />
              <h1>Business Directory
              </h1>
              </a>
        <p>Support Council's businesses by shopping local!</p>
              </div>
              </li>
              
              </ul>

              </div>

            <div class="centerbox tourfooter">OurTown - Council, Idaho</div>
          </div>`
      }
      const contactForm = {
        data() {
          return {
            email:'',
            body:''
          }
        },
        props: {},
        created() {
        },
        methods: {
          doPost(){
            Vue.http.post( 'addInquiry', {
              body:this.body,
              email:this.email
            }).then( ( response ) => {
              MintUI.Toast({
                message: 'Inquiry Sent!',
                iconClass: 'icon icon-success',
                duration: 2000
              })
              this.body = ''
              this.email = ''
            })
          }
        },
        template: `
          <div>
            <div style="margin-top:40px;"></div>

            <div style="width:100%;padding:20px;">Business Inquiry</div>

            <mt-field placeholder="Email or Phone..." v-model="email" type="email"></mt-field>
            <mt-field type="text" placeholder="Message..." v-model="body"></mt-field>
            <mt-button v-on:click="doPost()" size="large">Submit Inquiry</mt-button>
            <div class="centerbox tourfooter">OurTown - Council, Idaho</div>
          </div>`
      }
      const ShowGroupPage = {
        data() {
          return {
            spinnerHidden: true,
            isInstagram: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicGroups: [],
            grp:'',
            image:'',
            name:'',
            items:[],
            moreHidden: true,
            helpVisible: false,
            shareLinks: false,
            groups: [],
            authed: false,
            notMember: true,
            showShareGroup: false,
            sharingGroup: '',
            sharingImg: '',
            groupLink: '',
            menuVisible: false,
            actions:[],
            headerTitle: "Rp.ly",
            selected: "1",
            groupposts:{},
            grouppost: [],
            postlist: [],
            isDesktop: false
          }
        },
        created() {
          if (this.items.length == 0) {
            this.pageSetup()
          }
          var check = false;
          (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
          if (check === false) {
            this.isDesktop = true
          }
        },
        methods: {
          pageSetup(){
            this.grp = this.$route.params.grp
            var ua = navigator.userAgent || navigator.vendor || window.opera
            this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
            this.spinnerHidden = false
            Vue.http.post( 'joinGroup', {
              grp:this.$route.params.grp
            }).then( ( response ) => {
              if (response.body[0] == 'Protected') {
                this.spinnerHidden = true
                this.submitPass = true
                MintUI.MessageBox.prompt('Password Required',{
                  showInput:true,
                  cancelButtonText:'Cancel',
                  confirmButtonText:'Submit Password'
                }).then(({ value, action }) => {
                  Vue.http.post('joinGroup', {
                    grp:this.$route.params.grp,
                    pass:value
                  }).then((response) => {
                    window.location.href = '/grp/' + this.$route.params.grp
                  })
                })
                return
              }
              if (response.body[3] == 'AUTHED') {
                this.authed = true
                if (response.body[5] == 'MEMBER') {
                  this.notMember = false
                } else {
                  this.notMember = true
                }
              } else {
                this.authed = false
              }
              var publicData = JSON.parse(response.body[6])
              if ("undefined" !== typeof publicData['publicName']) {
                this.publicName = publicData['publicName']
                this.publicBio = publicData['publicBio'].replace("\n","<br>")
                this.publicLink = publicData['publicLink']
                this.publicImage = publicData['publicImage']
                this.publicGroups = publicData['publicGroups']
                this.image = response.body[2]
                this.name = response.body[1]
                 //this.publicGroups.unshift({grp:this.$route.params.grp,image:,name:})
                this.sharingGroup = publicData['publicName']
                this.sharingImg = 'grpFile?field=publicImage&name=' + publicData['publicImage']
                this.groupLink = publicData['publicName'] + ' https://rp.ly/' + publicData['publicPath']
                this.actions = []
                for(grp in this.publicGroups) {
                  this.actions.push({
                    name:this.publicGroups[grp].name,
                    method:this.showPage
                  })
                  this.publicGroups[grp].posts = []
                  //alert(this.publicGroups[grp].image)
                }
                Vue.http.get( 'getPosts' + '?grp=' + this.$route.params.grp).then( ( response ) => {
                  if ( !!response.body ) {
                    if (this.cursor > 0) {
                      if (response.body[0].length < 10) {
                        this.moreHidden = true
                      }
                      for (var j = 0; j < response.body[0].length; j++) {
                        this.items.push(response.body[0][j])
                      }
                    } else {
                      /*
                      this.postlist = response.body[0]
                      if (this.postlist.length > 9) {
                        this.moreHidden = false
                      }*/
                      this.items = response.body[0]
                      if (this.items.length > 9) {
                        this.moreHidden = false
                      }
                    }
                    this.groups = response.body[1]
                    this.shareLinks = false
                    var redir = false
                    for (var j = 0; j < this.groups.length; j++) {
                      if (parseInt(this.groups[j].links) > 0) {
                        if (this.groups[j].label == this.name) {
                          this.shareLinks = true
                          this.headerTitle = this.sharingGroup
                        }
                      }
                    }
                    if (this.shareLinks) {
                      router.push( '/tourStart' )
                      //router.push( '/tourStart/' + this.$route.params.grp )
                      /*
                      var responses = []
                      this.spinnerHidden = false
                      var delayTotal = 500 * this.publicGroups.length
                      MintUI.Indicator.open({
                        text: 'Loading...',
                        spinnerType: 'fading-circle'
                      })
                      this.grouppost = []
                      for(grp in this.publicGroups) {
                        (function(groups, grpp, obj, resps) {
                          Vue.http.get( 'getPosts' + '?grp=' + groups[grpp].grp).then( ( response ) => {
                            if ( !!response.body ) {
                              if (obj.items.length === 0) {
                                for (var j = 0; j < obj.postlist.length; j++) {
                                  obj.items.push(obj.postlist[j])
                                }
                              }
                              groups[grpp].posts = response.body[0]
                              obj.grouppost.push(response.body[0])
                              //obj.groupposts['ljhmdvqk'] = response.body[0]
                              if (parseInt(groups[grpp].open) > 0) {
                                var pickstory = obj.randomNum(0,(groups[grpp].posts.length - 1))
                                var storyposition = obj.randomNum(0,(obj.items.length - 1))
                                //obj.items.push(groups[grpp].posts[p])
                                if (typeof groups[grpp].posts[pickstory] !== "undefined"){
                                  groups[grpp].posts[pickstory].imageHidden = true
                                  groups[grpp].posts[pickstory].textHidden = false
                                  obj.items.splice(storyposition, 0, groups[grpp].posts[pickstory])
                                }
                              } else {
                                for (p in groups[grpp].posts) {
                                  var storyposition = obj.randomNum(0,(obj.items.length - 1))
                                  //obj.items.push(groups[grpp].posts[p])
                                  if (typeof groups[grpp].posts[p] !== "undefined"){
                                    obj.items.splice(storyposition, 0, groups[grpp].posts[p])
                                    break
                                  }
                                }
                              }
                            }
                            resps.push(response)
                            if (resps.length == groups.length) {
                              window.setTimeout(function() {
                                MintUI.Indicator.close()
                              }, 500)
                            }
                          })
                        })(this.publicGroups, grp, this, responses)
                        
                      }
                      */
                    }
                  }
                  this.spinnerHidden = true
                })
              } else {
                router.push( '/showgroup/' + this.$route.params.grp )
              }
            })
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          randomNum(minimum,maximum){
            return Math.floor(Math.random() * (maximum - minimum + 1)) + minimum
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          linkGo(link){
            window.location.href = link
          },
          showHelp() {
            this.helpVisible = true
          },
          closeHelp(){
            this.helpVisible = false
          },
          addComment(idx) {
            if (!this.authed) {
              router.push('/auth/' + this.$route.params.grp)
            } else {
              this.items[idx].showCommentField = true
            }
          },
          saveComment(post,idx) {
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips: post.groups,
              title: JSON.stringify([post.comment]),
              inreplyto: post.id,
              expirehours: 0,
              speedup: ''
            }).then( ( response ) => {
              this.items[idx].comment = ''
              this.spinnerHidden = true
              this.items[idx].showCommentField = false
              MintUI.Toast({
                message: 'Comment Saved',
                iconClass: 'icon icon-success',
                duration: 1000
              })
            })
          },
          closeShareGroup(){
            this.showShareGroup = false
          },
          copyGroupLink(){
            this.showShareGroup = false
            MintUI.Toast({
              message: 'You copied the link to your clipboard, you can paste it to social media or text message',
              iconClass: 'icon icon-error',
              duration: 5000
            })
          },
          copyError(){
          },
          showShare(){
            this.showShareGroup = true
          },
          showMenu(){
            this.menuVisible = !this.menuVisible
          },
          showPage(e){
            for(grp in this.publicGroups) {
              if (e.name == this.publicGroups[grp].name) {
                router.push(this.publicGroups[grp].grpLink)
              }
            }
          },
          logOut(){
            Vue.http.post( 'logout', {
            }).then( ( response ) => {
              window.location.href = this.publicLink
            })
          },
          checkImage(item){
            if (typeof item.image !== "undefined") {
              return true
            } else {
              return false
            }
          }
        },
        template: `
          <div>
           <router-view />
            <mt-header class="fixedheader" fixed :title="headerTitle">
              <a :href="publicLink" slot="left">
                <img class="headericon" slot="icon" src="file/home.svg" />
              </a>
              <a v-if="!isDesktop" v-on:click="showMenu()" slot="right">
                <img class="headericon" slot="icon" src="file/menu.svg" />
              </a>
            </mt-header>
           <div v-bind:class="{'desktopandmobile':isDesktop}">
            <div v-if="shareLinks" class="readertop">
            </div>
            <div v-else>
            <img v-if="!shareLinks" class="groupimg" :src="'grpFile?field=publicImage&name=' + publicImage" />
            <h3 v-text="publicName"></h3>
            </div>
            <p v-if="!shareLinks"><a :href="publicLink" v-text="publicLink"></a></p>
            <h5 class="public_bio" v-html="publicBio"></h5>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <!--<mt-cell :title="name" is-link :to="'/pubgroup/' + grp">
              <img class="grimg" :src="image" />
            </mt-cell>-->
            <!--<mt-navbar v-if="shareLinks" v-model="selected" class="grouptabs">
              <mt-tab-item id="1">Latest</mt-tab-item>
              <mt-tab-item id="2">Calendar</mt-tab-item>
              <mt-tab-item id="3">Weather</mt-tab-item>
            </mt-navbar>-->
            <!--<mt-tab-container v-if="shareLinks" v-model="selected">
              <mt-tab-container-item id="1">
                <p>&nbsp;</p>
              </mt-tab-container-item>
              <mt-tab-container-item id="2">
                <p>&nbsp;</p>
              </mt-tab-container-item>
              <mt-tab-container-item id="3">
                <p>&nbsp;</p>
              </mt-tab-container-item>
            </mt-tab-container>
            -->
            <mt-cell v-if="shareLinks" class="imagecell public_img" v-for="(item, idx) in items" :title="item.name" is-link :to="item.link">
              <!--
              <div v-if="shareLinks" v-for="(group, idx) in publicGroups">
              <div><img class="grimg" :src="group.image" /><h3>{{group.name}}</h3></div>
              <mt-cell class="imagecell public_img" v-for="(item, iidx) in grouppost[idx]" :title="item.name">-->
              <p class="" v-html="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <!--<mt-button v-if="shareLinks" class="caption readstory" @click="linkGo(item.link)">Read Story</mt-button>
              <span v-if="item.isHtml" v-bind:class="{'is-hidden':item.showCommentField}" class="comment" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></span>-->
              <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
              <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
              <div v-if="!item.imageHidden" class="outer">
                <figcaption class="caption underpic" v-html="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption" v-html="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
            </mt-cell>
            <!--
            </div>
            <mt-navbar v-model="selected" class="grouptabs">
              <mt-tab-item v-for="(item, idx) in publicGroups" :id="item.grp">{{item.name}}</mt-tab-item>
            </mt-navbar>
            <mt-tab-container v-model="selected">
              <mt-tab-container-item v-for="(item, idx) in publicGroups" :id="item.id">
                <p>&nbsp;</p>
              </mt-tab-container-item>
            </mt-tab-container>
            -->
            <mt-cell v-if="!shareLinks" class="imagecell public_img" v-for="(item, idx) in items" :title="item.name">
              <p class="" v-html="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <!--<mt-button v-if="shareLinks" class="caption readstory" @click="linkGo(item.link)">Read Story</mt-button>
              <span v-if="item.isHtml" v-bind:class="{'is-hidden':item.showCommentField}" class="comment" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></span>-->
              <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
              <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
              <div v-if="!item.imageHidden" class="outer">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-html="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption" v-html="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              <p class="caption" v-for="(comm, cidx) in item.comments" v-text="comm.author + ': ' + comm.title"></p>
            </mt-cell>
            <mt-cell v-for="(item, idx) in publicGroups" :title="item.name" is-link :to="item.grpLink">
              <img class="grimg" :src="'' + item.image" />
            </mt-cell>
            <mt-popup class="help_popup" v-model="helpVisible" position="middle">
              <mt-header>
                <a v-on:click="closeHelp()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <h4 class="help_header">What is this?</h4>
              <p class="help_para">Rp.ly is a local news and information hub for your community. Contact us at <a href="mailto:info@rp.ly">info@rp.ly</a></p>
            </mt-popup>
            <mt-popup class="addcontact" v-model="showShareGroup" position="middle">
              <mt-header :title="sharingGroup">
                <a v-on:click="closeShareGroup()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <img class="grimg" :src="sharingImg" alt="Group Header Photo" />
              <mt-field type="textarea" rows="4" v-model="groupLink"></mt-field>
              <mt-button v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError">Share</mt-button><p></p>
            </mt-popup>
            <mt-header v-bind:class="{'desktopfooter':isDesktop}">
              <a v-on:click="showShare()" slot="right">
                <img class="headericon" slot="icon" src="file/share.svg" />
              </a>
            </mt-header>
            <mt-popup v-model="menuVisible" position="middle" class="topmenu">
              <mt-cell is-link @click.native="showMenu()" title="Close Menu"></mt-cell>
              <mt-cell v-for="(item,idx) in publicGroups" is-link :to="item.grpLink" :title="item.name"><img class="smallmenu" v-if="checkImage(item)" :src="item.image" /></mt-cell>
              <mt-cell v-if="authed" is-link :to="'/myposts/' + grp" title="My Posts"></mt-cell>
              <mt-cell v-if="authed" is-link @click.native="logOut()" title="Sign Out"></mt-cell>
            </mt-popup>
            <!--<mt-actionsheet
              cancelText="Close"
              :actions="actions"
              v-model="menuVisible">
            </mt-actionsheet>-->
            </div>
            <div class="desktoponly" v-if="isDesktop">
              <mt-cell v-for="(item,idx) in publicGroups" is-link :to="item.grpLink" :title="item.name"><img class="smallmenu" v-if="checkImage(item)" :src="item.image" /></mt-cell>
              <mt-cell v-if="authed" is-link :to="'/myposts/' + grp" title="My Posts"></mt-cell>
              <mt-cell v-if="authed" is-link @click.native="logOut()" title="Sign Out"></mt-cell>
            </div>
            
          </div>`
      }
      const PublicGroupPage = {
        data() {
          return {
            spinnerHidden: true,
            isInstagram: false,
            groupPic: '',
            items: [],
            authed: false,
            name: '',
            showPostButton: false,
            publicLink:'',
            shareCal: false,
            calendar: {},
            calHidden: true,
            publicBio: '',
            publicImage: '',
            showSponsorButton: false,
            btAuth: '',
            plan: 'firstyear5',
            plans:[{label: '$5 monthly',value: 'firstyear5'}],
            sponsorGroup: '',
            sponsorGroupName: '',
            btLoaded:false,
            formHidden: true,
            btSpinnerHidden:false,
            doSponsor: {},
            doingSponsor: false,
            glink: '',
            showDidSponsor: false,
            isDesktop: false,
            publicGroups:[],
            grp:'',
            shareLinks:false,
            headerTitle:'',
            groups:[],
            menuVisible:false
          }
        },
        mounted: function() {

          !function() {

            var today = moment();

            function Calendar(){}

            Calendar.prototype.draw = function() {
              //Create Header
              this.drawHeader();

              //Draw Month
              this.drawMonth();

              this.drawLegend();
            }

            Calendar.prototype.drawHeader = function() {
              var self = this;
              if(!this.header) {
                //Create the header elements
                this.header = createElement('div', 'header');
                this.header.className = 'header';

                this.title = createElement('h1');

                var right = createElement('div', 'right');
                right.addEventListener('click', function() { self.nextMonth(); });

                var left = createElement('div', 'left');
                left.addEventListener('click', function() { self.prevMonth(); });

                //Append the Elements
                this.header.appendChild(this.title); 
                this.header.appendChild(right);
                this.header.appendChild(left);
                this.el.appendChild(this.header);
              }

              this.title.innerHTML = this.current.format('MMMM YYYY');
            }

            Calendar.prototype.drawMonth = function() {
              var self = this;
              if(this.month) {
                this.oldMonth = this.month;
                this.oldMonth.className = 'month out ' + (self.next ? 'next' : 'prev');
                this.oldMonth.addEventListener('webkitAnimationEnd', function() {
                  self.oldMonth.parentNode.removeChild(self.oldMonth);
                  self.month = createElement('div', 'month');
                  self.backFill();
                  self.currentMonth();
                  self.fowardFill();
                  self.el.appendChild(self.month);
                  window.setTimeout(function() {
                    self.month.className = 'month in ' + (self.next ? 'next' : 'prev');
                  }, 16);
                });
              } else {
                  this.month = createElement('div', 'month');
                  this.el.appendChild(this.month);
                  this.backFill();
                  this.currentMonth();
                  this.fowardFill();
                  this.month.className = 'month new';
              }
            }

            Calendar.prototype.backFill = function() {
              var clone = this.current.clone();
              var dayOfWeek = clone.day();

              if(!dayOfWeek) { return; }

              clone.subtract('days', dayOfWeek+1);

              for(var i = dayOfWeek; i > 0 ; i--) {
                this.drawDay(clone.add('days', 1));
              }
            }

            Calendar.prototype.fowardFill = function() {
              var clone = this.current.clone().add('months', 1).subtract('days', 1);
              var dayOfWeek = clone.day();

              if(dayOfWeek === 6) { return; }

              for(var i = dayOfWeek; i < 6 ; i++) {
                this.drawDay(clone.add('days', 1));
              }
            }

            Calendar.prototype.currentMonth = function() {
              var clone = this.current.clone();

              while(clone.month() === this.current.month()) {
                this.drawDay(clone);
                clone.add('days', 1);
              }
            }

            Calendar.prototype.getWeek = function(day) {
              if(!this.week || day.day() === 0) {
                this.week = createElement('div', 'week');
                this.month.appendChild(this.week);
              }
            }

            Calendar.prototype.drawDay = function(day) {
              var self = this;
              this.getWeek(day);

              //Outer Day
              var outer = createElement('div', this.getDayClass(day));
              outer.addEventListener('click', function() {
                self.openDay(this);
              });

              //Day Name
              var name = createElement('div', 'day-name', day.format('ddd'));

              //Day Number
              var number = createElement('div', 'day-number', day.format('DD'));


              //Events
              var events = createElement('div', 'day-events');
              this.drawEvents(day, events);

              outer.appendChild(name);
              outer.appendChild(number);
              outer.appendChild(events);
              this.week.appendChild(outer);
            }

            Calendar.prototype.drawEvents = function(day, element) {
              if(day.month() === this.current.month()) {
                var todaysEvents = this.events.reduce(function(memo, ev) {
                  if(ev.date.isSame(day, 'day')) {
                    memo.push(ev);
                  }
                  return memo;
                }, []);

                todaysEvents.forEach(function(ev) {
                  var evSpan = createElement('span', ev.color);
                  element.appendChild(evSpan);
                });
              }
            }

            Calendar.prototype.getDayClass = function(day) {
              classes = ['day'];
              if(day.month() !== this.current.month()) {
                classes.push('other');
              } else if (today.isSame(day, 'day')) {
                classes.push('today');
              }
              return classes.join(' ');
            }

            Calendar.prototype.openDay = function(el) {
              var details, arrow;
              var dayNumber = +el.querySelectorAll('.day-number')[0].innerText || +el.querySelectorAll('.day-number')[0].textContent;
              var day = this.current.clone().date(dayNumber);

              var currentOpened = document.querySelector('.details');

              //Check to see if there is an open detais box on the current row
              if(currentOpened && currentOpened.parentNode === el.parentNode) {
                details = currentOpened;
                arrow = document.querySelector('.arrow');
              } else {
                //Close the open events on differnt week row
                //currentOpened && currentOpened.parentNode.removeChild(currentOpened);
                if(currentOpened) {
                  currentOpened.addEventListener('webkitAnimationEnd', function() {
                    currentOpened.parentNode.removeChild(currentOpened);
                  });
                  currentOpened.addEventListener('oanimationend', function() {
                    currentOpened.parentNode.removeChild(currentOpened);
                  });
                  currentOpened.addEventListener('msAnimationEnd', function() {
                    currentOpened.parentNode.removeChild(currentOpened);
                  });
                  currentOpened.addEventListener('animationend', function() {
                    currentOpened.parentNode.removeChild(currentOpened);
                  });
                  currentOpened.className = 'details out';
                }

                //Create the Details Container
                details = createElement('div', 'details in');

                //Create the arrow
                var arrow = createElement('div', 'arrow');

                //Create the event wrapper

                details.appendChild(arrow);
                el.parentNode.appendChild(details);
              }

              var todaysEvents = this.events.reduce(function(memo, ev) {
                if(ev.date.isSame(day, 'day')) {
                  memo.push(ev);
                }
                return memo;
              }, []);

              this.renderEvents(todaysEvents, details);

              arrow.style.left = el.offsetLeft - el.parentNode.offsetLeft + 27 + 'px';
            }

            Calendar.prototype.renderEvents = function(events, ele) {
              //Remove any events in the current details element
              var currentWrapper = ele.querySelector('.events');
              var wrapper = createElement('div', 'events in' + (currentWrapper ? ' new' : ''));

              events.forEach(function(ev) {
                var div = createElement('div', 'event');
                var square = createElement('div', 'event-category ' + ev.color);
                var span = createElement('span', '', ev.eventName);

                div.appendChild(square);
                div.appendChild(span);
                wrapper.appendChild(div);
              });

              if(!events.length) {
                var div = createElement('div', 'event empty');
                var span = createElement('span', '', 'No Events');

                div.appendChild(span);
                wrapper.appendChild(div);
              }

              if(currentWrapper) {
                currentWrapper.className = 'events out';
                currentWrapper.addEventListener('webkitAnimationEnd', function() {
                  currentWrapper.parentNode.removeChild(currentWrapper);
                  ele.appendChild(wrapper);
                });
                currentWrapper.addEventListener('oanimationend', function() {
                  currentWrapper.parentNode.removeChild(currentWrapper);
                  ele.appendChild(wrapper);
                });
                currentWrapper.addEventListener('msAnimationEnd', function() {
                  currentWrapper.parentNode.removeChild(currentWrapper);
                  ele.appendChild(wrapper);
                });
                currentWrapper.addEventListener('animationend', function() {
                  currentWrapper.parentNode.removeChild(currentWrapper);
                  ele.appendChild(wrapper);
                });
              } else {
                ele.appendChild(wrapper);
              }
            }

            Calendar.prototype.drawLegend = function() {
              var legend = createElement('div', 'legend');
              var calendars = this.events.map(function(e) {
                return e.calendar + '|' + e.color;
              }).reduce(function(memo, e) {
                if(memo.indexOf(e) === -1) {
                  memo.push(e);
                }
                return memo;
              }, []).forEach(function(e) {
                var parts = e.split('|');
                var entry = createElement('span', 'entry ' +  parts[1], parts[0]);
                legend.appendChild(entry);
              });
              this.el.appendChild(legend);
            }

            Calendar.prototype.nextMonth = function() {
              this.current.add('months', 1);
              this.next = true;
              this.draw();
            }

            Calendar.prototype.prevMonth = function() {
              this.current.subtract('months', 1);
              this.next = false;
              this.draw();
            }

            window.Calendar = Calendar;

            function createElement(tagName, className, innerText) {
              var ele = document.createElement(tagName);
              if(className) {
                ele.className = className;
              }
              if(innerText) {
                ele.innerText = ele.textContent = innerText;
              }
              return ele;
            }
          }();
          this.calendar = new Calendar()
          this.calendar.el = this.$refs.calendar
          Vue.http.get( 'getCal' + '?grp=' + this.$route.params.grp).then( ( response ) => {
            if ( !!response.body ) {
              var calitems = response.body[0]
              var data = []
              for (var j = 0; j < calitems.length; j++) {
                data.push({ eventName: calitems[j]['title'], calendar: 'Local', color: 'green', date: moment(calitems[j]['pubDate'],'YYYY-MM-DD')})
              }
              this.calendar.events = data;
              this.calendar.current = moment().date(1);
              var self = this.calendar;
              this.calendar.draw();
              var current = this.calendar.el.querySelector('.today');
              if(current) {
                var self = this.calendar;
                window.setTimeout(function() {
                  self.openDay(current);
                }, 500);
              }
            }
          })
        },
        created() {
          this.setup()
        },
        watch: {
          '$route.params.grp': function (grp) {
            this.setup()
          }
        },
        methods: {
          setup(){
            this.menuVisible = false
            this.groupPic = ''
            this.items = []
            this.name = ''
            this.showSponsorButton = false
            this.showPostButton = false
            this.shareCal = false
            this.calendar = {}
            this.calHidden = true
            this.publicBio = ''
            this.publicImage = ''
            this.formHidden = true
            this.doSponsor = {}
            this.doingSponsor = false
            this.glink = ''
            this.showDidSponsor = false
            this.publicGroups = []
            this.grp = this.$route.params.grp
            var check = false;
            (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
            if (check === false) {
              this.isDesktop = true
            }
            var ua = navigator.userAgent || navigator.vendor || window.opera
            this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
            this.spinnerHidden = false
            Vue.http.post( 'joinGroup', {
              grp:this.$route.params.grp
            }).then( ( response ) => {
              this.groupPic = response.body[2]
              var publicData = JSON.parse(response.body[6])
              this.name = response.body[1]
              if (this.name == 'Business Directory') {
                this.showSponsorButton = true
              }
              if (response.body[3] == 'AUTHED') {
                if (response.body[5] == 'MEMBER') {
                }
                this.authed = true
              } else {
                this.authed = false
              }
              this.glink = response.body[4]
              if (parseInt(response.body[8]) > 0) {
                this.showPostButton = true
              }
              this.publicLink = publicData['publicLink']
              this.publicBio = publicData['publicBio']
              this.publicImage = publicData['publicImage']
              this.publicGroups = publicData['publicGroups']
              if ("undefined" !== typeof publicData['shareCal']) {
                if (parseInt(publicData['shareCal']) > 0) {
                  this.shareCal = true
                  this.calHidden = false
                }
              }
              if ("undefined" !== typeof publicData['publicName']) {
                Vue.http.get( 'getPosts' + '?grp=' + this.$route.params.grp).then( ( response ) => {
                  if ( !!response.body ) {
                    if (this.cursor > 0) {
                      if (response.body[0].length < 10) {
                        this.moreHidden = true
                      }
                      for (var j = 0; j < response.body[0].length; j++) {
                        this.items.push(response.body[0][j])
                      }
                    } else {
                      this.items = response.body[0]
                      if (this.items.length > 9) {
                        this.moreHidden = false
                      }
                      for (var j = 0; j < this.items.length; j++) {
                        this.items[j].imageHidden = true
                        this.items[j].isHtml = true
                        this.items[j].textHidden = false
                      }
                      this.groups = response.body[1]
                      this.shareLinks = false
                      for (var j = 0; j < this.groups.length; j++) {
                        if (parseInt(this.groups[j].links) > 0) {
                          this.shareLinks = true
                          this.headerTitle = this.sharingGroup
                        }
                      }
                      
                      
                    }
                  }
                  this.spinnerHidden = true
                })
                this.spinnerHidden = true
              } else {
              }
            })
          },
          wrapImages(){
            var images = document.getElementsByClassName("article_img");
            for (var j = 0; j < images.length; j++) {
              var element = images[j];
              var parent = element.parentNode;
              var wrapper = document.createElement('div');
              wrapper.classList.add("feedimages");
              parent.replaceChild(wrapper, element);
              wrapper.appendChild(element);
            }
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          doPost(){
            if (!this.authed) {
              router.push('/auth/' + this.$route.params.grp)
            } else {
              router.push('/postgroup/' + this.$route.params.grp)
            }
          },
          doRegister(){
            if (!this.authed) {
              router.push('/auth/' + this.$route.params.grp)
            } else {
              this.showSponsorButton = false
              this.doingSponsor = true
              this.sponsorGroup = this.glink
              this.sponsorGroupName = 'Subscribe to list your business in the Business Directory, with a $5 per month automatic credit card subscription'
              this.sponsorVisible = true
              if (false === this.btLoaded) {
                Vue.http.post( 'btSetup', {
                }).then( ( response ) => {
                  this.btAuth = response.body[0]
                  this.subs = response.body[1]
                  this.createHostedFields()
                  this.btLoaded = true
                  this.formHidden = false
                  this.btSpinnerHidden = true
                })
              }
            }
          },
          createHostedFields() {
            var postsobj = this
            if (typeof braintree !== "undefined" && this.btAuth != '') {
              braintree.setup(this.btAuth, "custom", {
                id: "cardForm",
                hostedFields: {
                  number: {
                    selector: "#card-number",
                    placeholder: "4111 1111 1111 1111"
                  },
                  cvv: {
                    selector: "#cvv",
                    placeholder: "111"
                  },
                  expirationDate: {
                    selector: "#expiration-date",
                    placeholder: "MM/YY"
                  },
                  postalCode: {
                    selector: "#postal-code",
                    placeholder: "32323"
                  },
                  styles: {
                    'input': {
                      'font-size': '16px',
                      'font-family': 'courier, monospace',
                      'font-weight': 'lighter',
                      'color': '#ccc'
                    },
                    ':focus': {
                      'color': 'black'
                    },
                    '.valid': {
                      'color': '#8bdda8'
                    }
                  }
                },
                onReady: function (integration) {
                  checkout = integration
                },
                onPaymentMethodReceived: function (nonce) {
                  Vue.http.post( 'doRegistry', {
                    method:JSON.stringify(nonce),
                    plan_id:postsobj.plan,
                    group_id:postsobj.sponsorGroup
                  }).then( ( response ) => {
                    MintUI.Toast({
                      message: 'Thank you! You will see OURTOWN on your Credit Card Statement.',
                      iconClass: 'icon icon-error',
                      duration: 5000
                    })
                  })
                  checkout.teardown(function () {
                    checkout = null
                    postsobj.createHostedFields()
                    postsobj.doingSponsor = false
                    postsobj.sponsorVisible = false
                    postsobj.showSponsorButton = false
                    postsobj.showDidSponsor = true
                  })
                }
              })
            }
          },
          cancelSponsor(){
            this.showSponsorButton = false
            this.doingSponsor = false
          },
          checkImage(item){
            if (typeof item.image !== "undefined") {
              return true
            } else {
              return false
            }
          },
          showMenu(){
            this.menuVisible = !this.menuVisible
          }
        },
        template: `
          <div>
           <router-view />
            <mt-header class="fixedheader" title="OurTown">
              <a slot="left">
                <mt-button slot="left" @click="$router.back()" icon="back">back</mt-button>
              </a>
              <a v-if="!isDesktop" v-on:click="showMenu()" slot="right">
                <img class="headericon" slot="icon" src="file/menu.svg" />
              </a>
            </mt-header>
           <div v-bind:class="{'desktopandmobile':isDesktop}">
            <div v-if="!doingSponsor" class="readertop">
              <!--<img v-if="publicImage !== ''" class="readerimg" :src="'myFile?staged=1&field=publicImage&name=' + publicImage" />-->
              <h5 style="text-align:center;" v-if="!showPostButton" class="public_bio" v-html="publicBio"></h5>
            </div>
            <div id="calendar" ref="calendar" v-bind:class="{'is-hidden':calHidden}"></div>
            <div v-if="shareCal">
              <div v-if="item.isHtml" class="leftfloat calitem" v-for="(item, idx) in items">
                <p v-html="item.title"></p>
              </div>
              
              
            </div>
            <div v-else>
              <!--<img class="groupimg" :src="'grpFile?field=image&name=' + groupPic" />-->

              <mt-cell v-if="shareLinks" class="imagecell public_img" v-for="(item, idx) in items" :title="item.name" is-link :to="item.link">
                <!--
                <div v-if="shareLinks" v-for="(group, idx) in publicGroups">
                <div><img class="grimg" :src="group.image" /><h3>{{group.name}}</h3></div>
                <mt-cell class="imagecell public_img" v-for="(item, iidx) in grouppost[idx]" :title="item.name">-->
                <p class="" v-html="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
                <!--<mt-button v-if="shareLinks" class="caption readstory" @click="linkGo(item.link)">Read Story</mt-button>
                <span v-if="item.isHtml" v-bind:class="{'is-hidden':item.showCommentField}" class="comment" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></span>-->
                <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
                <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
                <div v-if="!item.imageHidden" class="outer">
                  <figcaption class="caption underpic" v-html="item.title"></figcaption>
                  <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
                </div>
                <vue-plyr v-if="item.isVideo">
                  <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                  <figcaption class="caption" v-html="item.title"></figcaption>
                </vue-plyr>
                <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </mt-cell>


              <mt-cell v-if="!shareLinks" class="imagecell public_img" v-for="(item, idx) in items" :title="item.name" is-link :to="item.link">
                <!--<p class="caption">
                  <span v-text="item.author"></span>
                  <img class="headericon" src="file/chevron-right.svg" />
                  <span v-text="item.to"></span>
                </p>-->
                <p class="caption" v-html="item.title"></p>
                <!--<div class="outer">
                  <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                  <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                  <figcaption class="caption underpic" v-html="item.title"></figcaption>
                  <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
                </div>
                <vue-plyr v-if="item.isVideo">
                  <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                  <figcaption class="caption" v-html="item.title"></figcaption>
                </vue-plyr>-->
                <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
            </mt-cell>
            <h3 v-if="showDidSponsor">You are registered! We will contact you to obtain your business logo or photo.</h3>
            <mt-button v-if="showSponsorButton" v-on:click="doRegister()" size="large">Click Here To Register a Business</mt-button>
            <div v-if="doingSponsor">
              <mt-cell :title="sponsorGroupName"></mt-cell>
              <mt-spinner v-bind:class="{'is-hidden':btSpinnerHidden}" type="snake"></mt-spinner>
              <form action="/" method="post" id="cardForm" v-bind:class="{'is-hidden':formHidden}">
                <label class="hosted-fields--label" for="card-number">Card Number</label>
                <div id="card-number" class="hosted-field"></div>
                <label class="hosted-fields--label" for="expiration-date">Expiration Date</label>
                <div id="expiration-date" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">CVV</label>
                <div id="cvv" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">Postal Code</label>
                <div id="postal-code" class="hosted-field"></div>
                <mt-radio v-model="plan" :options="plans"></mt-radio>
                <div class="button-container">
                  <input type="submit" class="button button--small button--green" value="Submit" id="submit"/>
                </div>
                <label class="hosted-fields--label">Cancel any time from the Settings menu</label>
              </form>
            </div>
        
            </div>
            <div class="desktoponly" v-if="isDesktop">
              <mt-cell v-for="(item,idx) in publicGroups" is-link :to="item.grpLink" :title="item.name"><img class="smallmenu" v-if="checkImage(item)" :src="item.image" /></mt-cell>
              <mt-cell v-if="authed" is-link :to="'/myposts/' + grp" title="My Posts"></mt-cell>
              <mt-cell v-if="authed" is-link @click.native="logOut()" title="Sign Out"></mt-cell>
              <mt-button class="create_post_button" v-if="showPostButton" v-on:click="doPost()" size="large">Click here to create a new post in {{name}}</mt-button>
            </div>
            <div v-else>
              <mt-button class="create_post_button" v-if="showPostButton" v-on:click="doPost()" size="medium">Click here to create a new post in {{name}}</mt-button>
            </div>

            <mt-popup v-model="menuVisible" position="middle" class="topmenu publicpagemenu">
              <mt-cell is-link @click.native="showMenu()" title="Close Menu"></mt-cell>
              <mt-cell v-for="(item,idx) in publicGroups" is-link :to="item.grpLink" :title="item.name"><img class="smallmenu" v-if="checkImage(item)" :src="item.image" /></mt-cell>
              <mt-cell v-if="authed" is-link :to="'/myposts/' + grp" title="My Posts"></mt-cell>
              <mt-cell v-if="authed" is-link @click.native="logOut()" title="Sign Out"></mt-cell>
            </mt-popup>
        
            <div style="width:100%;margin-top:100px;margin-bottom:40px;display:inline-block;">
              <div class="postest">
                
            <a href="/#/login/bppuhyny">Login</a>
            |<a href="/#/auth/bppuhyny">Sign Up</a>
                |<a href="/#/pubgroup/jyyktmzx">About Us</a>
              </div>
            </div>
        
          </div>`
      }
      const PublicMyPostsPage = {
        data() {
          return {
            spinnerHidden: true,
            isInstagram: false,
            groupPic: '',
            items: [],
            authed: false,
            name: '',
            showPostButton: false,
            publicLink:'',
            shareCal: false,
            calendar: {},
            calHidden: true
          }
        },
        mounted: function() {
        },
        created() {
          var ua = navigator.userAgent || navigator.vendor || window.opera
          this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            this.groupPic = response.body[2]
            var publicData = JSON.parse(response.body[6])
            this.name = response.body[1]
            if (response.body[3] == 'AUTHED') {
              if (response.body[5] == 'MEMBER') {
              }
              this.authed = true
            } else {
              this.authed = false
            }
            if (parseInt(response.body[8]) > 0) {
              this.showPostButton = true
            }
            this.publicLink = publicData['publicLink']
            if ("undefined" !== typeof publicData['shareCal']) {
              if (parseInt(publicData['shareCal']) > 0) {
                this.shareCal = true
                this.calHidden = false
              }
            }
            if ("undefined" !== typeof publicData['publicName']) {
              Vue.http.get( 'getPosts' + '?mine=1&grp=' + this.$route.params.grp).then( ( response ) => {
                if ( !!response.body ) {
                  if (this.cursor > 0) {
                    if (response.body[0].length < 10) {
                      this.moreHidden = true
                    }
                    for (var j = 0; j < response.body[0].length; j++) {
                      this.items.push(response.body[0][j])
                    }
                  } else {
                    this.items = response.body[0]
                    if (this.items.length > 9) {
                      this.moreHidden = false
                    }
                  }
                }
                this.spinnerHidden = true
              })
              this.spinnerHidden = true
            } else {
            }
          })
        },
        methods: {
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          doPost(){
            if (!this.authed) {
              router.push('/auth/' + this.$route.params.grp)
            } else {
              router.push('/postgroup/' + this.$route.params.grp)
            }
          },
          delPosts(id,idx){
            console.log('id ' + id.toString() + ' and ' + idx.toString())
            this.spinnerHidden = false
            MintUI.MessageBox({
              title: 'Delete',
              message: 'Are you sure you want to delete this post?',
              showCancelButton: true,
              confirmButtonText: 'Confirm Delete',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                Vue.http.post( 'delPosts', {
                  id:id
                }).then( ( response ) => {
                  this.items.splice( idx, 1 )
                  this.spinnerHidden = true
                })
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="OurTown">
              <a slot="left" :href="publicLink">
                <mt-button slot="left" icon="back">back</mt-button>
              </a>
            </mt-header>
            <mt-button v-if="showPostButton" v-on:click="doPost()" size="large">Post in {{name}}</mt-button>
            <div id="calendar" ref="calendar" v-bind:class="{'is-hidden':calHidden}"></div>
            <div v-if="shareCal">
              
            </div>
            <div v-else>
              <!--<img class="groupimg" :src="'grpFile?field=image&name=' + groupPic" />-->
              <mt-cell class="imagecell" v-for="(item, idx) in items" :title="item.name">
                <!--<p class="caption">
                  <span v-text="item.author"></span>
                  <img class="headericon" src="file/chevron-right.svg" />
                  <span v-text="item.to"></span>
                </p>-->
                <p class="caption" v-html="item.title"></p>
                <mt-button class="del_linkpost" size="large" type="danger" v-on:click="delPosts(item.id,idx)">Delete</mt-button>
                <!--<div class="outer">
                  <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                  <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                  <figcaption class="caption underpic" v-html="item.title"></figcaption>
                  <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
                </div>
                <vue-plyr v-if="item.isVideo">
                  <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                  <figcaption class="caption" v-html="item.title"></figcaption>
                </vue-plyr>-->
                <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
            </mt-cell>
          </div>`
      }
      const PublicPostPage = {
        data() {
          return {
            spinnerHidden: true,
            isInstagram: false,
            groupPic: '',
            items: [],
            authed: false,
            name: '',
            title: '',
            image: '',
            uploadTo: 'uploadFile',
            publicInfo: '',
            groupid: 0,
            shareCal: false,
            selector: {
              store: false,
              date: new Date()
            },
            startDate: new Date(),
            dateVal:'',
            timeVal:'',
            dateText: '',
            timeText: '',
            isDesktop: false,
            contactInfo: '',
            contactText: 'Enter your phone number here...',
            menuVisible: false
          }
        },
        created() {
          var ua = navigator.userAgent || navigator.vendor || window.opera
          this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            this.groupPic = response.body[2]
            var publicData = JSON.parse(response.body[6])
            if ("undefined" !== typeof publicData['publicName']) {
              this.publicInfo = publicData['publicBio'].replace("\n","<br>")
            }
            console.log(publicData)
            if ("undefined" !== typeof publicData['shareCal']) {
              if (parseInt(publicData['shareCal']) > 0) {
                this.shareCal = true
                this.contactText = 'Enter your phone number or Web site link here...'
              }
            }
            this.name = response.body[1]
            if (this.name == 'Business Directory') {
              router.push( '/pubgroup/' + this.$route.params.grp )
            }
            if (response.body[3] == 'AUTHED') {
              if (response.body[5] == 'MEMBER') {
              }
              this.authed = true
            } else {
              this.authed = false
            }
            this.groupid = response.body[4]
            if ("undefined" !== typeof publicData['publicName']) {
              Vue.http.get( 'getPosts' + '?grp=' + this.$route.params.grp).then( ( response ) => {
                if ( !!response.body ) {
                  if (this.cursor > 0) {
                    if (response.body[0].length < 10) {
                      this.moreHidden = true
                    }
                    for (var j = 0; j < response.body[0].length; j++) {
                      this.items.push(response.body[0][j])
                    }
                  } else {
                    this.items = response.body[0]
                    if (this.items.length > 9) {
                      this.moreHidden = false
                    }
                  }
                }
                this.spinnerHidden = true
              })
              this.spinnerHidden = true
            } else {
            }
          })
          var check = false;
          (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
          if (check === false) {
            //this.isDesktop = true
          }
        },
        methods: {
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          addPosts(){
            this.spinnerHidden = false
            if (this.contactInfo.substring(0, 2) == '+1') {
              this.contactInfo = this.contactInfo.substring(2)
            }
            if (this.contactInfo.length < 5) {
              MintUI.Toast({
                message: 'Please add contact info. Thank you!',
                iconClass: 'icon icon-error',
                duration: 4000
              })
              this.spinnerHidden = true
              return
            }
            if (!(this.shareCal === true)) {
              if (!(this.contactInfo.match(/\d/g) === null)) {
                if (this.contactInfo.match(/\d/g).length===10) {
                } else {
                  MintUI.Toast({
                    message: 'Please add a 10-digit phone number. Thank you!',
                    iconClass: 'icon icon-error',
                    duration: 4000
                  })
                  this.spinnerHidden = true
                  return
                }
              }
            }
            if (this.title.length > 300) {
              MintUI.Toast({
                message: 'Please revise your post so it has fewer than 300 characters. Thank you!',
                iconClass: 'icon icon-error',
                duration: 4000
              })
              this.spinnerHidden = true
              return
            }
            var postimg = 'myFile?field=image&name=' + this.image
            var evtdate = ''
            var evttime = ''
            if (this.shareCal === true) {
              postimg = 'file/cal.png'
              evtdate = moment(moment.utc(this.dateVal).toDate()).local().format("YYYY-MM-DD")
              evttime = this.timeVal
            }
            Vue.http.post( 'addPosts', {
              recips: JSON.stringify([this.groupid]),
              title: JSON.stringify(['<h1 class="article_hed">' + this.title + ' ' + this.dateText + ' ' + this.timeText + '</h1>' + '<div class="feedimages"><img class="article_img" src="' + postimg + '" alt="Image" /></div>']),
              expirehours: 0,
              speedup: '',
              publicPost: 1,
              eventDate: evtdate,
              eventTime: evttime,
              contactInfo: this.contactInfo,
              timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }).then( ( response ) => {
              this.spinnerHidden = true
              this.title = ''
              MintUI.Toast({
                message: 'Your post was saved',
                iconClass: 'icon icon-success',
                duration: 1000
              })
              router.push('/pubgroup/' + this.$route.params.grp)
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          },
          handleConfirm(){
            
          },
          getFullYear(){
            
          },
          datefilter(){
            
          },
          setDate(){
            this.$refs.picker1.open()
          },
          setTime(){
            this.$refs.picker2.open()
          },
          dateConfirm (data) {
            var monthNames = ["January", "February", "March", "April", "May", "June",
              "July", "August", "September", "October", "November", "December"
            ]
            this.dateVal = data
            var arr1 = this.getDate(this.dateVal).split('-')
            this.dateText = monthNames[this.dateVal.getMonth()] + ' ' + arr1[2] + ', ' + arr1[0]
          },
          timeConfirm (data) {
            this.timeVal = data
            var arr1 = this.timeVal.split(':')
            var ampm = 'a.m.'
            if (parseInt(arr1[0]) > 12) {
              ampm = 'p.m.'
              arr1[0] = (parseInt(arr1[0]) - 12).toString()
            }
            if (parseInt(arr1[0]) == 0) {
              arr1[0] = '12'
            }
            this.timeText = arr1 [0] + ':' + arr1 [1] + ' ' + ampm
          },
          getDate(data) {
            const y = data.getFullYear()
            let m = data.getMonth() + 1
            m = m < 10 ? '0' + m : m
            let d = data.getDate()
            d = d < 10 ? ('0' + d) : d
            return y + '-' + m + '-' + d
          },
          showMenu(){
            this.menuVisible = !this.menuVisible
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="OurTown">
              <a slot="left">
                <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
              </a>
            </mt-header>
            <!--<img class="groupimg" :src="'grpFile?field=image&name=' + groupPic" />-->
            <div v-html="publicInfo"></div>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <div v-if="shareCal">
              <div v-if="!isDesktop">
                <h1>{{dateText}}</h1>
                <mt-datetime-picker
                cancelText="Cancel"
                confirmText="Confirm"
                @confirm="dateConfirm"
                type="date"
                ref="picker1"
                   date-format = "{value}"
                   month-format = "{value}"
                   year-format = "{value}"
                :startDate="startDate"
                v-model="dateVal">
                </mt-datetime-picker>
                <mt-button class="datepicker" v-on:click="setDate()" size="large">Choose Event Date...</mt-button>
                <h1>{{timeText}}</h1>
                <mt-datetime-picker class="datepicker"
                cancelText="Cancel"
                confirmText="Confirm"
                @confirm="timeConfirm"
                type="time"
                ref="picker2"
                v-model="timeVal">
                </mt-datetime-picker>
                <mt-button class="datepicker" v-on:click="setTime()" size="large">Choose Event Time...</mt-button>
                <mt-field placeholder="Write your description here..." type="textarea" rows="14" v-model="title"></mt-field>
                <h1 v-if="title.length > 300">Please shorten your post to fewer than 300 characters, thank you!</h1>
                <mt-cell title="" v-if="image !== ''"><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
                <!--<file-upload btn-label="Click here to upload a photo..." @change="stagedUpload('image')" :url="uploadTo + '?field=image'"></file-upload>-->
                <mt-field v-if="title !== ''" :placeholder="contactText" v-model="contactInfo"></mt-field>
                <mt-button class="create_post_button" v-on:click="addPosts()" size="large">Click here to post this in {{name}}</mt-button>
              </div>
              <div v-else>
                <h4>Please use a mobile device to create your calendar item, desktop/laptop computers are currently not supported. Thank you :-)</h4>
              </div>
            </div>
            <div v-else>
              <mt-field placeholder="Write your description here..." type="textarea" rows="14" v-model="title"></mt-field>
              <h1 v-if="title.length > 300">Please shorten your post to fewer than 300 characters, thank you!</h1>
              <mt-cell title="" v-if="image !== ''"><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
              <file-upload accept="image/*" btn-label="Click here to upload a photo..." @change="stagedUpload('image')" :url="uploadTo + '?field=image'"></file-upload>
              <mt-field v-if="title !== ''" :placeholder="contactText" v-model="contactInfo"></mt-field>
              <mt-button class="create_post_button" v-on:click="addPosts()" size="large">Click here to post this in {{name}}</mt-button>
            </div>
          </div>`
      }
      const GroupPage = {
        data() {
          return {
            grp:'',
            spinnerHidden: false,
            inviteText: ' invited you to join ',
            submitText: '',
            validName: '',
            validContact: '',
            newName: '',
            newContact:'',
            newEmail: '',
            newPhone: '',
            imgHidden: true,
            groupPic: '',
            signupHidden: false,
            ownname: '',
            grpname: '',
            emailstatus: '',
            docodehidden: true,
            code: '',
            signupBtnHidden: false,
            isInstagram: false,
            freq:2,
            interval:'Day',
            helpVisible: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicGroups: [],
            notMember: true,
            memberText: 'You are already a member of ',
            linked: false
          }
        },
        beforeRouteEnter (to, from, next) {
          if (from.path !== '/') {
            next(vm => {
              vm.linked = true
            })
          } else {
            next()
          }
        },
        props: {},
        created() {
          var ua = navigator.userAgent || navigator.vendor || window.opera
          this.isInstagram = (ua.indexOf('Instagram') > -1) ? true : false
          this.spinnerHidden = false
          Vue.http.post( 'joinGroup', {
            grp:this.$route.params.grp
          }).then( ( response ) => {
            if (response.body[3] == 'AUTHED') {
              this.signupHidden = true
              this.signupBtnHidden = false
              if (response.body[5] == 'MEMBER') {
                //window.location.href = '/'
                this.notMember = false
              }
            } else {
              this.signupHidden = false
              this.signupBtnHidden = false
            }
            this.ownname = response.body[0]
            this.grpname = response.body[1]
            this.inviteText = response.body[0] + this.inviteText + response.body[1]
            this.memberText = this.memberText + response.body[1]
            this.submitText = 'Join ' + response.body[0] + "'s Gallery"
            if (parseInt(response.body[7]) > 0) {
              this.submitText = 'Join ' + response.body[0] + "'s Group"
            } 
            this.groupPic = response.body[2]
            this.imgHidden = false
            this.spinnerHidden = true
            var publicData = JSON.parse(response.body[6])
            if ("undefined" !== typeof publicData['publicName']) {
              this.publicName = publicData['publicName']
              this.publicBio = publicData['publicBio']
              this.publicLink = publicData['publicLink']
              this.publicImage = publicData['publicImage']
              this.publicGroups = publicData['publicGroups']
            }
          })
        },
        methods: {
          doCode() {
            this.spinnerHidden = false
            Vue.http.post( 'freeTrialStart', {
              code : this.code,
              grp : this.$route.params.grp,
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone
            }).then( ( response ) => {
              if (response.body[0] == 'OK') {
                this.spinnerHidden = false
                Vue.http.post( 'setGroupNotif', {
                  grp : this.$route.params.grp,
                  freq : this.freq,
                  interval : this.interval
                }).then( ( response ) => {
                  window.location.href = '/'
                })
              } else {
                alert('Sorry, the code did not match')
              }
            })
          },
          doJoin() {
            if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newContact).toLowerCase())) {
                this.validContact = "success"
                this.newEmail = this.newContact
              }
            } else {
              if (this.newContact.substring(0, 2) == '+1') {
                this.newContact = this.newContact.substring(2)
              }
              if (!(this.newContact.match(/\d/g) === null)) {
                if (this.newContact.match(/\d/g).length===10) {
                  this.validContact = "success"
                  this.newPhone = this.newContact
                }
              }
            }
            if (!this.signupHidden) {
              if (this.validContact !== "success"){
                MintUI.Toast({
                  message: 'Please enter a valid phone number or email address',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                return
              }
            }
            if (!this.signupHidden) {
              if (this.newContact.length == 0) {
                MintUI.Toast({
                  message: 'Please enter a phone number or email address',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                return
              }
            }
            if (!this.signupHidden) {
              if (this.newName.length == 0) {
                MintUI.Toast({
                  message: 'Please enter your name',
                  iconClass: 'icon icon-error',
                  duration: 2000
                })
                return
              }
            }
            this.spinnerHidden = false
            this.inviteText = ''
            this.docodehidden = false
            if (this.signupHidden) {
              Vue.http.post( 'doJoin', {
                grp : this.$route.params.grp,
                name : this.newName,
                email : this.newEmail,
                phone : this.newPhone
              }).then( ( response ) => {
                if (response.body[0] == 'error') {
                  MintUI.Toast({
                    message: 'Error',
                    iconClass: 'icon icon-error',
                    duration: 2000
                  })
                  return
                }
                this.spinnerHidden = false
                Vue.http.post( 'setGroupNotif', {
                  grp : this.$route.params.grp,
                  freq : this.freq,
                  interval : this.interval
                }).then( ( response ) => {
                  MintUI.Toast({
                    message: 'You have been added to the gallery',
                    iconClass: 'icon icon-success',
                    duration: 2000
                  })
                  this.spinnerHidden = true
                  router.push('/')
                })
              })
            } else if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newEmail).toLowerCase())) {
                Vue.http.post( 'doJoin', {
                  grp : this.$route.params.grp,
                  name : this.newName,
                  email : this.newEmail,
                  phone : this.newPhone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inviteText = 'A code was just sent to your email address'
                  this.spinnerHidden = true
                  this.signupHidden = true
                  this.signupBtnHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            } else {
              if (this.newContact.match(/\d/g).length===10) {
                Vue.http.post( 'doJoin', {
                  grp : this.$route.params.grp,
                  name : this.newName,
                  email : this.newEmail,
                  phone : this.newPhone
                }).then( ( response ) => {
                  if (response.body[0] == 'error') {
                    MintUI.Toast({
                      message: 'Error',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                    return
                  }
                  this.inviteText = 'A code was just sent to your phone'
                  this.spinnerHidden = true
                  this.signupHidden = true
                  this.signupBtnHidden = true
                })
              } else {
                this.emailstatus = 'error'
              }
            }
          },
          checkConName() {
            this.validName = "success"
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
              var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (re.test(String(this.newContact).toLowerCase())) {
                this.validContact = "success"
                this.newEmail = this.newContact
              } else {
                this.validContact = "error"
              }
            } else {
              if (this.newContact.substring(0, 2) == '+1') {
                this.newContact = this.newContact.substring(2)
              }
              if (!(this.newContact.match(/\d/g) === null))
                if (this.newContact.match(/\d/g).length===10) {
                  this.validContact = "success"
                  this.newPhone = this.newContact
                } else {
                  this.validContact = "error"
                }
            }
          },
          showHelp() {
            this.helpVisible = true
          },
          closeHelp(){
            this.helpVisible = false
          },
          doContinue(){
            window.location.href = '/'
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <a v-if="linked" slot="left">
                <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
              </a>
              <a v-else href="/" slot="left">
                <img class="headericon" slot="icon" src="file/home.svg" />
              </a>
              <a v-on:click="showHelp()" slot="right">
                <img class="headericon" slot="icon" src="file/help-circle.svg" />
              </a>
            </mt-header>
            <img v-bind:class="{'is-hidden':imgHidden}" class="groupimg" :src="groupPic" />
            <mt-cell v-if="notMember" :title="inviteText"></mt-cell>
            <div v-if="isInstagram">
              <h3>You're almost there!</h3>
              <p>It looks like you're using Instagram's built-in Web browser.</p>
              <p>Please click "..." at top-right and then click "Open in Safari" (Or use any mobile web browser)</p>
            </div>
            <div v-else>
              <div v-if="notMember">
                <mt-field v-bind:class="{'is-hidden':signupHidden}" :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
                <mt-field v-bind:class="{'is-hidden':signupHidden}" :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
                <div v-bind:class="{'is-hidden':signupBtnHidden}" class="joinnotif">
                  <h5 v-text="'Notifications Limit: ' + freq + ' per ' + interval"></h5>
                  <mt-radio
                    v-model="interval"
                    :options="['Day', 'Week']">
                  </mt-radio>
                  <mt-range class="freqrange"
                    v-model="freq"
                    :min="1"
                    :max="10"
                    :step="1"
                    :bar-height="5">
                    <div slot="start">1</div>
                    <div slot="end">10</div>
                  </mt-range>
                </div>
                <mt-button class="joinbutton" v-bind:class="{'is-hidden':signupBtnHidden}" v-on:click="doJoin()" size="large">{{submitText}}</mt-button>
                <mt-field v-bind:class="{'is-hidden':docodehidden}" class="codeinput" type="number" label="Code:" placeholder="***" v-model="code"></mt-field>
                <mt-button v-bind:class="{'is-hidden':docodehidden}" v-on:click="doCode()" size="large">Submit Code</mt-button>
                <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
              </div>
              <div v-if="!notMember">
                <mt-cell :title="memberText"></mt-cell>
                <mt-button v-on:click="doContinue()" size="large">Continue</mt-button>
              </div>
            </div>
            <mt-popup class="help_popup" v-model="helpVisible" position="middle">
              <mt-header>
                <a v-on:click="closeHelp()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <h4 class="help_header">What is this?</h4>
              <p class="help_para">RP.LY is a new kind of digital photo gallery that helps photographers offer an expanded set of images.</p>
            </mt-popup>
          </div>`
      }
      const listPosts = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean, cangrps : Array, moreHidden: Boolean, doSponsor: Object },
        created() {
          if (this.items.length == 0) {
            this.moreHidden = true
          }
        },
        methods: {
          openImage(idx){
            if (typeof this.items[idx].link !== 'undefined') {
              window.location.href = this.items[idx].link
              return
            }
            if (this.items[idx].isOwner) {
              //router.push( '/showPosts/' + idx )
            }
          },
          showLink(){
            this.$emit('on-show-menu')
          },
          showHelp(){
            this.$emit('on-show-help')
          },
          delPosts( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delPosts', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          doContextMenu(e){
            e.preventDefault()
          },
          showMore(){
            this.spinnerHidden = false
            this.moreHidden = true
            this.$emit('load-more-items')
            this.spinnerHidden = true
          },
          showSponsor(grp) {
            this.$emit('update:doSponsor', grp)
            this.$emit('show-sponsor')
          },
          addComment(idx) {
            this.items[idx].showCommentField = true
          },
          saveComment(post,idx) {
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips: post.groups,
              title: JSON.stringify([post.comment]),
              inreplyto: post.id,
              expirehours: 0,
              speedup: ''
            }).then( ( response ) => {
              this.items[idx].comment = ''
              this.spinnerHidden = true
              this.items[idx].showCommentField = false
              MintUI.Toast({
                message: 'Comment Saved',
                iconClass: 'icon icon-success',
                duration: 1000
              })
            })
          },
          openGall(toid){
            router.push( '/showGroupPosts/' + toid )
          },
          newGall(){
            router.push('/groups/new')
          },
          shareGall(grps,title){
            Vue.http.post( 'getShare', {
              recips:grps,
            }).then( ( response ) => {
              if ( !!response.body ) {
                this.$emit('update:groupLink', title + ' ' + response.body)
                this.$emit('show-share-group')
              }
            })
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="Rp.ly">
              <a v-on:click="showHelp()" slot="left">
                <img class="headericon" slot="icon" src="file/help-circle.svg" />
              </a>
              <!--<a v-on:click="newGall()" slot="right">
                <img class="headericon secondtool" slot="icon" src="file/list.svg" />
              </a>-->
              <a v-on:click="showLink()" slot="right">
                <img class="headericon" slot="icon" src="file/settings.svg" />
              </a>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell class="imagecell leftfloat" v-for="(item, idx) in items" :title="item.name">
              <p class="caption">
                <span v-text="item.author"></span>
                <img v-if="!item.isHtml" class="headericon" src="file/chevron-right.svg" />
                <span v-text="item.to"></span>
                <!--<mt-button v-if="!item.isHtml" v-on:click="openGall(item.toid)"><img src="file/list.svg" /></mt-button>-->
                <mt-button v-if="item.isOwner" v-on:click="shareGall(item.groups,item.title)"><img src="file/share.svg" /></mt-button>
              </p>
              <div v-if="item.isHtml" v-bind:class="{'is-hidden':item.textHidden}" class="leftfloat">
                <p v-if="item.flagged" class="caption is-flagged" v-html="item.title"></p>
                <p v-else class="caption is-linked" v-on:click="openImage(idx)" v-html="item.title"></p>
              </div>
              <div v-else v-bind:class="{'is-hidden':item.textHidden}">
                <p class="caption" v-on:click="openImage(idx)" v-html="item.title"></p>
              </div>
              <div class="outer" v-on:click="openImage(idx)" v-bind:class="{'is-hidden':item.imageHidden}">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-html="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption vidcaption" v-html="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              <p class="caption" v-for="(comm, cidx) in item.comments" v-text="comm.author + ': ' + comm.title"></p>
              <p v-if="!item.isHtml" v-bind:class="{'is-hidden':item.showCommentField}" class="caption" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></p>
              <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
              <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
            </mt-cell>
            <mt-button v-bind:class="{'is-hidden':moreHidden}" size="large" v-on:click="showMore()">Load More</mt-button>
            <mt-cell v-for="grp in cangrps" :title="'Would you like to see every post by ' + grp.guser + ' in ' + grp.gname + '?'"><mt-button type="primary" size="small" v-on:click="showSponsor(grp)">Become a Sponsor</mt-button></mt-cell>
          </div>`
      }
      const showGroupPosts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            moreHidden: true,
            cursor: 0,
            prevcursor: 0,
            cogHidden: true,
            groups: [],
            shareLinks: false,
            shareCal: false
          }
        },
        props: { posts : Array, selected: String, postto: Array },
        created() {
          this.posts = []
          this.loadPosts()
        },
        methods: {
          editPost(post,idx) {
            router.push( '/modLinkPost/' + post.id )
          },
          loadPosts(){
            if (this.cursor > 0 && (this.prevcursor === this.cursor)) {
              
            } else if (typeof this.$route.params.grpid !== "undefined") {
              this.spinnerHidden = false
              this.prevcursor = this.cursor
              Vue.http.get( 'getPosts' + '?grpid=' + this.$route.params.grpid + '&cursor=' + this.cursor.toString()).then( ( response ) => {
                if ( !!response.body ) {
                  if (this.cursor > 0) {
                    if (response.body[0].length < 10) {
                      this.moreHidden = true
                    }
                    for (var j = 0; j < response.body[0].length; j++) {
                      this.posts.push(response.body[0][j])
                    }
                    this.moreHidden = false
                  } else {
                    this.posts = response.body[0]
                    this.groups = response.body[1]
                    if (this.posts.length > 9) {
                      this.moreHidden = false
                    }
                    this.shareLinks = false
                    this.linkgroups = []

                    Vue.http.get( 'getGroups').then( ( response ) => {
                      if ( !!response.body ) {
                        this.groups = response.body[0]
                        for (var i = 0; i < this.groups.length; i++) {
                          if (parseInt(this.groups[i].id) == parseInt(this.$route.params.grpid)) {
                            this.cogHidden = !this.groups[i].isOwner
                            if (parseInt(this.groups[i].shareLinks) > 0) {
                              this.shareLinks = true
                            }
                            if (parseInt(this.groups[i].shareCal) > 0) {
                              this.shareCal = true
                            }
                          }
                        }
                      }
                    })

                    //if (this.items[idx].isOwner) {
                      //router.push( '/showPosts/' + idx )
                      //}
                    
                  }
                }
                this.spinnerHidden = true
                this.$emit('update:posts', this.posts)
              })
            }
          },
          openImage(idx){
            if (this.posts[idx].isOwner) {
              router.push( '/showPosts/' + idx )
            }
          },
          imageLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=image&name=' + item.image
            }
          },
          videoLink(item){
            if ("undefined" !== typeof item.media) {
              return item.media
            } else {
              return 'myFile?field=video&name=' + item.video
            }
          },
          showMore(){
            this.cursor = this.posts.length
            this.loadPosts()
          },
          addComment(idx) {
            this.posts[idx].showCommentField = true
          },
          saveComment(post,idx) {
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips: post.groups,
              title: JSON.stringify([post.comment]),
              inreplyto: post.id,
              expirehours: 0,
              speedup: ''
            }).then( ( response ) => {
              this.posts[idx].comment = ''
              this.spinnerHidden = true
              this.posts[idx].showCommentField = false
              MintUI.Toast({
                message: 'Comment Saved',
                iconClass: 'icon icon-success',
                duration: 1000
              })
            })
          },
          loadMore(){
            this.loading = true
            setTimeout(() => {
              this.cursor = this.posts.length
              this.loadPosts()
              this.loading = false
            }, 2500)
          },
          gallSett(){
            router.push('/groups/' + this.$route.params.grpid)
          },
          newGall(){
            router.push('/groups/new')
          },
          addToGallery(){
            for (var i = 0; i < this.groups.length; i++) {
              if (parseInt(this.groups[i].id) == parseInt(this.$route.params.grpid)) {
                this.$emit('update:postto', [this.groups[i].id])
              }
            }
            this.$emit('update:selected', 'tab2')
            this.$emit('on-show-back')
            router.push('/')
          },
          gallEmbed(){
            for (var i = 0; i < this.groups.length; i++) {
              if (parseInt(this.groups[i].id) == parseInt(this.$route.params.grpid)) {
                window.location.href = 'https://rp.ly/getGroupEmbed?grp=' + this.groups[i].key
                break
              }
            }
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="Rp.ly">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
              <!--<a v-if="!cogHidden" v-on:click="gallEmbed()" slot="right">
                <img class="headericon codeinput" slot="icon" src="file/code.svg" />
              </a>-->
              <a v-if="!cogHidden" v-on:click="gallSett()" slot="right">
                <img class="headericon" slot="icon" src="file/settings.svg" />
              </a>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>

            <mt-cell v-infinite-scroll="loadMore"
                infinite-scroll-disabled="loading"
                infinite-scroll-distance="0"
                class="imagecell"
                v-for="(item, idx) in posts"
                :title="item.name">
              <p class="caption" v-on:click="openImage(idx)" v-html="item.title" v-bind:class="{'is-hidden':item.textHidden}"></p>
              <div class="outer" v-on:click="openImage(idx)" v-bind:class="{'is-hidden':item.imageHidden}">
                <img class="oimg" :src="imageLink(item)" v-if="item.allowDownload" />
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="imageLink(item)" v-else />
                <figcaption class="caption underpic" v-html="item.title"></figcaption>
                <audio-player :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              </div>
              <vue-plyr v-if="item.isVideo">
                <video :poster="item.image" :src="videoLink(item)" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                <figcaption class="caption" v-on:click="openImage(idx)" v-html="item.title"></figcaption>
              </vue-plyr>
              <audio-player v-if="item.imageHidden" :src="'myFile?field=sound&name=' + item.sound" v-bind:class="{'is-hidden':item.soundHidden}" />
              <p class="caption" v-for="(comm, cidx) in item.comments" v-text="comm.author + ': ' + comm.title"></p>
              <p v-bind:class="{'is-hidden':item.showCommentField}" class="caption" v-on:click="addComment(idx)"><img class="comment" slot="icon" src="file/message-square.svg" /></p>
              <mt-field v-bind:class="{'is-hidden':!item.showCommentField}" placeholder="Comment..." v-model="item.comment"></mt-field>
              <mt-button v-bind:class="{'is-hidden':!item.showCommentField}" size="large" v-on:click="saveComment(item,idx)">Save Comment</mt-button>
              <mt-button v-if="shareLinks" size="large" v-on:click="editPost(item,idx)">Edit Post</mt-button>
              
              <mt-button v-if="shareCal" size="large" v-on:click="editPost(item,idx)">Edit Post</mt-button>
            </mt-cell>
            <mt-button v-if="!cogHidden" size="large" v-on:click="addToGallery()"><img slot="icon" src="/file/plus-circle.svg" /></mt-button>
          </div>`
      }
      const showPost = {
        data() {
          return {
            spinnerHidden : true,
            idx: 0,
            id : this.$route.params.postid,
            title : '',
            image : '',
            sound : '',
            soundHidden : false,
            imageHidden : false,
            post: {},
            body: '',
            authed: false,
            flagged: false,
            flagtxt: 'Flag this post as inappropriate',
            contact: ''
          }
        },
        props: {},
        created() {
          this.setData()
        },
        methods: {
          setData(){
            Vue.http.post( 'getPost', {
              postid:this.id
            }).then( ( response ) => {
              if (response.body.length > 0) {

                this.post = response.body[0]
                this.title = this.post.title
                this.image = this.post.image
                this.sound = this.post.sound
                this.body = this.post.body
                this.contact = this.post.contact
                this.imageHidden = true
                
                if (response.body[1] == 'AUTHED') {
                  this.authed = true
                }
  
              }
              
              /*
              if (this.sound == '') {
                this.soundHidden = true
              }
              if (this.image == '') {
                this.imageHidden = true
              }
              this.$emit('on-tabs-hidden')
*/

            })
            
            
          },
          delPosts(){
          },
          doContextMenu(e){
            e.preventDefault()
          },
          flagPosts(){
            if (!this.authed) {
              router.push('/authpost/' + this.$route.params.postid)
            } else {
              MintUI.Indicator.open({
                text: 'Saving...',
                spinnerType: 'fading-circle'
              })
              Vue.http.post( 'addPosts', {
                recips: this.post.groups,
                title: JSON.stringify(['Flag']),
                inreplyto: '',
                flagpost: this.id,
                expirehours: 0,
                speedup: ''
              }).then( ( response ) => {
                this.flagged = true
                this.flagtxt = 'Flagged'
                MintUI.Indicator.close()
              })
            }
          }
        },
        template: `
          <div>
            <mt-header title="OurTown">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell v-if="!imageHidden">
              <div class="outer">
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="'myFile?field=image&name=' + image" />
                <div class="overlay">
                  <p class="text">&nbsp;</p>
                </div>
              </div>
            </mt-cell>
            <mt-cell> <p v-html="title"></p></mt-cell>
            <mt-cell> <p v-html="body"></p></mt-cell>
            <mt-cell v-if="contact !== ''"> Contact: <p v-html="contact"></p></mt-cell>
        
            <!--<mt-cell v-bind:class="{'is-hidden':soundHidden}"><audio-player :src="'myFile?field=sound&name=' + sound" /></mt-cell>
            <mt-button size="large" v-on:click="delPosts()">Delete Photo</mt-button>-->
            <mt-button size="large" v-on:click="flagPosts()" :disabled="flagged">{{flagtxt}}</mt-button>

          </div>`
      }
      const showPosts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            title : '',
            image : '',
            sound : '',
            soundHidden : false,
            imageHidden : false
          }
        },
        props: { posts : Array },
        created() {
          if (this.posts.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.posts[ this.idx ].id
            this.title = this.posts[ this.idx ].title
            this.image = this.posts[ this.idx ].image
            this.sound = this.posts[ this.idx ].sound
            if (this.sound == '') {
              this.soundHidden = true
            }
            if (this.image == '') {
              this.imageHidden = true
            }
            this.$emit('on-tabs-hidden')
          },
          delPosts(){
            var showposts = this
            MintUI.MessageBox({
              title: 'Delete',
              message: 'Are you sure you want to delete this post?',
              showCancelButton: true,
              confirmButtonText: 'Confirm Delete',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                showposts.spinnerHidden = false
                Vue.http.post( 'delPosts', {
                  id:showposts.id
                }).then( ( response ) => {
                  showposts.spinnerHidden = true
                  showposts.posts.splice( showposts.idx, 1 )
                  this.$emit('on-update-list')
                  router.push('/')
                })
              }
            })

          },
          doContextMenu(e){
            e.preventDefault()
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell  :title="title"></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':imageHidden}">
              <div class="outer">
                <img @contextmenu.prevent="doContextMenu" class="oimg cant-click" :src="'myFile?field=image&name=' + image" />
                <div class="overlay">
                  <p class="text">&nbsp;</p>
                </div>
              </div>
            </mt-cell>
            <mt-cell v-bind:class="{'is-hidden':soundHidden}"><audio-player :src="'myFile?field=sound&name=' + sound" /></mt-cell>
            <mt-button size="large" v-on:click="delPosts()">Delete Photo</mt-button>

          </div>`
      }
      const modLinkPost = {
        components: {
          VueEditor
        },
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            id : 0,
            title : '',
            image : '',
            sound : '',
            body: '',
            link: ''
          }
        },
        props: { posts : Array, selected: String, postto: Array },
        created() {
          this.id = this.$route.params.id
          for (var j = 0; j < this.posts.length; j++) {
            if (parseInt(this.posts[j].id) === parseInt(this.id)) {
              this.title = this.posts[j].title
              this.image = this.posts[j].image
              this.body = this.posts[j].body
              this.link = this.posts[j].link
            }
          }
        },
        methods: {
          modPosts(){
            this.spinnerHidden = false
            Vue.http.post( 'modPosts', {
              id : this.id,
              title : this.title,
              body : this.body,
              link : this.link
            }).then( ( response ) => {
              router.back()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          },
          delPosts(){
            MintUI.MessageBox({
              title: 'Delete',
              message: 'Are you sure you want to delete this post?',
              showCancelButton: true,
              confirmButtonText: 'Confirm Delete',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                Vue.http.post( 'delPosts', {
                  id:this.id
                }).then( ( response ) => {
                  router.back()
                })
              }
            })
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="Rp.ly">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell><vue-editor v-model="title"></vue-editor></mt-cell>
            <!--<mt-field placeholder="Story..." type="textarea" rows="10" v-model="title"></mt-field>-->
            <mt-cell><vue-editor v-model="body"></vue-editor></mt-cell>
            <!--<mt-field placeholder="Story..." type="textarea" rows="20" v-model="body"></mt-field>-->
            <mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
            <file-upload accept="image/*" btn-label="Image" @change="stagedUpload('image')" :url="uploadTo + '&field=image'"></file-upload>
            <!--<mt-cell title="Sound:"><audio-player :src="'myFile?staged=1&field=sound&name=' + sound" /></mt-cell>
            <audio-recorder :upload-url="uploadTo + '&field=sound'"/>-->
            <mt-field placeholder="Link..." type="text" v-model="link"></mt-field>
            <mt-button v-on:click="modPosts()" size="large">Save</mt-button>
            <mt-button class="del_linkpost" size="large" type="danger" v-on:click="delPosts()">Delete</mt-button>
          </div>`
      }
      const modPosts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            title : '',
            image : '',
            sound : ''
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.title = this.items[ this.idx ].title
          this.image = this.items[ this.idx ].image
          this.sound = this.items[ this.idx ].sound

          this.$emit('on-tabs-hidden')
        },
        methods: {
          modPosts(){
            this.spinnerHidden = false
            Vue.http.post( 'modPosts', {
              id : this.id,
              title : this.title
            }).then( ( response ) => {
              this.$emit('on-update-list')
              router.push( '/' )
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <router-link :to="'/showPosts/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Title:" placeholder="Title.." v-model="title"></mt-field>
            <mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
            <file-upload accept="image/*" btn-label="Image" @change="stagedUpload('image')" :url="uploadTo + '&field=image'"></file-upload>
            <mt-cell title="Sound:"><audio-player :src="'myFile?staged=1&field=sound&name=' + sound" /></mt-cell>
            <audio-recorder :upload-url="uploadTo + '&field=sound'"/>
            <mt-button v-on:click="modPosts()" size="large">Save</mt-button>
          </div>`
      }
      const Posts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadMulti',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            title : [],
            image : '',
            cgroups:[{id:1,user_id:1,name:'Admins',perms:[],members:[]},{id:2,user_id:1,name:'Group 2',perms:[],members:[]},{id:3,user_id:1,name:'Group 3',perms:[],members:[]}],
            contacts:[{id:1,user_id:1,name:'Me',email:'',phone:'',groups:[1,2,3]}],
            lastgroups : [],
            saveHidden: false,
            uploadHidden: false,
            imgHidden: true,
            linkVisible: false,
            feedsVisible: false,
            feedLink: '',
            addFeed: '',
            feeds: [],
            textHidden: true,
            audioHidden: false,
            showAddContact: false,
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            doExpire: false,
            expireHours: '24',
            optionsBtnHidden: false,
            optionsHidden: true,
            sponsorVisible: false,
            subs: [],
            btAuth: '',
            plan: 'fans50',
            plans:[{label: '$3 twice-a-year',value: 'fans50'},{label: '$3 monthly',value: 'fans300'}],
            cangrps: [],
            sponsorGroup: '',
            sponsorGroupName: '',
            btLoaded:false,
            formHidden: true,
            btSpinnerHidden:false,
            subsVisible: false,
            subsHidden: true,
            settingsSpinnerHidden:true,
            uploadedFiles: [],
            uploadError: null,
            currentStatus: null,
            uploadFieldName: 'photos',
            speedup: '1.1',
            cursor: 0,
            moreHidden: true,
            doSponsor: {},
            noSubsTxt: 'No subscriptions',
            helpVisible: false,
            help1: false,
            help2: false,
            help3: false,
            help4: false,
            help5: false,
            help6: false,
            help7: false,
            help8: false,
            gettingStarted:false,
            template1: 'I\'m using RP.LY to share an expanded photo selection with those who join my gallery for (occasional) email or text message notifications. Click link in bio to join my new gallery.',
            template2: 'I\'m using RP.LY to share an expanded photo selection with those who join my gallery for (occasional) email or text message notifications. Click this link to join my new gallery.',
            following: [],
            mbshpsHidden: false,
            doSetHeader: [],
            posts: [],
            showShareGroup: false,
            showFirst: false,
            groupLink: '',
            startMode: '',
            startstep: 'starttab1',
            timers:[],
            findFeeds:'',
            foundFeeds:[],
            findDisabled:false,
            findSpinnerHidden:true,
            findMessageHidden:true,
            uploadXmlTo : 'uploadFile',
            feedmeta : [],
            feedslist: [],
            showPublicVid: false,
            showPrivateVid: false,
            sharingGroup:'',
            sharingImg:'',
            shareLinks:false,
            showShareLink:false,
            shareLinkUrl:'',
            linkgroups:[],
            showStartControls:true,
            showBackToGallery: false,
            newGallery: false,
            newGalleryName: '',
            textpost: '',
            headline: ''
          }
        },
        components:{
          'show-posts' : showPosts,
          'vue-editor' : VueEditor
        },
        computed: {
          isInitial() {
            return this.currentStatus === STATUS_INITIAL
          },
          isSaving() {
            return this.currentStatus === STATUS_SAVING
          },
          isSuccess() {
            return this.currentStatus === STATUS_SUCCESS
          },
          isFailed() {
            return this.currentStatus === STATUS_FAILED
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        created() {
          if (this.$route.path.substring(1) == 'tab2'){
            this.selected = 'tab2'
          }
          if (this.$route.path.substring(1) == 'tab3'){
            this.selected = 'tab3'
          }
          if (!(window.location.href.match(/\/post\//g) === null)) {
            var post = window.location.pathname.substr(window.location.pathname.lastIndexOf('/') + 1)
            window.location.href = 'https://' + window.location.hostname + '/#/showPost/' + post
            return
          }
          
          if (!(window.location.href.match(/\/grp\//g) === null)) {
            var grp = window.location.pathname.substr(window.location.pathname.lastIndexOf('/') + 1)
            window.location.href = 'https://' + window.location.hostname + '/#/group/' + grp
            return
          }
          if ('postid' in this.$route.params) {
            this.tabsHidden = true
            return
          } else {
            this.tabsHidden = false
          }
          Vue.http.get('isAuthed').then((response) => {
            if(parseInt(response.body) != 1) {
              router.push('auth')
            } else {
              this.getPosts()
              this.getContacts()
              this.getSettings()
            }
          })
          if (typeof braintree !== "undefined") {
            this.subsHidden = false
          }
        },
        methods: {
          closeSponsor() {
            this.sponsorVisible = !this.sponsorVisible
          },
          showOptions() {
            this.optionsBtnHidden = true
            this.optionsHidden = false
          },
          onExpireChange(){
            //this.doExpire = !this.doExpire
          },
          showSubs() {
            if (typeof braintree !== "undefined") {
              this.settingsSpinnerHidden = false
              Vue.http.post( 'btSubs', {
              }).then( ( response ) => {
                this.linkVisible = false
                if (response.body[0].length > 0) {
                  this.subs = response.body[0]
                  this.noSubsTxt = ''
                }
                this.settingsSpinnerHidden = true
                this.subsVisible = true
              })
            }
          },
          showLink() {
            this.linkVisible = true
          },
          showHelp() {
            this.helpVisible = true
          },
          aftRec(data){
            MintUI.Toast({
              message: 'Click - Record 1 - and then click the floppy disk',
              iconClass: 'icon icon-success',
              duration: 4000
            })
          },
          getSettings() {
            Vue.http.get( 'getSettings').then( ( response ) => {
              if ( !!response.body ) {
                this.feedLink = response.body.feedLink
                this.feeds = JSON.parse(response.body.feedSubs)
                if (typeof response.body.filterDisabled !== 'undefined') {
                  this.feedmeta = JSON.parse(response.body.filterDisabled)
                }
                this.setFeeds()
              }
            })
          },
          setFeeds(){
            this.feedslist = []
            for (var i = 0; i < this.feeds.length; i++) {
              var aisett = true
              for (var j = 0; j < this.feedmeta.length; j++) {
                if (this.feedmeta[j] == this.feeds[i]) {
                  aisett = false
                }
              }
              this.feedslist.push({src:this.feeds[i],ai:aisett})
            }
          },
          getContacts() {
            Vue.http.get( 'getContacts').then( ( response ) => {
              if ( !!response.body ) {
                this.contacts = response.body[0]
                this.reloadGroups()
                if (this.contacts.length === 0) {
                  this.mbshpsHidden = true
                }
              }
            })
            Vue.http.get( 'getGroups').then( ( response ) => {
              if ( !!response.body ) {
                this.cgroups = response.body[0]
                this.reloadGroups()
                if (this.cgroups[this.cgroups.length - 1].name == 'My Photos') {
                  //this.gettingStarted = true
                  /*
                  MintUI.MessageBox({
                    title: 'Looks like you are new here',
                    message: 'Would you like to set up your first photo gallery?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes take me there',
                    cancelButtonText: 'No thanks'
                  }).then(action => {
                    if (action === 'confirm') {
                      router.push( 'groups' )
                    }
                  })*/
                } else {
                  //this.gettingStarted = false
                  var check = false;
                  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
                  if (check === false) {
                    /*
                    MintUI.Toast({
                      message: 'Desktop computer detected - if you need to Add Photos, we suggest you use a mobile device',
                      iconClass: 'icon icon-success',
                      duration: 3000
                    })*/
                  }
                }
              }
            })
          },
          reloadGroups() {
            this.lastgroups = []
            for (var i = 0; i < this.cgroups.length; i++) {
              this.cgroups[i].members = []
              this.cgroups[i].perms = []
              for (var j = 0; j < this.contacts.length; j++) {
                this.lastgroups.push([])
                if (this.contacts[j].groups.indexOf(this.cgroups[i].id) > -1) {
                  this.cgroups[i].members.push(this.contacts[j].id)
                  this.lastgroups[j].push(this.cgroups[i].id)
                }
                this.cgroups[i].perms.push({label: ' ',value: this.contacts[j].id})
              }
            }
          },
          cometAdd(item) {
            if (item.inreplyto.length > 0) {
              for (var j = 0; j < this.items.length; j++) {
                if (parseInt(this.items[j].id) === parseInt(item.inreplyto)) {
                  this.items[j].comments.unshift(item)
                }
              }
            } else {
              this.items.unshift(item)
            }
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getPosts() {
            this.spinnerHidden = false
            Vue.http.get( 'getPosts' + '?cursor=' + this.cursor.toString()).then( ( response ) => {
              if ( !!response.body ) {
                if (this.cursor > 0) {
                  if (response.body[0].length < 10) {
                    this.moreHidden = true
                  }
                  for (var j = 0; j < response.body[0].length; j++) {
                    this.items.push(response.body[0][j])
                  }
                } else {
                  this.items = response.body[0]
                  if (this.items.length > 9) {
                    this.moreHidden = false
                  }
                  if (this.items.length == 0) {
                    this.showFirst = true
                    this.gettingStarted = true
                  }
                }
                this.groups = response.body[1]
                this.shareLinks = false
                this.linkgroups = []
                for (var j = 0; j < this.groups.length; j++) {
                  if (parseInt(this.groups[j].links) > 0) {
                    this.shareLinks = true
                    this.linkgroups.push(this.groups[j])
                  }
                }
                this.abilities = response.body[2]
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                } else {
                  this.groupsHidden = false
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rply/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
                if (typeof braintree !== "undefined") {
                  if (this.cangrps.length == 0) {
                    for (var j = 0; j < response.body[4].length; j++) {
                      var grid = response.body[4][j]
                      Vue.http.post( 'joinGroup', {
                        grp:grid
                      }).then( ( response ) => {
                        this.cangrps.push({gname:response.body[1] + '',glink:response.body[4],guser:response.body[0]})
                      })
                    }
                  }
                }
                this.following = response.body[5]
                for (var i = 0; i < this.items.length; i++) {
                  this.timers[i] = setTimeout(function (app, i) {
                    if (typeof app.items[i].link !== 'undefined') {
                      if (app.items[i].flagged == true) {
                        console.log('CHECKING A.I. ' + app.items[i].link)
                        app.items[i].spinnerHidden = false
                        Vue.http.post('moderationFlag', {
                          link:app.items[i].link
                        }).then((response) => {
                          if (!!response.body) {
                            if (parseInt(response.body) > 0) {
                              app.items[i].flagged = true
                            } else {
                              app.items[i].flagged = false
                            }
                          }
                          app.items[i].spinnerHidden = true
                        })
                      }
                    }
                  }, 5000 * i, this, i)
                }
              }
              this.spinnerHidden = true
            })

          },
          showSponsor(gr){
            this.sponsorGroup = gr.glink
            this.sponsorGroupName = 'Sponsor ' + gr.gname + ' with a monthly subscription'
            this.sponsorVisible = true
            if (false === this.btLoaded) {
              Vue.http.post( 'btSetup', {
              }).then( ( response ) => {
                this.btAuth = response.body[0]
                this.subs = response.body[1]
                this.createHostedFields()
                this.btLoaded = true
                this.formHidden = false
                this.btSpinnerHidden = true
              })
            }
          },
          addPosts(){
            if (this.newGallery) {
              if (this.newGalleryName == '') {
                MintUI.Toast({
                  message: 'Please create a name for your new gallery',
                  iconClass: 'icon icon-success',
                  duration: 4000
                })
                return
              }
            } else {
              this.newGalleryName = ''
              if (this.postto.length == 0) {
                MintUI.Toast({
                  message: 'Select gallery(s) for your post',
                  iconClass: 'icon icon-success',
                  duration: 4000
                })
                return
              }
            }
            var sel = this.doSetHeader.reduce(
              (out, bool, index) => bool ? out.concat(index) : out, 
              []
            )
            var doSetHeader = -1
            if (sel.length > 0) {
              doSetHeader = parseInt(sel[0])
            }
            var exp = this.expireHours
            if (this.doExpire === false) {
              exp = 0
            }
            this.spinnerHidden = false
            this.saveHidden = true
            this.groupsHidden = true
            this.uploadHidden = true
            this.imgHidden = true
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : JSON.stringify(this.title),
              expirehours: exp,
              speedup: this.speedup,
              doSetHeader: doSetHeader,
              newGallery: this.newGalleryName
            }).then( ( response ) => {
              if ( !!response.body ) {
                if (response.body[0].length > 3) {
                  this.groupLink = this.title + ' ' + response.body
                  this.showShareGroup = true
                  if (this.postto.length === 1) {
                    var postto = this.postto[0]
                    Vue.http.post( 'joinGroup', {
                      grp:this.postto[0]
                    }).then( ( response ) => {
                      this.sharingGroup = response.body[1]
                      this.sharingImg = response.body[2]
                      this.selected = 'tab3'
                      router.push( 'showGroupPosts/' + postto )
                    })
                  }
                }
              }
              this.selected = 'tab1'
              this.getPosts()
              this.title = ''
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
              this.reset()
            })
          },
          createHostedFields() {
            var postsobj = this
            if (typeof braintree !== "undefined" && this.btAuth != '') {
              braintree.setup(this.btAuth, "custom", {
                id: "cardForm",
                hostedFields: {
                  number: {
                    selector: "#card-number",
                    placeholder: "4111 1111 1111 1111"
                  },
                  cvv: {
                    selector: "#cvv",
                    placeholder: "111"
                  },
                  expirationDate: {
                    selector: "#expiration-date",
                    placeholder: "MM/YY"
                  },
                  postalCode: {
                    selector: "#postal-code",
                    placeholder: "32323"
                  },
                  styles: {
                    'input': {
                      'font-size': '16px',
                      'font-family': 'courier, monospace',
                      'font-weight': 'lighter',
                      'color': '#ccc'
                    },
                    ':focus': {
                      'color': 'black'
                    },
                    '.valid': {
                      'color': '#8bdda8'
                    }
                  }
                },
                onReady: function (integration) {
                  checkout = integration
                },
                onPaymentMethodReceived: function (nonce) {

                  Vue.http.post( 'doSponsor', {
                    method:JSON.stringify(nonce),
                    plan_id:postsobj.plan,
                    group_id:postsobj.sponsorGroup
                  }).then( ( response ) => {
                    MintUI.Toast({
                      message: 'Thank you! Bills as FLEETCODER on your Credit Card Statement.',
                      iconClass: 'icon icon-error',
                      duration: 2000
                    })
                  })
                  checkout.teardown(function () {
                    checkout = null
                    postsobj.createHostedFields()
                    postsobj.sponsorVisible = false
                  })
                }
              })
            }
          },
          doSponsor(nonce){
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : JSON.stringify([this.title]),
              expirehours: exp
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getPosts()
              this.title = ''
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
            })
            onPaymentMethodReceived
          },
          dropFeed(idx){
            Vue.http.post( 'dropFeed', {
              feed : idx
            }).then( ( response ) => {
              this.feeds = response.body
              this.setFeeds()
            })
          },
          doLogout(){
            Vue.http.post( 'logout', {
            }).then( ( response ) => {
              window.location.href = '/'
            })
          },
          doAddFeed(){
            Vue.http.post( 'addFeeds', {
              feed : this.addFeed
            }).then( ( response ) => {
              this.feeds = response.body
              this.setFeeds()
              this.addFeed = ''
            })
          },
          showFeeds(){
            this.linkVisible = false
            this.feedsVisible = true
          },
          closeSettings(){
            this.linkVisible = false
          },
          closeHelp(){
            this.helpVisible = false
          },
          closeFeeds(){
            this.feedsVisible = false
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
                this.imgHidden = false
                this.uploadHidden = true
              }
            })
          },
          dropSponsor(idx){
            var postsobj = this
            MintUI.MessageBox({
              title: 'Stop Subscription',
              message: 'Are you sure?',
              showCancelButton: true,
              confirmButtonText: 'Stop Subscription',
              cancelButtonText: 'Cancel'
            }).then(action => {
              if (action === 'confirm') {
                this.spinnerHidden = false
                Vue.http.post( 'delSponsor', {
                  id:postsobj.subs[idx].id
                }).then( ( response ) => {
                  this.subs.splice( idx, 1 )
                  this.spinnerHidden = true
                })
              }
            })
          },
          quickContact(){
            this.showAddContact = true
          },
          cancelContact(){
            this.showAddContact = false
            this.newName = ''
            this.newEmail = ''
            this.newPhone = ''
            this.newContact = ''
          },
          checkConName() {
            this.validName = "success"
          },
          saveContact(){
            this.spinnerHidden = false
            Vue.http.post( 'quickAddContacts', {
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone
            }).then( ( response ) => {
              this.newName = ''
              this.newEmail = ''
              this.newPhone = ''
              this.newContact = ''
              this.getContacts()
              this.getPosts()
              this.showAddContact = false
            })
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
                var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (re.test(String(this.newContact).toLowerCase())) {
                  this.validContact = "success"
                  this.newEmail = this.newContact
                } else {
                  this.validContact = "error"
                }
              } else {
                if (this.newContact.substring(0, 2) == '+1') {
                  this.newContact = this.newContact.substring(2)
                }
                if (!(this.newContact.match(/\d/g) === null))
                  if (this.newContact.match(/\d/g).length===10) {
                    this.validContact = "success"
                    this.newPhone = this.newContact
                  } else {
                    this.validContact = "error"
                  }
              }

          },
          setGroups() {
            for (var j = 0; j < this.contacts.length; j++) {
              this.contacts[j].groups = []
              for (var i = 0; i < this.cgroups.length; i++) {
                if (this.cgroups[i].members.indexOf(this.contacts[j].id) > -1) {
                  if ("undefined" != typeof this.lastgroups[j]) {
                    if(this.lastgroups[j].indexOf(this.cgroups[i].id) !== -1){

                    } else {
                      this.contacts[j].groups.push(this.cgroups[i].id)
                      console.log(this.contacts[j].name + ' added ' + this.cgroups[i].name)
                      Vue.http.post( 'modContactGroups', {
                        id : this.contacts[j].id,
                        groups : JSON.stringify(this.contacts[j].groups.concat(this.lastgroups[j]))
                      }).then( ( response ) => {
                        if ( !!response.body ) {
                          this.groups = response.body[0]
                        }
                      })
                    }
                  }
                } else {
                  if ("undefined" != typeof this.lastgroups[j]) {
                    if(this.lastgroups[j].indexOf(this.cgroups[i].id) !== -1){
                      console.log(this.contacts[j].name + ' removed ' + this.cgroups[i].name)
                      const index = this.lastgroups[j].indexOf(this.cgroups[i].id)
                      if (index > -1) {
                        this.lastgroups[j].splice(index, 1)
                      }
                      Vue.http.post( 'modContactGroups', {
                        id : this.contacts[j].id,
                        groups : JSON.stringify(this.lastgroups[j])
                      }).then( ( response ) => {
                        if ( !!response.body ) {
                          this.groups = response.body[0]
                        }
                      })
                    }
                  }
                }
              }
            }
            this.lastgroups = []
            for (var j = 0; j < this.contacts.length; j++) {
              this.lastgroups.push([])
              this.lastgroups[j] = []
              for (var i = 0; i < this.cgroups.length; i++) {
                if (this.cgroups[i].members.indexOf(this.contacts[j].id) > -1) {
                  this.lastgroups[j].push(this.cgroups[i].id)
                }
              }
            }
          },
          closeSubs(){
            this.subsVisible = false
          },
          reset() {
            this.currentStatus = STATUS_INITIAL
            this.uploadedFiles = []
            this.uploadError = null
          },
          cancelUpload(){
            this.reset()
          },
          save(formData) {
            this.currentStatus = STATUS_SAVING
            this.$http.post ( this.uploadTo + '?field=image', formData ).then(function (x) {
              this.uploadedFiles = x.body[0]
              this.doSetHeader = []
              this.title = []
              for (var i = 0; i < this.uploadedFiles.length; i++) {
                this.title.push('')
                if (i === 0) {
                  this.doSetHeader.push(true)
                } else {
                  this.doSetHeader.push(false)
                }
              }
              this.currentStatus = STATUS_SUCCESS
            })
          },
          filesChange(fieldName, fileList) {
            //if (isSaving() || isSuccess()) {
              const formData = new FormData()
              if (!fileList.length) return
              Array
                .from(Array(fileList.length).keys())
                .map(x => {
                  formData.append(fieldName, fileList[x], fileList[x].name)
                })
              this.save(formData)
           //}
          },
          moreItems(){
            this.cursor = this.items.length
            this.getPosts()
          },
          doShowSponsor(){
            this.showSponsor(this.doSponsor)
          },
          showHelpSection(section) {
            this['help1'] = false
            this['help2'] = false
            this['help3'] = false
            this['help4'] = false
            this['help5'] = false
            this[section] = true
          },
          copyTemplate1(){
            this.helpVisible = false
            MintUI.Toast({
              message: 'You just copied the photo caption text to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyTemplate2(){
            this.helpVisible = false
            MintUI.Toast({
              message: 'You just copied the direct message text to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
          },
          copyError2(){
          },
          onNotifChange(gid,type,value){
            this.spinnerHidden = false
            Vue.http.post( 'modGroupNotif', {
              id: gid,
              type: type,
              value: value
            }).then( ( response ) => {
              this.spinnerHidden = true
            })
          },
          copyFeedLink(){
            this.linkVisible = false
            MintUI.Toast({
              message: 'You just copied your private timeline feed link with password to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          takeMeThere(){
            router.push( '/groups' )
            this.selected = 'tab2'
          },
          copyGroupLink(){
            this.showShareGroup = false
            MintUI.Toast({
              message: 'You just copied the caption and gallery link to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
            MintUI.Toast({
              message: 'Sorry, there was an error copying the gallery link',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          closeShareGroup(){
            this.showShareGroup = false
          },
          setStartMode(){
          },
          closeFirst(){
            this.showFirst = false
            //this.gettingStarted = false
          },
          doFindFeeds(){
            this.findSpinnerHidden = false
            this.findDisabled = true
            Vue.http.post( 'findFeeds', {
              site:this.findFeeds
            }).then( ( response ) => {
              if ( !!response.body ) {
                this.foundFeeds = response.body
                if (this.foundFeeds.length === 0){
                  this.findMessageHidden = false
                } else {
                  this.findMessageHidden = true
                }
              }
              this.findDisabled = false
              this.findSpinnerHidden = true
            })
          },
          subFeed(link,idx){
            this.foundFeeds.splice( idx, 1 )
            Vue.http.post( 'addFeeds', {
              feed : link
            }).then( ( response ) => {
              this.feeds = response.body
              this.setFeeds()
            })
          },
          setShowShareGroup(){
            this.showShareGroup = true
          },
          onFileChange(file) {
            this.spinnerHidden = false
            Vue.http.post('addList', {
            }).then((response) => {
              Vue.http.get( 'getSettings').then( ( response ) => {
                if ( !!response.body ) {
                  this.feeds = JSON.parse(response.body.feedSubs)
                  this.feedmeta = JSON.parse(response.body.feedMeta)
                  this.setFeeds()
                }
              })
            })
          },
          onFeedSettChange(url){
            this.spinnerHidden = false
            Vue.http.post( 'modFeedSett', {
              feedlink: url
            }).then( ( response ) => {
              this.spinnerHidden = true
            })
          },
          goHelp(){
            if (this.startMode == 'public') {
              this.startMode == ''
              this.showPrivateVid = false
              this.showPublicVid = true
              this.showStartControls = false
            }
            if (this.startMode == 'private') {
              this.startMode == ''
              this.showPublicVid = false
              this.showPrivateVid = true
              this.showStartControls = false
            }
          },
          shareLink(){
            this.showShareLink = true
          },
          closeShareLink(){
            this.showShareLink = false
          },
          doShareText(){
            this.showShareLink = false
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : '[]',
              expirehours: 0,
              speedup: this.speedup,
              doSetHeader: this.doSetHeader,
              headline: '<h1 class="article_mainhed">' + this.headline + '</h1>',
              shareText: this.textpost
            }).then( ( response ) => {
              if ( !!response.body ) {
                if (response.body[0].length > 3) {
                  this.groupLink = this.title[0] + ' ' + response.body
                  this.showShareGroup = true
                  if (this.postto.length === 1) {
                    Vue.http.post( 'joinGroup', {
                      grp:this.postto[0]
                    }).then( ( response ) => {
                      this.sharingGroup = response.body[1]
                      this.sharingImg = response.body[2]
                    })
                  }
                }
              }
              this.textpost = ''
              this.selected = 'tab1'
              this.shareLinkUrl = ''
              this.getPosts()
              this.title = []
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
              this.reset()
            })
          },
          doShareLink(){
            if (this.shareLinkUrl == '') {
              return false
            }
            this.showShareLink = false
            this.spinnerHidden = false
            Vue.http.post( 'addPosts', {
              recips:JSON.stringify(this.postto),
              title : '[]',
              expirehours: 0,
              speedup: this.speedup,
              doSetHeader: this.doSetHeader,
              shareLink: this.shareLinkUrl
            }).then( ( response ) => {
              if ( !!response.body ) {
                if (response.body[0].length > 3) {
                  this.groupLink = this.title[0] + ' ' + response.body
                  this.showShareGroup = true
                  if (this.postto.length === 1) {
                    Vue.http.post( 'joinGroup', {
                      grp:this.postto[0]
                    }).then( ( response ) => {
                      this.sharingGroup = response.body[1]
                      this.sharingImg = response.body[2]
                    })
                  }
                }
              }
              this.selected = 'tab1'
              this.shareLinkUrl = ''
              this.getPosts()
              this.title = []
              this.image = ''
              this.postto = []
              this.spinnerHidden = true
              this.saveHidden = false
              this.uploadHidden = false
              this.groupsHidden = false
              this.reset()
            })
          },
          onSetHeaderChange(idx){
            for (var i = 0; i < this.uploadedFiles.length; i++) {
              if (i === idx) {
              } else {
                this.doSetHeader[i] = false
              }
            }
          },
          backToGallery() {
            this.showBackToGallery = true
          },
          backToGalleries() {
            for (var i = 0; i < this.cgroups.length; i++) {
              if (parseInt(this.cgroups[i].id) == parseInt(this.postto[0])) {
                this.selected = 'tab3'
                router.push( 'showGroupPosts/' + this.cgroups[i].id )
              }
            }
          },
          changeTabs(route) {
            router.push( route )
          },
          shareText(){
            this.textHidden = false
          }
        },
        mounted() {
          this.reset()
        },
        template: `
          <div>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:posts.sync="posts" v-bind:doSponsor.sync="doSponsor" v-bind:groupLink.sync="groupLink" v-bind:postto.sync="postto" v-bind:selected.sync="selected" v-bind:editHidden="editHidden" v-bind:cangrps="cangrps" v-bind:moreHidden="moreHidden" @on-update-list="getPosts" @on-update-groups="getContacts" @on-tabs-hidden="hideTabs" @on-show-menu="showLink" @on-show-help="showHelp" @load-more-items="moreItems" @show-share-group="setShowShareGroup" @show-sponsor="doShowSponsor" />
                <h3 v-if="gettingStarted">Welcome!</h3>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2" class="addphotostab">
                <mt-header title="Rp.ly">
                  <a v-if="showBackToGallery" v-on:click="backToGalleries()" slot="left">
                    <mt-button icon="back">back</mt-button>
                  </a>
                  <a v-else v-on:click="showHelp()" slot="left">
                    <img class="headericon" slot="icon" src="file/help-circle.svg" />
                  </a>
                  <a v-on:click="showLink()" slot="right">
                    <img class="headericon" slot="icon" src="file/settings.svg" />
                  </a>
                </mt-header>
                <mt-cell v-bind:class="{'is-hidden':imgHidden}" title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>
                <mt-cell>
                  <form enctype="multipart/form-data" novalidate v-if="isInitial">
                    <div class="dropbox">
                      <label class="uploadlabel" for="image_uploads">&nbsp;&nbsp;&nbsp;&nbsp;<img src="/file/camera.svg" class="uplimg" alt="Upload Photos" /><img src="/file/video.svg" class="uplimg" alt="Upload Photos" /><img src="/file/film.svg" class="uplimg" alt="Upload Photos" /></label><img v-on:click="shareLink()" v-if="shareLinks" src="/file/link.svg" class="uplimg" alt="Save Link" /><img v-on:click="shareText()" v-if="shareLinks" src="/file/edit.svg" class="uplimg" alt="Write Text" />&nbsp;&nbsp;&nbsp;&nbsp;
                      <input id="image_uploads" type="file" multiple :name="uploadFieldName" :disabled="isSaving" @change="filesChange($event.target.name, $event.target.files); fileCount = $event.target.files.length"
                        accept="image/*,video/mp4,video/x-m4v,video/*,audio/x-m4a,audio/*" class="input-file" />
                      <h3>Click on these buttons to add content</h3>
                    </div>
                  </form>
                  <p id="issaving" class="dropbox" v-if="isSaving">
                    Uploading {{ fileCount }} files...
                    <mt-button type="primary" size="small" v-on:click="cancelUpload()">Cancel Uploading</mt-button>
                    <mt-spinner type="snake"></mt-spinner>
                  </p>
                  <div v-if="isSuccess">
                    <h2>Uploaded {{ uploadedFiles.length }} file(s) successfully.</h2>
                    <p>
                      <a href="javascript:void(0)" @click="reset()">Replace These Files</a>
                    </p>
                    <ul class="list-unstyled">
                      <li v-for="(item, idx) in uploadedFiles">
                        <img :src="'myFile?staged=1&field=image&multiname=' + item.url" class="img-responsive img-thumbnail" :alt="item.originalName" />
                        <mt-cell title="Use As Gallery Header Photo"><mt-switch v-model="doSetHeader[idx]" @change="onSetHeaderChange(idx)"></mt-switch></mt-cell>
                        <mt-field placeholder="Caption..." type="textarea" rows="4" v-model="title[idx]"></mt-field>
                      </li>
                    </ul>
                  </div>
                  <div v-if="isFailed">
                    <h2>Uploaded failed.</h2>
                    <p>
                      <a href="javascript:void(0)" @click="reset()">Try again</a>
                    </p>
                    <pre>{{ uploadError }}</pre>
                  </div>
                </mt-cell>
                <mt-field placeholder="Headline..." v-if="!textHidden" type="textarea" rows="4" v-model="headline"></mt-field>
                <!--<mt-field placeholder="Story..." v-if="!textHidden" type="textarea" rows="20" v-model="textpost"></mt-field>-->
                <mt-cell><vue-editor v-if="!textHidden" v-model="textpost"></vue-editor></mt-cell>
                <mt-checklist
                  v-if="!textHidden" 
                  v-model="postto"
                  :options="linkgroups"
                  align="right">
                </mt-checklist>
                <mt-button v-if="!textHidden" v-on:click="doShareText()">Save</mt-button><p></p>
                <audio-recorder v-bind:class="{'is-hidden':!audioHidden}" :upload-url="'uploadFile?field=sound'" :after-recording="aftRec" />
                <mt-cell><mt-field v-bind:class="{'is-hidden':!audioHidden}" placeholder="Speedup..." v-model="speedup" label="Frame rate multiplier"></mt-field></mt-cell>
                <mt-checklist v-if="isSuccess" v-bind:class="{'is-hidden':groupsHidden}"
                  v-model="postto"
                  :options="groups"
                  align="right">
                </mt-checklist>
                <mt-field v-model="newGalleryName" v-if="newGallery" label="New Gallery Name:"></mt-field>
                <mt-cell v-if="isSuccess" title="Make A New Gallery For These Photos"><mt-switch v-model="newGallery"></mt-switch></mt-cell>
                <!--<mt-button v-bind:class="{'is-hidden':saveHidden}" v-on:click="quickContact()" size="large">Add Contact</mt-button>-->
                <!--<mt-cell title="Expire after"><mt-field v-model="expireHours" label="hours"></mt-field><mt-switch v-model="doExpire" @change="onExpireChange()"></mt-switch></mt-cell>-->
                <!--<mt-button v-bind:class="{'is-hidden':optionsBtnHidden}" v-on:click="showOptions()" size="large">Options</mt-button>-->
                <mt-cell v-bind:class="{'is-hidden':optionsHidden}"><mt-switch class="options" v-model="audioHidden">Podcast</mt-switch><mt-switch class="options" v-model="textHidden">Caption</mt-switch></mt-cell>
                <mt-button v-if="isSuccess" v-bind:class="{'is-hidden':saveHidden}" v-on:click="addPosts()" size="large" id="savepostbutton">Save</mt-button>
              </mt-tab-container-item>
              <mt-tab-container-item id="tab3"">
                  <router-view name="righttab" @on-update-photos="getPosts" v-bind:items="items" v-bind:posts.sync="posts" v-bind:doSponsor.sync="doSponsor" v-bind:groupLink.sync="groupLink" v-bind:postto.sync="postto" v-bind:selected.sync="selected" v-bind:editHidden="editHidden" v-bind:cangrps="cangrps" v-bind:moreHidden="moreHidden" @on-update-list="getPosts" @on-update-groups="getContacts" @on-tabs-hidden="hideTabs" @on-show-menu="showLink" @on-show-help="showHelp" @load-more-items="moreItems" @show-share-group="setShowShareGroup" @show-sponsor="doShowSponsor" @on-show-back="backToGallery" />
                  <!--
                  <router-view name="middletab" v-bind:subsHidden="subsHidden" @on-update-photos="getPosts" v-bind:groups="groups" />
                  <mt-cell>
                    <ul class="contacts">
                      <li class="contact" v-for="friend in contacts">{{ friend.name }}</li>
                    </ul>
                    <mt-checklist class="choosegroups" v-for="(group,idx) in cgroups" :title="cgroups[idx].name"
                      v-model="cgroups[idx].members"
                      :options="cgroups[idx].perms"
                      align="right"
                      v-on:change="setGroups()">
                    </mt-checklist>
                  </mt-cell>-->
              </mt-tab-container-item>
            </mt-tab-container>
            <mt-tabbar fixed="true" v-model="selected" v-bind:class="{'is-hidden':tabsHidden}">
              <mt-tab-item id="tab1" @mouseup.native="changeTabs('/')">
                <img slot="icon" src="/file/home.svg" />
              </mt-tab-item>
              <mt-tab-item id="tab2" @mouseup.native="changeTabs('/tab2')">
                <img slot="icon" src="/file/plus-circle.svg" />
              </mt-tab-item>
              <mt-tab-item id="tab3" @mouseup.native="changeTabs('/tab3')">
                <img slot="icon" src="/file/list.svg" />
              </mt-tab-item>
            </mt-tabbar>
            <mt-popup class="help_popup" v-model="sponsorVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSponsor()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <mt-cell :title="sponsorGroupName"></mt-cell>
              <mt-spinner v-bind:class="{'is-hidden':btSpinnerHidden}" type="snake"></mt-spinner>
              <form action="/" method="post" id="cardForm" v-bind:class="{'is-hidden':formHidden}">
                <label class="hosted-fields--label" for="card-number">Card Number</label>
                <div id="card-number" class="hosted-field"></div>
                <label class="hosted-fields--label" for="expiration-date">Expiration Date</label>
                <div id="expiration-date" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">CVV</label>
                <div id="cvv" class="hosted-field"></div>
                <label class="hosted-fields--label" for="cvv">Postal Code</label>
                <div id="postal-code" class="hosted-field"></div>
                <mt-radio v-model="plan" :options="plans"></mt-radio>
                <div class="button-container">
                  <input type="submit" class="button button--small button--green" value="Submit" id="submit"/>
                </div>
                <label class="hosted-fields--label">Cancel any time from the Settings menu</label>
              </form>
            </mt-popup>

            <mt-popup class="help_popup" v-model="feedsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeFeeds()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(url, idx) in feedslist">
                <mt-switch v-model="url.ai" @change="onFeedSettChange(url.src)"></mt-switch>
                <mt-field v-model="url.src"></mt-field>
                <a v-on:click="dropFeed(idx)">
                  <mt-button>X</mt-button>
                </a>
              </mt-cell>
              <mt-field placeholder="Paste a feed link..." v-model="addFeed"></mt-field>
              <mt-button v-on:click="doAddFeed()" size="large">Save Feed</mt-button>
              <mt-field placeholder="Name of web site or keywords..." v-model="findFeeds"></mt-field>
              <mt-button v-on:click="doFindFeeds()" :disabled="findDisabled" size="large">Find Feeds</mt-button>
              <mt-spinner v-bind:class="{'is-hidden':findSpinnerHidden}" type="snake"></mt-spinner>
              <mt-cell v-bind:class="{'is-hidden':findMessageHidden}" title="No Feeds Found"></mt-cell>
              <mt-cell v-for="(feed, idx) in foundFeeds" :title="feed.title">
                <a v-on:click="subFeed(feed.link,idx)">
                  <mt-button>&plus;</mt-button>
                </a>
              </mt-cell>
              <file-upload accept=".xml,.opml" btn-label="Upload Feeds File" :url="uploadXmlTo + '?field=feedfile'" @change="onFileChange" class="sub_upload"></file-upload>
             </mt-popup>

            <mt-popup v-model="subsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSubs()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(artist, idx) in subs">
                <mt-cell :title="artist.name">
                  <a v-on:click="dropSponsor(idx)">
                    <mt-button>X</mt-button>
                  </a>
                </mt-cell>
              </mt-cell>
              <p v-text="noSubsTxt"></p>
              <p>&nbsp;</p>
            </mt-popup>

            <mt-popup class="help_popup" v-model="helpVisible" position="middle">
              <mt-header>
                <a v-on:click="closeHelp()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
<!--
<h4 class="help_header" v-on:click="showHelpSection('help1')">Introduction</h4>
<p v-if="help1" class="help_para">RP.LY is a new kind of digital photo gallery that helps photographers sell monthly subscriptions.</p>
<p v-if="help1" class="help_para">Gallery visitors are required to provide a validated email address or phone number before they can see the gallery photos.</p>
<p v-if="help1" class="help_para">Photographers then receive this information as a â€œContactâ€, and gallery visitors will receive an occasional â€œgallery updatedâ€ notification by email or text message.</p>

<h4 class="help_header" v-on:click="showHelpSection('help2')">Setting up a gallery</h4>
<p v-if="help2" class="help_para">After you register or log in, you will see an empty gallery/feed. At the bottom are three tabs: Gallery, Manage and Add Photos.</p>
<p v-if="help2" class="help_para">To set up your first gallery, click on Manage -> Galleries -> My Photos -> Edit Gallery.</p>
<p v-if="help2" class="help_para">Now you should see your Galleryâ€™s settings including the Name (change it from â€œMy Photosâ€ to something else).</p>
<p v-if="help2" class="help_para">Click the â€œSet Header Photoâ€ button to upload a header image - this will be the public image for your gallery, this image will be visible to friends when you share the gallery with them, even before they click through and enter your gallery. You can use any size image for this photo and it will be used unmodified, we will add more specific size guidelines in the future. The gallery header image can be vertical or horizontal.</p>
<p v-if="help2" class="help_para">Options:</p>
<p v-if="help2" class="help_para">a) Scale down uploaded files - this setting will automatically reduce the size of the images you publish, if you set it to 1000pixels then all of your published horizontal images will be 1000pixels wide or smaller, and your vertical images will be 1000pixels tall or smaller. This setting can be disabled completely by sliding the switch so that the blue part is hidden.</p>
<p v-if="help2" class="help_para">b) Block members from saving photos - this setting will block gallery visitors from saving your images to their phoneâ€™s camera roll.</p>
<p v-if="help2" class="help_para">c) Allow members to add photos - this setting will allow all gallery visitors to add photos to your gallery.</p>

<h4 class="help_header" v-on:click="showHelpSection('help3')">Contacts</h4>
<p v-if="help3" class="help_para">Contacts are created for every visitor who joins any of your galleries, a single contact can be a member of many of your galleries or just one.</p>
<p v-if="help3" class="help_para">Members of galleries are managed by clicking the â€œManageâ€ tab. At the top of the manage tab are radio buttons which allow you to add and remove gallery memberships. When you remove a member from a gallery, the images from that gallery will no longer appear in their photo feed.</p>
<p v-if="help3" class="help_para">The easiest way to create contacts is to allow your friends and family to join your gallery themselves, but you can also create a gallery and add people to it yourself. Galleries are private/hidden until you share the link with someone or post the link on your social media profiles.</p>
<p v-if="help3" class="help_para">To add a contact: click on Manage -> Contacts -> Add Contact.</p>

<h4 class="help_header" v-on:click="showHelpSection('help4')">Payments</h4>
<p v-if="help4" class="help_para">Payments are money you have earned. They are created from credit card subscription payments when your friends sponsor a gallery. Each gallery has a button at the bottom that says â€œBecome a Sponsorâ€. The options are $3/monthly or $3/twice-yearly. Photographers will see payments of $2.70 (90%) each time someone becomes a sponsor, and each time their subscription renews.</p>
<p v-if="help4" class="help_para">Disbursement is currently a manual process and can be requested by emailing info@rp.ly - PayPal and Venmo are the current disbursement options.</p>

<h4 class="help_header" v-on:click="showHelpSection('help5')">Sharing a gallery by text message</h4>
<p v-if="help5" class="help_para">To share a gallery by text message, click Manage -> Galleries -> [YOUR GALLERY].</p>
<p v-if="help5" class="help_para">Click the button that says â€œCopy Gallery Linkâ€ and that will copy the gallery link into your clipboard.</p>
<p v-if="help5" class="help_para">You can paste this link to a group-text of friends and they will see your gallery name and your gallery header image as a preview.</p>

<h4 class="help_header" v-on:click="showHelpSection('help6')">Sharing a gallery to Instagram</h4>
<p v-if="help6" class="help_para">Follow the instructions in [Sharing a gallery by text message] to copy the gallery link to your clipboard.</p>
<p v-if="help6" class="help_para">Go to your Instagram profile and click â€œEdit Profileâ€.</p>
<p v-if="help6" class="help_para">Click â€œWebsiteâ€ and paste your gallery link and click â€œDoneâ€.</p>
<p v-if="help6" class="help_para">Ideally you will have multiple photos to publish, you can publish one of them to Instagram and make sure to include a comment â€œClick link in bio for more imagesâ€¦â€.</p>
<p v-if="help6" class="help_para">
        <h5 v-if="help6">Template: Instagram photo caption:</h5>
        <mt-field class="templtext" v-if="help6" type="textarea" rows="3" v-text="template1"></mt-field>
        <mt-button v-if="help6" size="large" v-clipboard:copy="template1" v-clipboard:success="copyTemplate1" v-clipboard:error="copyError" class="buttonset">Copy To Clipboard</mt-button>
</p>
<p v-if="help6" class="help_para">
        <h5 v-if="help6">Template: Instagram Direct Message:</h5>
        <mt-field class="templtext" v-if="help6" type="textarea" rows="3" v-text="template2"></mt-field>
        <mt-button v-if="help6" size="large" v-clipboard:copy="template2" v-clipboard:success="copyTemplate2" v-clipboard:error="copyError2" class="buttonset">Copy To Clipboard</mt-button>
</p>

<h4 class="help_header" v-on:click="showHelpSection('help7')">Sharing a gallery to Facebook</h4>
<p v-if="help7" class="help_para">Follow the instructions in [Sharing a gallery by text message] to copy the gallery link to your clipboard.</p>
<p v-if="help7" class="help_para">Create a new post on Facebook and â€œpasteâ€ your gallery link.</p>
<p v-if="help7" class="help_para">Facebook has an automated feature that will retrieve your gallery header image and gallery name.</p>

<h4 class="help_header" v-on:click="showHelpSection('help8')">Sharing a gallery by email</h4>
<p v-if="help8" class="help_para">You will need to use a Desktop computer for the following step, you can log in with your same phone number or email that you signed up with.</p>
<p v-if="help8" class="help_para">To share a gallery by email, click Manage -> Galleries -> [YOUR GALLERY]</p>
<p v-if="help8" class="help_para">Click the button that says â€œDownload Gallery HTML Fileâ€ and that will cause your computer to start downloading a file - save the file to your Desktop - or anywhere that you can find it.</p>
<p v-if="help8" class="help_para">Double-click the file to open it in Safari (this procedure has been tested in Safari but not other browsers). You should see your gallery name and gallery header image.</p>
<p v-if="help8" class="help_para">Now you can select-all and copy the contents of the browser window. On a Mac this is done with Command-A and then Command-C. On Windows you can Control-A and Control-C.</p>
<p v-if="help8" class="help_para">After you copy the content, you will be able to paste it into a new Gmail message or other mail app.</p>
-->
        <h4 class="help_header" v-on:click="showHelpSection('help1')">Share privately</h4>
        <div class="firstHelp help_para" v-if="help1">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demoprivate1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        <h4 class="help_header" v-on:click="showHelpSection('help2')">Share public/private</h4>
        <div class="firstHelp help_para" v-if="help2">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demopublic1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        <div v-if="subsHidden">
        <h4 class="help_header" v-on:click="showHelpSection('help3')">Safety feed</h4>
        <div class="firstHelp help_para" v-if="help3">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demofilter1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        <h4 class="help_header" v-on:click="showHelpSection('help4')">Follow other sites</h4>
        <div class="firstHelp help_para" v-if="help4">
          <vue-plyr class="startVid">
            <video src="https://rp.ly/file/demonetwork1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
          </vue-plyr>
        </div>
        </div>
        <h4 class="help_header" v-on:click="showHelpSection('help5')">Contact Us</h4>
        <div class="firstHelp help_para mailto" v-if="help5">
            <a href="mailto:info@rp.ly">info@rp.ly</a>
        </div>
            </mt-popup>

            <mt-popup class="help_popup" v-model="linkVisible" position="middle">
              <mt-header>
                <a v-on:click="closeSettings()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <h3>Notifications</h3>
              <div v-for="(item,idx) in following">
                <h4 v-text="item.name"></h4>
                <div>
                  <h5 v-text="'Limit: ' + item.freq + ' per ' + item.interval"></h5>
                  <mt-radio
                    @change="onNotifChange(item.id,'interval',item.interval)"
                    v-model="item.interval"
                    :options="['Day', 'Week']">
                  </mt-radio>
                  <mt-range class="freqrange"
                    @change="onNotifChange(item.id,'freq',item.freq)"
                    v-model="item.freq"
                    :min="1"
                    :max="10"
                    :step="1"
                    :bar-height="5">
                    <div slot="start">1</div>
                    <div slot="end">10</div>
                  </mt-range>
                  <mt-cell>
                    <mt-switch class="notifswitch" v-model="item.email" @change="onNotifChange(item.id,'email',item.email)">Email</mt-switch>
                    <mt-switch class="notifswitch" v-model="item.phone" @change="onNotifChange(item.id,'phone',item.phone)">Text Msg</mt-switch>
                  </mt-cell>
                </div>
              </div>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}"></mt-cell>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}" title="Artists you sponsor"></mt-cell>
              <mt-button v-bind:class="{'is-hidden':subsHidden}" v-on:click="showSubs()" size="large">Sponsorships</mt-button>
              <mt-cell v-bind:class="{'is-hidden':subsHidden}"></mt-cell>
              <mt-cell></mt-cell>
              <mt-cell title="Paste feed links to follow content from other sites"></mt-cell>
              <mt-button v-on:click="showFeeds()" size="large">Feeds</mt-button>
              <mt-cell></mt-cell>
              <mt-cell title="Password feed link for your private feed"></mt-cell>
              <mt-field v-model="feedLink"></mt-field>
              <mt-button size="large" v-clipboard:copy="feedLink" v-clipboard:success="copyFeedLink" v-clipboard:error="copyError">Copy To Clipboard</mt-button>
              <mt-cell></mt-cell>
              <mt-button v-on:click="doLogout()" size="large">Logout</mt-button>
              <mt-cell></mt-cell>
            </mt-popup>
            
            <mt-popup class="addcontact" v-model="showAddContact" position="middle">
              <mt-field :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
              <mt-field :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
              <mt-button v-on:click="cancelContact()">Cancel</mt-button>&nbsp;<mt-button v-on:click="saveContact()" type="primary">Add Contact</mt-button>
            </mt-popup>
        
            <mt-popup class="addcontact" v-model="showShareGroup" position="middle">
              <mt-header :title="sharingGroup">
                <a v-on:click="closeShareGroup()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <img class="grimg" :src="sharingImg" alt="Gallery Header Photo" />
              <mt-field type="textarea" rows="4" v-model="groupLink"></mt-field>
              <mt-button v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError">Share</mt-button><p></p>
            </mt-popup>

            <mt-popup class="addcontact" v-model="showShareLink" position="middle">
              <mt-header>
                <a v-on:click="closeShareLink()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <mt-field  v-model="shareLinkUrl" placeholder="Paste article link..."></mt-field>
              <mt-checklist
                v-model="postto"
                :options="linkgroups"
                align="right">
              </mt-checklist>
              <mt-button v-on:click="doShareLink()">Share Link</mt-button><p></p>
            </mt-popup>

            <mt-popup class="addcontact" v-model="showFirst" position="middle">
                <mt-header>
                  <a v-on:click="closeFirst()" slot="right">
                    <mt-button>Close</mt-button>
                  </a>
                </mt-header>
                <h3 v-if="showStartControls">Do you want your first gallery to be...</h3>
                <mt-radio v-if="showStartControls"
                  title=""
                  v-model="startMode"
                  :options="['private', 'public']"
                  v-on:change="setStartMode()">
                </mt-radio>
                <vue-plyr v-if="showPrivateVid" class="startVid">
                  <video src="https://rp.ly/file/demoprivate1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                </vue-plyr>
                <vue-plyr v-if="showPublicVid" class="startVid">
                  <video src="https://rp.ly/file/demopublic1.mp4" controls data-plyr-config='{ "iconUrl": "file/plyr.svg" }' />
                </vue-plyr>
                <div v-if="showStartControls">
                  <h3 v-if="startMode == 'private'">Only you and members of your gallery can see the photos</h3>
                  <h3 v-if="startMode == 'public'">Anyone with the link can see the photos</h3>
                  <mt-button v-if="startMode !== ''" v-on:click="goHelp()">Continue</mt-button>
                </div>
                <p>&nbsp;</p>
                <!--
                <h3 v-if="gettingStarted"> Click on Add Photos to share in a private gallery and send the link to friends.</h3>
                <h3 v-if="gettingStarted">Or, click the Public option in settings to make a public landing page.</h3>
                <p v-if="gettingStarted">
                  <a href="javascript:void(0)" @click="takeMeThere()">Take me to settings</a>
                </p>-->
            </mt-popup>
          
          </div>`
      }
      const listContacts = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean },
        methods: {
          delContacts( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delContacts', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          showAddContact(){
            this.$emit('on-show-add-contact')
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="Rp.ly">
              <router-link to="/" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
                <mt-button slot="right"><img v-on:click="showAddContact()" class="headericon" slot="icon" src="/file/plus-circle.svg" />
                </mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell-swipe v-for="(item, idx) in items" :title="item.name" is-link :to="'/showContacts/' + idx" :right="[
              {
                content: 'Delete',
                style: { background: 'red', color: '#fff' },
                handler: () => delContacts( item.id, idx )
              }
            ]">
            </mt-cell-swipe>
          </div>`
      }
      const showContacts = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            email : '',
            phone : ''
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.items[ this.idx ].id
            this.name = this.items[ this.idx ].name
            this.email = this.items[ this.idx ].email
            this.phone = this.items[ this.idx ].phone
            this.$emit('on-tabs-hidden')
          },
          goEdit(idx) {
            router.push( '/modContacts/' + idx )
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <router-link to="/contacts" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell title="Name:" :value="name"></mt-cell>
            <mt-cell title="Email:" :value="email"></mt-cell>
            <mt-cell title="Phone:" :value="phone"></mt-cell>
            <mt-button size="large" v-on:click="goEdit(idx)">Edit Contact</mt-button>
          </div>`
      }
      const modContacts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            email : '',
            phone : ''
          }
        },
        props: { items : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.name = this.items[ this.idx ].name
          this.email = this.items[ this.idx ].email
          this.phone = this.items[ this.idx ].phone

          this.$emit('on-tabs-hidden')
        },
        methods: {
          modContacts(){
            this.spinnerHidden = false
            Vue.http.post( 'modContacts', {
              id : this.id,
              name : this.name,
              email : this.email,
              phone : this.phone
            }).then( ( response ) => {
              this.$emit('on-update-list')
              router.push( '/' )
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <router-link :to="'/showContacts/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Name:" placeholder="Name.." v-model="name"></mt-field>
            <mt-field label="Email:" placeholder="Email..(optional)" v-model="email" type="email"></mt-field>
            <mt-field label="Phone:" placeholder="Phone..(optional)" v-model="phone"></mt-field>
            <mt-button v-on:click="modContacts()" size="large">Save</mt-button>
          </div>`
      }
      const Contacts = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            name : '',
            email : '',
            phone : '',
            validEmail: '',
            validPhone: ''
          }
        },
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-contacts' : showContacts
        },
        created() {
          this.getContacts()
        },
        methods: {
          showAddContactForm() {
            this.selected = "tab2"
          },
          hideAddContactForm() {
            this.selected = "tab1"
          },
          checkEmail() {
            this.validEmail = ''
            var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (re.test(String(this.email).toLowerCase())) {
              this.validEmail = "success"
            } else {
              this.validEmail = "error"
            }
          },
          checkPhone() {
            this.validPhone = ''
            if (this.phone.match(/\d/g).length===10) {
              this.validPhone = "success"
            } else {
              this.validPhone = "error"
            }
          },
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getContacts() {
            this.spinnerHidden = false
            Vue.http.get( 'getContacts').then( ( response ) => {
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.abilities = response.body[2]
                if (this.abilities.indexOf("modSource Code") > -1) {
                  this.editHidden = false
                }
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rply/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
              }
              this.spinnerHidden = true
            })
          },
          addContacts(){
            this.spinnerHidden = false
            Vue.http.post( 'addContacts', {
              recips:JSON.stringify(this.postto),
              name : this.name,
              email : this.email,
              phone : this.phone
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getContacts()
              this.name = ''
              this.email = ''
              this.phone = ''
              Posts.getContacts()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          }
        },
        template: `
          <div>

            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:editHidden="editHidden" @on-update-list="getContacts" @on-tabs-hidden="hideTabs" @on-show-add-contact="showAddContactForm"  />
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="Rp.ly"></mt-header>
                <mt-field placeholder="Name.." v-model="name"></mt-field>
                <mt-field :state="validEmail" @keyup.native="checkEmail" placeholder="Email..(optional)" v-model="email" type="email"></mt-field>
                <mt-field :state="validPhone" @keyup.native="checkPhone" placeholder="Phone..(optional)" v-model="phone"></mt-field>
                <mt-button v-on:click="addContacts()" size="large">Save</mt-button>
                <br />
                <mt-button v-on:click="hideAddContactForm()" size="large">
                    Cancel
                </mt-button>
                <mt-cell></mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const listGroups = {
        data() {
          return {
            spinnerHidden : true
          }
        },
        props: { items : Array, editHidden: Boolean, othergroups : Array },
        methods: {
          delGroups( id, idx ){
            this.spinnerHidden = false
            Vue.http.post( 'delGroups', {
              id:id
            }).then( ( response ) => {
              this.items.splice( idx, 1 )
              this.spinnerHidden = true
            })
          },
          showAddGroup(){
            this.$emit('on-show-add-group')
          },
          showHelp(){
            this.$emit('on-show-help')
          },
          showLink(){
            this.$emit('on-show-settings')
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="Rp.ly">
              <a v-on:click="showHelp()" slot="left">
                <img class="headericon" slot="icon" src="file/help-circle.svg" />
              </a>
              <a v-on:click="showLink()" slot="right">
                <img class="headericon" slot="icon" src="file/settings.svg" />
              </a>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell v-for="(item, idx) in items" :title="item.name" is-link :to="'showGroupPosts/' + item.id">
              <img class="grimg" :src="'grpFile?field=image&name=' + item.image" />
            </mt-cell>
            <div v-if="othergroups.length > 0" class="groups_following"><h2>Following:</h2></div>
            <mt-cell v-for="(item, idx) in othergroups" :title="item.name" is-link :to="'showGroupPosts/' + item.id">
              <img class="grimg" :src="'grpFile?field=image&name=' + item.image" />
            </mt-cell>
            <mt-button size="large" v-on:click="showAddGroup()"><img slot="icon" src="/file/plus-circle.svg" /></mt-button>
          </div>`
      }
      const showGroups = {
        data() {
          return {
            spinnerHidden : true,
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            image : '',
            groupLink : '',
            inviteText: ' invited you to join '
          }
        },
        props: { items : Array },
        created() {
          if (this.items.length == 0) {
            this.$emit('on-update-list')
            setTimeout( function (self) {
              self.setData()
            }, 2000, this)
          } else {
            this.setData()
          }
        },
        methods: {
          setData(){
            this.id = this.items[ this.idx ].id
            this.name = this.items[ this.idx ].name
            this.image = this.items[ this.idx ].image
            this.groupLink = 'https://rp.ly/grp/' + this.items[ this.idx ].key
            /*Vue.http.post( 'joinGroup', {
              grp:this.items[ this.idx ].key
            }).then( ( response ) => {
              this.groupEmbed = '<div style="font-family:courier,monospace;width:90%"><img style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://rp.ly/grpFile?field=image&name='
              this.groupEmbed = this.groupEmbed + encodeURIComponent(this.items[ this.idx ].image) + '" /><p style="text-align:center;display:block;padding:10px;">' + response.body[0] + this.inviteText + response.body[1] + '</p><a style="text-align:center;background-color:#32e0c4;display:block;color:black;text-decoration:none;padding:10px;" href="https://rp.ly/grp/' +  this.items[ this.idx ].key + '">' + 'Join ' + response.body[0] + "'s Gallery" + '</a></p></div>'
            })*/
            this.$emit('on-tabs-hidden')
          },
          goEdit(idx) {
            router.push( '/modGroups/' + idx )
          },
          copyGroupEmbed(){
            window.location.href = 'https://rp.ly/getGroupEmbed?grp=' + this.items[ this.idx ].key
          },
          copyGroupLink(){
            MintUI.Toast({
              message: 'You just copied the gallery link to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
            MintUI.Toast({
              message: 'Sorry, there was an error copying the gallery data',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <mt-button slot="left" @click="$router.go(-1)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-cell title="" :value="name"></mt-cell>
            <mt-cell>
              <div class="outer">
                <img class="oimg" :src="'grpFile?field=image&name=' + image" />
              </div>
            </mt-cell>
            <mt-button size="large" class="buttonset" v-on:click="goEdit(idx)">Gallery Settings</mt-button>
            <mt-button size="large" v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError" class="buttonset">Copy Gallery Link</mt-button>
            <mt-button size="large" class="buttonset" v-on:click="copyGroupEmbed">Download Gallery HTML File</mt-button>
          </div>`
      }
      const modGroups = {
        components: {
          VueEditor
        },
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            idx: this.$route.params.idx,
            id : 0,
            name : '',
            image : '',
            showAddContact: false,
            validName: '',
            validContact: '',
            newName:'',
            newContact:'',
            newEmail:'',
            newPhone:'',
            showShareGroup: false,
            groupLink: '',
            maxRes: '2000',
            doScale: false,
            blockDownloads: false,
            allowPosts: false,
            shareLinks: false,
            optsHidden: false,
            public: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicGroups: [],
            pubHidden: false,
            publicPath: '',
            optGroups: [],
            feeds: [],
            feedsVisible: false,
            findFeeds: '',
            findDisabled: false,
            findSpinnerHidden: true,
            findMessageHidden: true,
            uploadXmlTo: 'syncFile',
            addFeed: '',
            shareCal: false,
            foundFeeds: [],
            mergeGroups: []
          }
        },
        props: { items : Array, groups : Array },
        created() {
          this.id = this.items[ this.idx ].id
          this.name = this.items[ this.idx ].name
          this.image = this.items[ this.idx ].image
          if (this.items[ this.idx ].blockDownloads == '0') {
            this.blockDownloads = false
          } else {
            this.blockDownloads = true
          }
          if (this.items[ this.idx ].allowPosts == '1') {
            this.allowPosts = true
          }
          if (this.items[ this.idx ].shareLinks == '1') {
            this.shareLinks = true
          }
          if (this.items[ this.idx ].shareCal == '1') {
            this.shareCal = true
          }
          if (this.items[ this.idx ].public == '1') {
            this.public = true
            this.changePublic()
          }
          var maxres = parseInt(this.items[ this.idx ].maxres)
          if (maxres > 0) {
            this.maxRes = this.items[ this.idx ].maxres
            this.doScale = true
          }
          if (maxres === 0) {
            this.doScale = false
          }
          this.publicName = this.items[ this.idx ].publicName
          this.publicBio = this.items[ this.idx ].publicBio
          this.publicLink = this.items[ this.idx ].publicLink
          this.publicImage = this.items[ this.idx ].publicImage
          this.publicPath = this.items[ this.idx ].publicPath
          if (!(['null',''].indexOf(this.items[ this.idx ].publicGroups) > -1) && !(!this.items[ this.idx ].publicGroups)) {
            this.publicGroups = JSON.parse(this.items[ this.idx ].publicGroups)
          }
          if (!(['null',''].indexOf(this.items[ this.idx ].feeds) > -1) && !(!this.items[ this.idx ].feeds)) {
            this.feeds = JSON.parse(this.items[ this.idx ].feeds)
          }
          this.$emit('on-tabs-hidden')
          Vue.http.get( 'getPosts' ).then( ( response ) => {
            if ( !!response.body ) {
              this.optGroups = response.body[1]
              for (var i = 0; i < this.publicGroups.length; i++) {
                if (!this.optGroups.includes(this.publicGroups[i])) {
                  //this.publicGroups.splice( i, 1 )
                }
              }
            }
          })
        },
        methods: {
          closeShareGroup(){
            router.push( '/' )
          },
          checkContact() {
            this.newPhone = ''
            this.newEmail = ''
            this.validContact = ''
            if (this.newContact.indexOf('@') !== -1) {
                var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                if (re.test(String(this.newContact).toLowerCase())) {
                  this.validContact = "success"
                  this.newEmail = this.newContact
                } else {
                  this.validContact = "error"
                }
              } else {
                if (this.newContact.substring(0, 2) == '+1') {
                  this.newContact = this.newContact.substring(2)
                }
                if (!(this.newContact.match(/\d/g) === null))
                  if (this.newContact.match(/\d/g).length===10) {
                    this.validContact = "success"
                    this.newPhone = this.newContact
                  } else {
                    this.validContact = "error"
                  }
              }

          },
          checkConName() {
            this.validName = "success"
          },
          cancelContact(){
            this.showAddContact = false
            this.newName = ''
            this.newEmail = ''
            this.newPhone = ''
            this.newContact = ''
          },
          quickContact(){
            this.showAddContact = true
          },
          saveContact(){
            this.spinnerHidden = false
            Vue.http.post( 'quickAddContacts', {
              name : this.newName,
              email : this.newEmail,
              phone : this.newPhone,
              groups : JSON.stringify([this.id])
            }).then( ( response ) => {
              this.newName = ''
              this.newEmail = ''
              this.newPhone = ''
              this.newContact = ''
              this.showAddContact = false
            })
          },
          modGroups(){
            this.spinnerHidden = false
            var exp = this.expireHours
            if (this.doExpire === false) {
              exp = 0
            }

            var sca = this.maxRes
            if (this.doScale === false) {
              sca = 0
            }
            Vue.http.post( 'modGroups', {
              id : this.id,
              name : this.name,
              maxres : sca,
              doScale : this.doScale,
              allowPosts : this.allowPosts,
              shareLinks : this.shareLinks,
              blockDownloads: this.blockDownloads,
              public: this.public,
              publicName: this.publicName,
              publicBio: this.publicBio,
              publicLink: this.publicLink,
              publicGroups: JSON.stringify(this.publicGroups),
              publicPath: this.publicPath,
              feeds: JSON.stringify(this.feeds),
              shareCal : this.shareCal,
              mergeGroups: JSON.stringify(this.mergeGroups)
            }).then( ( response ) => {
              this.$emit('on-update-list')
              this.$emit('on-update-photos')
              //this.showShareGroup = true
              this.groupLink = response.body
              router.push('/')
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
              }
            })
          },
          comingSoon(){
            MintUI.Toast({
              message: 'Sorry, this setting cannot be changed at this time',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyGroupLink(){
            router.push( '/' )
            MintUI.Toast({
              message: 'You just copied the gallery link to your clipboard',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          copyError(){
            MintUI.Toast({
              message: 'Sorry, there was an error copying the gallery link',
              iconClass: 'icon icon-error',
              duration: 2000
            })
          },
          changePublic(){
            this.pubHidden = !this.pubHidden
          },
          modSync(){
            this.feedsVisible = true
          },
          closeFeeds(){
            this.feedsVisible = false
          },
          doAddFeed(){
            this.feeds.push(this.addFeed)
            this.addFeed = ''
          },
          dropFeed(idx){
            this.feeds.splice( idx, 1 )
          },
          doFindFeeds(){
            this.findSpinnerHidden = false
            this.findDisabled = true
            Vue.http.post( 'findFeeds', {
              site:this.findFeeds
            }).then( ( response ) => {
              if ( !!response.body ) {
                this.foundFeeds = response.body
                if (this.foundFeeds.length === 0){
                  this.findMessageHidden = false
                } else {
                  this.findMessageHidden = true
                }
              }
              this.findDisabled = false
              this.findSpinnerHidden = true
            })
          },
          subFeed(link,title,idx){
            this.foundFeeds.splice( idx, 1 )
            this.feeds.push(link)
          },
          onFileChange(fieldName, fileList) {
            this.spinnerHidden = false
            const formData = new FormData()
            if (!fileList.length) return
            Array
              .from(Array(fileList.length).keys())
              .map(x => {
                formData.append(fieldName, fileList[x], fileList[x].name)
              })
            this.$http.post ( this.uploadXmlTo + '?field=feedfile', formData ).then(function (response) {
              this.feeds = response.body
              this.spinnerHidden = true
            })
          },
          onHeaderPhotoChange(fieldName, fileList) {
            this.spinnerHidden = false
            const formData = new FormData()
            if (!fileList.length) return
            Array
              .from(Array(fileList.length).keys())
              .map(x => {
                formData.append(fieldName, fileList[x], fileList[x].name)
              })
            this.$http.post ( 'headerPhotoFile' + '?id=' + this.id +'&field=image', formData ).then(function (response) {
              this.spinnerHidden = true
            })
          },
          changeCal(){
            this.shareLinks = false
          },
          changeLinks(){
            this.shareCal = false
          }
        },
        template: `
          <div class="feedwrap">
            <mt-header title="Rp.ly">
              <!--<router-link :to="'/showGroups/' + idx" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>-->
              <mt-button slot="left" @click="$router.go(-2)" icon="back">back</mt-button>
            </mt-header>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
            <mt-field label="Gallery Name:" placeholder="Name.." v-model="name"></mt-field>
            <!--<mt-cell title=""><img class="img" :src="'myFile?staged=1&field=image&name=' + image" /></mt-cell>-->
            <!--<file-upload btn-label="Set Header Photo" @change="stagedUpload('image')" :url="uploadTo + '?field=image'"></file-upload>-->
            <!--<mt-button v-on:click="quickContact()" size="large">Add Contact</mt-button>-->
            <mt-cell title="Public"><mt-switch v-model="public" @change="changePublic()"></mt-switch></mt-cell>
            <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Name:" placeholder="Name.." v-model="publicName"></mt-field>
            <mt-cell><vue-editor v-model="publicBio"></vue-editor></mt-cell>
            <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Bio:" placeholder="Bio.." type="textarea" rows="4" v-model="publicBio"></mt-field>
            <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Home Page:" placeholder="Link.." v-model="publicLink"></mt-field>
            <h3 v-bind:class="{'is-hidden':!pubHidden}">Linked Galleries:</h3>
            <mt-checklist v-bind:class="{'is-hidden':!pubHidden}"
              v-model="publicGroups"
              :options="optGroups"
              align="left">
            </mt-checklist>
            <mt-cell v-bind:class="{'is-hidden':!pubHidden}" title=""><img class="img" :src="'myFile?staged=1&field=publicImage&name=' + publicImage" /></mt-cell>
            <file-upload accept="image/*" v-bind:class="{'is-hidden':!pubHidden}" btn-label="Change Author Photo" @change="stagedUpload('publicImage')" :url="uploadTo + '?field=publicImage'"></file-upload>
            <mt-field label="Custom Link rp.ly/..." placeholder="" v-model="publicPath"></mt-field>
            <mt-cell title="Advanced Options"><mt-switch v-model="optsHidden"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}"  title="Resize photos"><mt-field v-model="maxRes" label="max. width in pixels"></mt-field><mt-switch v-model="doScale"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Block members from saving photos"><mt-switch v-model="blockDownloads"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Allow members to post"><mt-switch v-model="allowPosts"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Allow article/link posts"><mt-switch v-model="shareLinks" @change="changeLinks()"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Allow calendar posts"><mt-switch v-model="shareCal" @change="changeCal()"></mt-switch></mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Import content from feeds">
              <mt-button class="underpic" v-on:click="modSync()" size="large">Sync...</mt-button>
            </mt-cell>
            <mt-cell v-bind:class="{'is-hidden':!optsHidden}" title="Change Header Photo">
              <input type="file" name="headerphotofile" id="headerphotofile"
                @change="onHeaderPhotoChange($event.target.name, $event.target.files); fileCount = $event.target.files.length"
                accept="image/*" class="input-headerphoto" />
            </mt-cell>
            <mt-button class="underpic" v-on:click="modGroups()" size="large">Save</mt-button>
            <mt-popup class="addcontact" v-model="showAddContact" position="middle">
              <mt-field :state="validName" placeholder="Name" @keyup.native="checkConName" v-model="newName"></mt-field>
              <mt-field :state="validContact" @keyup.native="checkContact" placeholder="Email or Phone..." v-model="newContact" type="email"></mt-field>
              <mt-button v-on:click="cancelContact()">Cancel</mt-button>&nbsp;<mt-button v-on:click="saveContact()" type="primary">Add Contact</mt-button>
            </mt-popup>
            <mt-popup class="help_popup" v-model="feedsVisible" position="middle">
              <mt-header>
                <a v-on:click="closeFeeds()" slot="right">
                  <mt-button>Close</mt-button>
                </a>
              </mt-header>
              <mt-cell v-for="(url, idx) in feeds">
                <mt-field v-model="url"></mt-field>
                <a v-on:click="dropFeed(idx)">
                  <mt-button>X</mt-button>
                </a>
              </mt-cell>
              <mt-field placeholder="Paste a feed link..." v-model="addFeed"></mt-field>
              <mt-button v-on:click="doAddFeed()" size="large">Save Feed</mt-button>
              <mt-field placeholder="Name of web site or keywords..." v-model="findFeeds"></mt-field>
              <mt-button v-on:click="doFindFeeds()" :disabled="findDisabled" size="large">Find Feeds</mt-button>
              <mt-spinner v-bind:class="{'is-hidden':findSpinnerHidden}" type="snake"></mt-spinner>
              <mt-cell v-bind:class="{'is-hidden':findMessageHidden}" title="No Feeds Found"></mt-cell>
              <mt-cell v-for="(feed, idx) in foundFeeds" :title="feed.title">
                <a v-on:click="subFeed(feed.link,feed.title,idx)">
                  <mt-button>&plus;</mt-button>
                </a>
              </mt-cell>
              <label for="feedsfile" class="feedsinput">Click here to choose a feeds file from your computer (opml/xml):</label>
              <input type="file" name="file" id="feedsfile"
                @change="onFileChange($event.target.name, $event.target.files); fileCount = $event.target.files.length"
                accept="text/*" class="input-file" />
              <h1>&nbsp;</h1>
              <mt-checklist v-bind:class="{'is-hidden':!pubHidden}"
                v-model="mergeGroups"
                :options="optGroups"
                align="left">
              </mt-checklist>
             </mt-popup>
            <mt-popup class="addcontact" v-model="showShareGroup" position="middle">
              <mt-cell title="Copy and share this gallery link:"></mt-cell>
              <mt-field v-model="groupLink"></mt-field>
              <mt-button v-clipboard:copy="groupLink" v-clipboard:success="copyGroupLink" v-clipboard:error="copyError">Copy Link</mt-button>
              <mt-button v-on:click="closeShareGroup()">Close</mt-button>
            </mt-popup>
          </div>`
      }
      const Groups = {
        data() {
          return {
            spinnerHidden : true,
            uploadTo : 'uploadFile',
            selected : 'tab1',
            items : [],
            tabsHidden: false,
            groups: [],
            abilities:[],
            editHidden:true,
            groupsHidden:false,
            postto:[],
            comet:'',
            name : '',
            image: '',
            public: false,
            publicName: '',
            publicBio: '',
            publicImage: '',
            publicLink: '',
            publicPath: '',
            publicGroups: [],
            pubHidden: false,
            optGroups:[],
            upLabel: 'Set Author Photo',
            saveDisabled: true,
            othergroups:[]
          }
        },
        props: {groups: Array},
        watch: {
          '$route' (to, from) {
            this.tabsHidden = false
          }
        },
        components:{
          'show-groups' : showGroups
        },
        created() {
          this.getGroups()
          Vue.http.get( 'getPosts' ).then( ( response ) => {
            if ( !!response.body ) {
              this.optGroups = response.body[1]
            }
          })
        },
        methods: {
          showAddGroupForm() {
            this.selected = "tab2"
          },
          hideAddGroupForm() {
            this.selected = "tab1"
          },
          cometAdd(item) {
            this.items.unshift(item)
          },
          hideTabs() {
            this.tabsHidden = true
          },
          getGroups() {
            this.spinnerHidden = false
            Vue.http.get( 'getGroups').then( ( response ) => {
              if ( !!response.body ) {
                this.items = response.body[0]
                this.groups = response.body[1]
                this.othergroups = response.body[4]
                this.abilities = response.body[2]
                if (this.abilities.indexOf("modSource Code") > -1) {
                  this.editHidden = false
                }
                if (this.groups.length < 2) {
                  this.groupsHidden = true
                  this.postto = [this.groups[0].value]
                }
                if (this.comet == '') {
                  this.comet = response.body[3]
                  //var socket = io( '/rplygroups/' + response.body[3] )
                  //socket.on( 'new item', this.cometAdd )
                }
                for (var i = 0; i < this.items.length; i++) {
                  if ("undefined" == typeof this.items[i].image) {
                    this.items[i].image = ''
                  }
                  if (parseInt(this.items[i].id) == parseInt(this.$route.params.grid)) {
                    router.push('/modGroups/' + i)
                  }
                }
                //if (this.items[this.items.length - 1].name == 'My Photos') {
                //  router.push('/modGroups/' + (this.items.length - 1))
                //}
              }
              this.spinnerHidden = true
            })
          },
          addGroups(){
            this.spinnerHidden = false
            Vue.http.post( 'addGroups', {
              recips:JSON.stringify(this.postto),
              name : this.name,
              public: this.public,
              publicName: this.publicName,
              publicBio: this.publicBio,
              publicLink: this.publicLink,
              publicPath: this.publicPath,
              publicGroups: JSON.stringify(this.publicGroups)
            }).then( ( response ) => {
              this.selected = 'tab1'
              this.getGroups()
              this.name = ''
              this.publicName = ''
              this.publicBio = ''
              this.publicLink = ''
              this.publicGroups = []
              this.$emit('on-update-list')
              router.push('/')
              //Posts.getContacts()
            })
          },
          stagedUpload(field){
            Vue.http.get( 'stagedFile?field=' + field ).then( ( response ) => {
              if ( !!response.body ) {
                this[field] = response.body
                this.upLabel = 'Change Author Photo'
              }
            })
          },
          getPosts(){
            this.$emit('on-update-photos')
          },
          changePublic(){
            this.pubHidden = !this.pubHidden
          },
          changeName(){
            if (this.name.length === 0) {
              this.saveDisabled = true
            } else {
              this.saveDisabled = false
            }
          },
          showSettings(){
            this.$emit('on-show-menu')
          },
          showHelp(){
            this.$emit('on-show-help')
          }
        },
        template: `
          <div>
            <mt-tab-container v-model="selected">
              <mt-tab-container-item id="tab1">
                <router-view v-bind:items="items" v-bind:othergroups="othergroups" v-bind:groups="groups" v-bind:editHidden="editHidden" @on-update-list="getGroups" @on-tabs-hidden="hideTabs" @on-show-add-group="showAddGroupForm" @on-show-help="showHelp" @on-show-settings="showSettings" @on-update-photos="getPosts" />
              </mt-tab-container-item>
              <mt-tab-container-item id="tab2">
                <mt-header title="Rp.ly">
                  <a slot="left">
                    <mt-button slot="left" @click="hideAddGroupForm()" icon="back">back</mt-button>
                  </a>
                </mt-header>
                <mt-field label="Gallery Name:" placeholder="Your Gallery Name.." @keyup.native="changeName()" v-model="name"></mt-field>
                <mt-cell title="Public"><mt-switch v-model="public" @change="changePublic()"></mt-switch></mt-cell>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Name:" placeholder="Name.." v-model="publicName"></mt-field>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Bio:" placeholder="Bio.." type="textarea" rows="4" v-model="publicBio"></mt-field>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Author Home Page:" placeholder="Link.." v-model="publicLink"></mt-field>
                <mt-field v-bind:class="{'is-hidden':!pubHidden}" label="Custom Link rp.ly/..." placeholder="" v-model="publicPath"></mt-field>
                <h3 v-bind:class="{'is-hidden':!pubHidden}">Linked Galleries:</h3>
                <mt-checklist v-bind:class="{'is-hidden':!pubHidden}"
                  v-model="publicGroups"
                  :options="optGroups"
                  align="left">
                </mt-checklist>
                <mt-cell v-bind:class="{'is-hidden':!pubHidden}" title=""><img class="img" :src="'myFile?staged=1&field=publicImage&name=' + publicImage" /></mt-cell>
                <file-upload accept="image/*" v-bind:class="{'is-hidden':!pubHidden}" :btn-label="upLabel" @change="stagedUpload('publicImage')" :url="uploadTo + '?field=publicImage'"></file-upload>
                <mt-button class="buttonset" v-on:click="addGroups()" size="large" :disabled="saveDisabled">Save</mt-button>
                <!--<mt-button class="buttonset" v-on:click="hideAddGroupForm()" size="large">
                    Cancel
                </mt-button>-->
                <mt-cell></mt-cell>
              </mt-tab-container-item>
            </mt-tab-container>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const Subscribers = {
        data() {
          return {
            spinnerHidden : true,
            items : [],
            comet : ''
          }
        },
        created() {
          this.getSubscribers()
        },
        methods: {
          cometAdd(item) {
            this.items.unshift(item)
          },
          getSubscribers() {
            this.spinnerHidden = false
            Vue.http.get( 'getSubscribers').then( ( response ) => {
              if ( !!response.body ) {
                this.items = response.body
              }
              this.spinnerHidden = true
            })
          }
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
              <router-link to="/" slot="left">
                <mt-button icon="back">back</mt-button>
              </router-link>
            </mt-header>
            <mt-cell title="Amount - Date - Gallery - From"></mt-cell>
            <mt-cell v-for="(item, idx) in items" :title="item.amount + ' - ' + item.date + ' - ' + item.gallery + ' - ' + item.name"></mt-cell>
            <mt-spinner v-bind:class="{'is-hidden':spinnerHidden}" type="snake"></mt-spinner>
          </div>`
      }
      const MidMenu = {
        data() {
          return {
          }
        },
        props: {subsHidden: Boolean, groups: Array},
        created() {
        },
        methods: {
        },
        template: `
          <div>
            <mt-header title="Rp.ly">
            </mt-header>
            <mt-cell is-link to="/groups" title="Galleries"></mt-cell>
            <mt-cell is-link to="/contacts" title="Contacts"></mt-cell>
            <mt-cell v-if="!subsHidden" is-link to="/subs" title="Payments"></mt-cell>
            <mt-cell></mt-cell>
          </div>`
      }
      const router = new VueRouter({routes:[
        { path: '', component: Posts,
          children: [{
            path: 'showPosts/:idx',
            components:{default: listPosts, middletab: MidMenu, righttab: showPosts}
        },{
            path: 'showPost/:postid',
            components:{default: showPost, middletab: MidMenu, righttab: showPost}
        },{
            path: 'modPosts/:idx',
            component: modPosts
        },{
            path: 'modLinkPost/:id',
            components:{default: listPosts, middletab: MidMenu, righttab: modLinkPost}
        },{
            path: 'showGroupPosts/:grpid',
            components:{default: listPosts, middletab: MidMenu, righttab: showGroupPosts}
        },{
            path: '',
            components:{ default: listPosts, middletab: MidMenu, righttab: Groups },
            children:[{
                      path: '',
                      component: listGroups
                  }]
        },{
            path: 'tab2',
            components:{ default: listPosts, middletab: MidMenu, righttab: Groups },
            children:[{
                      path: '',
                      component: listGroups
                  }]
        },{
            path: 'tab3',
            components:{ default: listPosts, middletab: MidMenu, righttab: Groups },
            children:[{
                      path: '',
                      component: listGroups
                  }]
        },{
          path: '/groups/:grid', components:{ default: listPosts, middletab: MidMenu, righttab: Groups },
                    children: [{
                      path: '/showGroups/:idx',
                      component: showGroups
                  },{
                      path: '/modGroups/:idx',
                      component: modGroups
                  },{
                      path: '/groups/new',
                      component: listGroups
                  }]
        },{
          path: '/contacts', components:{default: listPosts, middletab: Contacts},
                    children: [{
                      path: '/showContacts/:idx',
                      component: showContacts
                  },{
                      path: '/modContacts/:idx',
                      component: modContacts
                  },{
                      path: '',
                      component: listContacts
                  }]
        },{
            path: '/subs',
            components:{default: listPosts, middletab: Subscribers}
        }
      
      ]},{
            path: '/connect/:code',
            component: connect
        },{
            path: '/showgroup/:grp',
            component: GroupPage
        },{
            path: '/pubgroup/:grp',
            component: PublicGroupPage
        },{
            path: '/postgroup/:grp',
            component: PublicPostPage
        },{
            path: '/myposts/:grp',
            component: PublicMyPostsPage
        },{
            path: '/group/:grp',
            component: ShowGroupPage,
            children: [{
              path: '/tourStart/:grp',
              component: tourStart
            },{
              path: '/contactForm/:grp',
              component: contactForm
            }]
        },{
            path: '/login',
            component: freeTrial
        },{
            path: '/tourStart',
            component: tourStart
        },{
            path: '/login/:grp',
            component: freeTrial
        },{
            path: '/reset',
            component: freeTrial
        },{
            path: '/auth',
            component: freeTrial
        },{
            path: '/auth/:grp',
            component: freeTrial
        },{
            path: '/authpost/:postid',
            component: freeTrial
        }
      ]})
      const vueApp = new Vue({
        router
      }).$mount('#app')
    </script>

  </body>
  <script type="python" id="server">

@app.route('/addInquiry',methods=['GET','POST'])
def addInquiry():
  message = Mail(
    from_email=' Request at ' + mydomain + ' <' + os.getenv('SENDGRID_FROM') + '>',
    to_emails=os.getenv('SENDGRID_FROM'),
    subject='' + mydomain + ' business inquiry',
    html_content='<p>FROM ' + request.form.get('email') + ' - ' + request.form.get('body') + '</p>')
  sg = SendGridAPIClient(sendgrid_token)
  response = sg.send(message)
  return 'OK'

@app.route('/syncGroups',methods=['GET','POST'])
def syncGroups():
  groups = get_all('groups')
  grp = 0
  added = 0
  feeds = []
  grps = {}
  for gr in groups:
    if not gr['feeds'] is None:
      if gr['feeds'][:1] == '[':
        groupfeeds = json.loads(gr['feeds'])
        code = request.args.get('code')
        if not code is None:
          if not gr['key'] == request.args.get('code'):
            continue
        path = request.args.get('paths')
        if not path is None:
          if not gr['publicPath'] in request.args.get('paths').split(','):
            continue
        grp = int(gr['id'])
        grpowner = int(gr['user_id'])
        items = []
        for fd in groupfeeds:
          if not fd in feeds:
            feeds.append(fd)
          if not fd in grps:
            grps[fd] = [int(gr['id'])]
          else:
            grps[fd].append(int(gr['id']))
  for fd in feeds:
    timingout = False
    time.sleep(0.6)
    user_agent = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36'
    headers = {'User-Agent': user_agent}
    try:
      resp = requests.get(fd,headers=headers,timeout=10)
    except:
      continue
    content = BytesIO(resp.content)
    try:
      feed = feedparser.parse(content)
    except:
      continue
    if not feed.bozo:
      items = []
      for item in feed.entries:
        if 'link' in item:
          upd = ''
          if 'published' in item:
            upd = item['published']
          if 'published_parsed' in item:
            try:
              if not item['published_parsed'] is None:
                upd = datetime.fromtimestamp(round(time.mktime(item['published_parsed'][:8] + (-1,))))
            except (ValueError):
              pass
          elif 'updated_parsed' in item:
            try:
              if not item['updated_parsed'] is None:
                upd = datetime.fromtimestamp(round(time.mktime(item['updated_parsed'][:8] + (-1,))))
            except (ValueError):
              pass
          if not upd == '':
            item['published'] = str(upd)
            items.append(item)
          #else:
            #print('SKIP NO TIME ' + fd)
            #posts = get_one_by('posts',item['link'],'link')
            #if len(posts) > 0:
            #  del_one('posts',posts[0]['id'])
            #  print('DEL ' + item['link'] + "\n")
      items.sort(key=lambda p: p['published'], reverse=True)
      newest = []
      for item in items[:5]:
        if not 'title' in item:
          item['title'] = ''
          if 'description' in item:
            item['title'] = item['description']
          else:
            if 'content' in item:
              item['title'] = item['content']
        newest.append(item['link'])
        #print('NEW 5 ' + item['published'] + ' ' + item['title'])
      pubcount = 0
      for item in items:
        urlkey = ''.join(re.findall('[a-zA-Z0-9_]',item['link']))
        saved = get_one_by( 'cached', urlkey, 'urlkey' )
        if len(saved) > 0:
          if not int(saved[0]['result']) > 0:
            pubcount = pubcount + 1
        if not item['link'] in newest:
          posts = get_one_by('posts',item['link'],'link')
          if len(posts) > 0:
            del_one('posts',posts[0]['id'])
            posts = get_one_by('posts',item['link'],'link')
            if len(posts) > 0:
              print('DID NOT DEL ' + item['link'])
            if not 'title' in item:
              item['title'] = ''
              if 'description' in item:
                item['title'] = item['description']
              else:
                if 'content' in item:
                  item['title'] = item['content']
            if 'title' in item and pubcount > 4:
              print('DEL ' + item['published'] + ' ' + item['title'])
      for item in items[:5]:
        urlkey = ''.join(re.findall('[a-zA-Z0-9_]',item['link'] + item['published']))
        saved = get_one_by( 'cached', urlkey, 'urlkey' )
        if not len(saved) > 0:
          if timingout:
            continue
          if not 'title' in item:
            item['title'] = ''
            if 'description' in item:
              item['title'] = item['description']
            else:
              if 'content' in item:
                item['title'] = item['content']
              #else:
              #  continue
          if 'link' in item:
            if item['link'][-4:].lower()  in ['.mov','.mp4','.mp3','.m4v','.wav']:
              continue
            posts = get_one_by('posts',item['link'],'link')
            if len(posts) > 0 and not 'weather' in item['link'].lower():
              continue
            else:
              print('NEW ' + item['title'])
            foundtitle = item['title']
            newrec = {
              'title' : '',
              'image' : '',
              'sound' : '',
              'video' : '',
              'groups' : json.dumps(grps[fd]),
              'inreplyto' : '',
              'link':item['link'],
              'user_id' : grpowner,
              'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
            }
            user_agent = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36'
            headers = {'User-Agent': user_agent}
            try:
              html = requests.get(item['link'],headers=headers,timeout=5)
            except (requests.exceptions.ConnectionError, requests.exceptions.Timeout):
              timingout = True
              print('TIMING OUT ' + fd)
              #continue
            except requests.exceptions.HTTPError:
              timingout = True
              print('HTTP ERROR ' + fd)
              continue
            except requests.exceptions.TooManyRedirects:
              timingout = True
              print('REDIR ERROR ' + fd)
              continue
            flagged = 1
            if item['link'] == fd:
              continue
            if not timingout:
              if not 'content-type' in html.headers:
                print('SKIP NO CT ' + item['link'])
                print(str(html.headers))
                continue
              if 'content-type' in html.headers:
                if not 'text/html' in html.headers['content-type'].lower():
                  print('SKIP NOT OK CT ' + item['link'])
                  print(str(html.headers))
                  #continue
                if 'text/html' in html.headers['content-type'].lower():
                  try:
                    opengraphe = OpenGraphExtractor()
                  except:
                    continue
                  titleset = False
                  imageset = False
                  flagged = moderationCheck(item['link'], True, str(html.text))
                  data = opengraphe.extract(str(html.text))
                  mytitle = ''
                  myimage = ''
                  if data:
                    if len(data) > 0:
                      for prop in data[0]['properties']:
                        foundtit = False
                        foundimg = False
                        for ogdata in prop:
                          if not titleset or not imageset:
                            if foundtit:
                              mytitle = '<h1 class="article_hed">' + ogdata + '</h1>'
                              titleset = True
                              foundtit = False
                            if ogdata == 'og:title':
                              foundtit = True
                            if foundimg:
                              myimage = '<div class="feedimages"><img class="article_img" src="' + ogdata + '" alt="Image" /></div>'
                              imageset = True
                              foundimg = False
                            if ogdata == 'og:image':
                              foundimg = True
                    if mytitle != '':
                      newrec['title'] = mytitle + myimage
            if 'weather' in item['link'].lower():
              newrec['title'] = '<h1 class="article_hed">' + foundtitle + '</h1>'
              newrec['title'] = newrec['title'] + '<div class="feedimages"><img class="article_img" src="' + 'file/weather.jpg' + '" alt="Image" /></div>'
              flagged = 0
            if newrec['title'] == '':
              newrec['title'] = newrec['title'] + '<h1 class="article_hed">' + foundtitle + '</h1>'
            if not flagged > 0:
              rid = add_one( 'posts', newrec )
              added = added + 1
            else:
              print('FILTER - ' + str(len(str(html.text).split())) + ' words, ' + item['link'])
            time.sleep(0.9)
            #if added == 40:
            #  print('ADDED 40')
            #  return 'OK'
  print('DONE')
  return 'OK'

@app.route('/headerPhotoFile',methods=['GET','POST'])
def headerPhotoFile():
  filedata = {}
  if request.method == 'POST':
    gid = request.args.get('id')
    grpdata = get_one('groups',gid)
    if 'user_id' in grpdata[0]:
      curr = current_user()
      if int(curr['id']) == int(grpdata[0]['user_id']):
        if 'headerphotofile' in request.files:
          file = request.files['headerphotofile']
          if not file.filename == '':
            fi = tempfile.NamedTemporaryFile(delete=False)
            file.save(fi.name)
            filedata['tmp_name'] = fi.name
            filedata['name'] = file.filename
            fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
            filepath = appdir + 'myfiles/' + fname
            copyfile(filedata['tmp_name'], filepath)
            try:
              image=Image.open(filepath)
              for orientation in ExifTags.TAGS.keys():
                if ExifTags.TAGS[orientation]=='Orientation':
                  break
              exif=dict(image._getexif().items())
              if exif[orientation] == 3:
                image=image.rotate(180, expand=True)
              elif exif[orientation] == 6:
                image=image.rotate(270, expand=True)
              elif exif[orientation] == 8:
                image=image.rotate(90, expand=True)
              image.save(filepath)
              image.close()
            except:
              pass
            newrec = {
              'title' : '',
              'image' : fname,
              'sound' : '',
              'video' : '',
              'groups' : json.dumps([]),
              'inreplyto' : '',
              'link':'',
              'user_id' : session['user'],
              'flagged' : '0',
              'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
            }
            rid = add_one( 'posts', newrec )
            newobj = {'image':fname}
            mod_one( 'groups', newobj, gid )
  response = make_response(json.dumps( [ 'OK' ] ))
  return response

@app.route('/syncFile',methods=['GET','POST'])
def syncFile():
  filedata = {}
  if request.method == 'POST':
    if 'file' in request.files:
      file = request.files['file']
      if not file.filename == '':
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
    feeds = []
    with open( filedata['tmp_name'], 'rt') as f:
      tree = etree.parse(f)
    if tree:
      for node in tree.findall('.//outline'):
        url = node.attrib.get('xmlUrl')
        title = node.attrib.get('title')
        feedtitle = ''
        if title:
          feedtitle = title
        else:
          title = node.attrib.get('text')
          if title:
            feedtitle = title[:15]
        fp = urllib.parse.urlparse(url)
        if fp.hostname:
          feedtitle = feedtitle + ' - ' + fp.hostname
        if url:
          feeds.append(url)
    response = make_response(json.dumps( feeds ))
    return response
  return json.dumps( [ 'error' ] )

@app.route('/sendResetPwd',methods=['POST'])
def sendResetPwd():
  em = request.form.get('email').lower()
  item = get_one_by( 'resetcodes', em, 'email' )
  if len(item) > 0:
    ccd = item[0]['code']
  else:
    ccd = randomword(18)
    add_one('resetcodes',{
      'email':em,
      'code':ccd
    })
  message = Mail(
    from_email=' Request at ' + mydomain + ' <' + os.getenv('SENDGRID_FROM') + '>',
    to_emails=em,
    subject='The ' + mydomain + ' link you requested',
    html_content='<strong>Your link for ' + mydomain + 'password reset<a href="https://' + mydomain + '/doResetPwd?ccd=' + ccd + '"><h2>Reset Password</h2></a></strong>')
  sg = SendGridAPIClient(sendgrid_token)
  response = sg.send(message)
  return ''

@app.route('/doResetPwd',methods=['GET'])
def doResetPwd():
  code = request.args.get('ccd')
  item = get_one_by( 'resetcodes', code, 'code' )
  if len(item) > 0:
    del_one( 'resetcodes', item[0]['id'] )
    email = item[0]['email']
    usrs = get_one_by('contacts',email,'email')
    if len(usrs) > 0:
      for usr in usrs:
        if usr['user_id'] is None:
          u = usr['id']
          session.permanent = True
          session['user'] = str(u)
          return redirect("https://" + mydomain + "/#/reset", code=302)
  return json.dumps( [ 'Error' ] )

@app.route('/saveResetPwd',methods=['POST'])
def saveResetPwd():
  if not 'user' in session:
    return json.dumps( [ 'Error' ] )
  id = session['user']
  ct = get_one( 'contacts', id )[0]
  mod_one( 'contacts', {"password":getHashedPass(request.form.get("pass").encode('utf-8'))}, ct['id'] )
  return json.dumps( [ 'OK' ] )

@app.route('/modFeedSett',methods=['POST'])
def modFeedSett():
  if not 'user' in session:
    return json.dumps([])
  settkey = 'filterDisabled'
  thefeed = request.form.get('feedlink').lower()
  items = get_one_by( 'settings', settkey, 'name' )
  mysett = [thefeed]
  if len(items) > 0:
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mysett = json.loads(sett['value'])
        if thefeed in mysett:
          mysett.remove(thefeed)
        else:
          mysett.append(thefeed)
  if not len(items) > 0:
    sett = add_one('settings',{
      'user_id':session['user'],
      'name':settkey,
      'value':json.dumps(mysett)
    })
  else:
    found = False
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mod_one('settings',{'value':json.dumps(mysett)},sett['id'])
        found = True
    if not found:
      sett = add_one('settings',{
        'user_id':session['user'],
        'name':settkey,
        'value':json.dumps(mysett)
      })
  return 'OK'

@app.route('/addList',methods=['POST'])
def addList():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  if not len(items) > 1:
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  feeds = []
  sid = 0
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
  tree = False
  with open(appdir + 'myfiles/' + saveFile('feedfile'), 'rt') as f:
    tree = etree.parse(f)
  if tree:
    for node in tree.findall('.//outline'):
      url = node.attrib.get('xmlUrl')
      title = node.attrib.get('title')
      feedtitle = ''
      if title:
        feedtitle = title
      else:
        title = node.attrib.get('text')
        if title:
          feedtitle = title[:15]
      fp = urllib.parse.urlparse(url)
      if fp.hostname:
        feedtitle = feedtitle + ' - ' + fp.hostname
      if url:
        feeds.append(url)
    mod_one('settings',{'value':json.dumps(feeds)},sid)
  return 'OK'

@app.route('/getShare',methods=['POST'])
def getShare():
  resp = 'OK'
  curr = current_user()
  ugrps = get_one_by( 'groups', curr['id'], 'user_id' )
  rcps = json.loads(request.form.get('recips'))
  gname = ''
  for g in rcps:
    grpdata = get_one('groups',g)
    gname = str(grpdata[0]['name'])
    linkpath = '/grp/' + str(grpdata[0]['key'])
    resp = 'Updated gallery: ' + gname + ' ðŸ“· https://' + mydomain + linkpath
  for ug in ugrps:
    if not ug['public'] is None:
      if int(ug['public']) > 0:
        if not ug['publicGroups'] is None:
          for g in json.loads(ug['publicGroups']):
            if g in rcps:
              linkpath = '/grp/' + str(ug['key'])
              if not ug['publicPath'] == '':
                linkpath = '/' + ug['publicPath']
              resp = ' ðŸ“· new images in ' + gname + ' #shareinanewway #rplyphoto #rplyshare https://' + mydomain + linkpath
              break
  return resp

@app.route('/findFeeds',methods=['GET','POST'])
def findFeeds():
  context = ssl._create_unverified_context()
  regex = re.compile(
    r'^(?:http|ftp)s?://' # http:// or https://
    r'(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+(?:[A-Z]{2,6}\.?|[A-Z0-9-]{2,}\.?)|' #domain...
    r'localhost|' #localhost...
    r'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})' # ...or ip
    r'(?::\d+)?' # optional port
    r'(?:/?|[/?]\S+)$', re.IGNORECASE)
  result = []
  possible_feeds = []
  sites = []
  if "." in request.form.get('site'):
    sites.append('http://' + request.form.get('site'))
  srch = 'https://www.googleapis.com/customsearch/v1?key=' + os.getenv('GOO_KEY') + '&cx=' + os.getenv('GOO_CTX') + '&q=%28feeds+or+rss%29+' + urllib.parse.quote(request.form.get('site'))
  data = urllib.request.urlopen(srch).read()
  arr = json.loads(data)
  if 'items' in arr:
    for search in arr['items']:
      if len(sites) < 2:
        sites.append(search['link'])
  for site in sites:
    try:
      data = urllib.request.urlopen(site).read()
    except urllib.error.HTTPError as err:
      data = False
    except urllib.error.URLError as err:
      data = False
    if data:
      tree = etree.HTML(data)
      parsed_url = urllib.parse.urlparse(site)
      base = parsed_url.scheme+"://"+parsed_url.hostname
      for node in tree.findall('.//link'):
        t = node.attrib.get('type')
        if t:
          if "rss" in t or "xml" in t:
            href = node.attrib.get('href')
            if href:
              if '//' == href[:2]:
                possible_feeds.append('http:'+href)
              elif 'http' == href[:4]:
                possible_feeds.append(href)
              else:
                possible_feeds.append(base+href)
      for node in tree.findall('.//a'):
        href = node.attrib.get('href')
        if href:
          if "xml" in href or "rss" in href or "feed" in href:
            if 'http' == href[:4]:
              possible_feeds.append(href)
            else:
              possible_feeds.append(base+href)
    for url in possible_feeds:
      if re.match(regex, url):
        try:
          data = urllib.request.urlopen(url, timeout=5, context=context).read()
        except urllib.error.HTTPError as err:
          continue
        except urllib.error.URLError as err:
          continue
        except socket.timeout as err:
          continue
        f = feedparser.parse(data)
        if len(f.entries) > 0:
          ftitle = 'News Feed'
          if 'feed' in f:
            if 'title' in f['feed']:
              ftitle = f['feed']['title']
          if {'title':ftitle,'link':url} not in result:
            result.append({'title':ftitle,'link':url})
  if not "." in request.form.get('site'):
    srch = 'https://www.googleapis.com/customsearch/v1?key=' + os.getenv('GOO_KEY') + '&cx=' + os.getenv('GOO_CTX') + '&q=filetype%3Aopml+' + urllib.parse.quote(request.form.get('site'))
    data = urllib.request.urlopen(srch).read()
    arr = json.loads(data)
    mine = []
    if 'items' in arr:
      for searesult in arr['items']:
        if 'github.com' in searesult['link'] and searesult['link'].rstrip()[-4:].lower() == 'opml':
          searesult['link'] = searesult['link'].replace('github.com','raw.githubusercontent.com')
          searesult['link'] = searesult['link'].replace('blob/master','master')
        try:
          data = urllib.request.urlopen(searesult['link'], timeout=5, context=context).read()
        except urllib.error.HTTPError as err:
          data = False
        except urllib.error.URLError as err:
          data = False
        if data:
          ParseError = etree.ParseError
          try:
            tree = etree.fromstring(data)
          except ParseError:
            tree = False
          if tree:
            for node in tree.findall('.//outline'):
              url = node.attrib.get('xmlUrl')
              title = node.attrib.get('title')
              feedtitle = ''
              if title:
                feedtitle = title
              else:
                title = node.attrib.get('text')
                if title:
                  feedtitle = title[:15]
              fp = urllib.parse.urlparse(url)
              if fp.hostname:
                feedtitle = feedtitle + ' - ' + fp.hostname
              if url:
                result.append({'title':feedtitle,'link':url})
          time.sleep(0.1)
  return json.dumps(result)

@app.route('/moderationFlag',methods=['GET','POST'])
def moderationFlag():
  return str(moderationCheck(request.form.get('link'), True))

@app.route('/migrateGall',methods=['GET','POST'])
def migrateGall():
  gall = 0
  newOwner = 0
  grp = get_one( 'groups', gall )[0]
  oldOwner = grp['user_id']
  pst = get_all( 'posts' )
  for p in pst:
    if 'groups' in p:
      if p['groups'] is not None:
        grps = json.loads(p['groups'])
        if gall in grps:
          if len(grps) < 2:
            obj = {'user_id':newOwner}
            mod_one( 'posts', obj, p['id'] )
  cts = get_all( 'contacts' )
  for c in cts:
    if 'groups' in c:
      if c['groups'] is not None:
        grps = json.loads(c['groups'])
        if gall in grps:
          if len(grps) < 2:
            obj = {'user_id':newOwner}
            mod_one( 'contacts', obj, c['id'] )
  ct = get_one( 'contacts', oldOwner )[0]
  if 'groups' in ct:
    if ct['groups'] is not None:
      grps = json.loads(ct['groups'])
      if gall in grps:
        grps.remove(gall)
        obj = {'groups':json.dumps(grps)}
        mod_one( 'contacts', obj, ct['id'] )
  ct = get_one( 'contacts', newOwner )[0]
  if 'groups' in ct:
    if ct['groups'] is not None:
      grps = json.loads(ct['groups'])
      grps.append(gall)
      obj = {'groups':json.dumps(grps)}
      mod_one( 'contacts', obj, ct['id'] )
  obj = {'user_id':newOwner}
  mod_one( 'groups', obj, gall )
  return 'OK'

@app.route('/setGroupNotif',methods=['GET','POST'])
def setGroupNotif():
  item = get_one_by( 'groups', request.form.get('grp'), 'key' )[0]
  settkey = 'group_' + str(item['id'])
  items = get_one_by( 'settings', settkey, 'name' )
  mysett = {
    'phone':'1',
    'email':'1',
    'freq':'2',
    'interval':'Day',
    'last_notif':str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) )
  }
  if len(items) > 0:
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mysett = json.loads(sett['value'])
  mysett['freq'] = request.form.get('freq')
  mysett['interval'] = request.form.get('interval')
  if not len(items) > 0:
    sett = add_one('settings',{
      'user_id':session['user'],
      'name':settkey,
      'value':json.dumps(mysett)
    })
  else:
    found = False
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mod_one('settings',{'value':json.dumps(mysett)},sett['id'])
        found = True
    if not found:
      sett = add_one('settings',{
        'user_id':session['user'],
        'name':settkey,
        'value':json.dumps(mysett)
      })
  return 'OK'

@app.route('/modGroupNotif',methods=['GET','POST'])
def modGroupNotif():
  item = get_one( 'groups', request.form.get('id') )[0]
  settkey = 'group_' + request.form.get('id')
  items = get_one_by( 'settings', settkey, 'name' )
  mysett = {
    'phone':'1',
    'email':'1',
    'freq':'2',
    'interval':'Day',
    'last_notif':str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) )
  }
  if len(items) > 0:
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mysett = json.loads(sett['value'])
  if request.form.get('type') == 'freq':
    mysett['freq'] = request.form.get('value')
  if request.form.get('type') == 'interval':
    mysett['interval'] = request.form.get('value')
  if request.form.get('type') == 'email':
    if request.form.get('value') == 'true':
      mysett['email'] = '1'
    else:
      mysett['email'] = '0'
  if request.form.get('type') == 'phone':
    if request.form.get('value') == 'true':
      mysett['phone'] = '1'
    else:
      mysett['phone'] = '0'
  if not len(items) > 0:
    found = False
    sett = add_one('settings',{
      'user_id':session['user'],
      'name':settkey,
      'value':json.dumps(mysett)
    })
  else:
    found = False
    for sett in items:
      if int(session['user']) == int(sett['user_id']):
        mod_one('settings',{'value':json.dumps(mysett)},sett['id'])
        found = True
    if not found:
      sett = add_one('settings',{
        'user_id':session['user'],
        'name':settkey,
        'value':json.dumps(mysett)
      })
  return 'OK'

@app.route('/getGroupEmbed',methods=['GET','POST'])
def getGroupEmbed():
  invitetext = ' invited you to join '
  os.chdir(appdir)
  items = get_one_by( 'groups', request.args.get('grp'), 'key' )
  if not len(items) > 0:
    items = get_one( 'groups', request.args.get('grp') )
  ispublic = False
  if len(items) > 0:
    if 'public' in items[0]:
      if not items[0]['public'] is None:
        if int(items[0]['public']) > 0:
          ispublic = True
  result = []
  if len(items) > 0:
    owner = get_user(items[0]['user_id'])
    imgsrc = ''
    if not items[0]['image'] is None:
      imgsrc = urllib.parse.quote(items[0]['image'])
    if not ispublic:
      html = '<div style="font-family:courier,monospace;width:90%"><img alt="gallery image for ' + items[0]['name'] + '" style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://' + mydomain + '/grpFile?field=image&name='
      html = html + imgsrc + '" /><p style="text-align:center;display:block;padding:10px;">' + owner['name'] + invitetext + items[0]['name'] + '</p><a style="text-align:center;background-color:#32e0c4;display:block;color:black;text-decoration:none;padding:10px;" href="https://' + mydomain + '/grp/' +  items[0]['key'] + '">' + 'Join ' + owner['name'] + "'s Gallery" + '</a></div>'
    else:
      html = '<img style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://' + mydomain + '/' + 'grpFile?field=publicImage&name=' + urllib.parse.quote(items[0]['publicImage']) + '" />'
      html = html + '<h3>' + items[0]['publicName'] + '</h3>'
      html = html + '<p><a href="' + items[0]['publicLink'] + '">' + items[0]['publicLink'] + '</a></p>'
      html = html + '<h5 class="public_bio">' + items[0]['publicBio'] + '</h5>'
      html = html + '<h3>' + items[0]['name'] + '</h3>'
      pubs = get_one_by('posts',owner['id'],'user_id')
      for item in pubs:
        pgrps = json.loads(item['groups'])
        if items[0]['id'] in pgrps:
          item['imageHidden'] = False
          item['textHidden'] = True
          if item['image'] == '':
            item['imageHidden'] = True
          item['soundHidden'] = False
          if item['sound'] == '':
            item['soundHidden'] = True
          if item['image'] == '' and item['sound'] == '':
            item['textHidden'] = False
            if item['title'] == '':
              item['title'] = '(untitled)'
          item['isVideo'] = False
          if not item['video'] == '':
            item['imageHidden'] = True
            item['isVideo'] = True
            if item['title'] == '':
              item['title'] = '(untitled)'
          html = html + '<div class="imagecell public_img">'
          if not item['textHidden']:
            html = html + '  <p class="caption">' + item['title'] + '</p>'
          html = html + '  <div class="outer">'
          if int(items[0]['blockDownloads']) > 0:
            html = html + '    <img style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://' + mydomain + '/' + 'myFile?field=image&name=' + item['image'] + '" />'
          else:
            html = html + '    <img style="height:auto;padding:30px;display:block;margin-left:auto;margin-right:auto;width:50%;padding:10px;" src="https://' + mydomain + '/' + 'myFile?field=image&name=' + item['image'] + '" />'
          html = html + '    <figcaption class="caption underpic">' + item['title'] + '</figcaption>'
          if not item['soundHidden']:
            html = html + '    <audio-player src="https://' + mydomain + '/' + 'myFile?field=sound&name=' + item['sound'] + '" />'
          html = html + '  </div>'
          if item['isVideo']:
            html = html + '  <vue-plyr>'
            html = html + '    <video poster="https://' + mydomain + '/' + 'myFile?field=image&name=' + item['image'] + '" src="https://' + mydomain + '/' + 'myFile?field=video&name=' + item['video'] + '" controls />'
            html = html + '    <figcaption class="caption">' + item['title'] + '</figcaption>'
            html = html + '  </vue-plyr>'
          if item['imageHidden']:
            html = html + '  <audio-player src="https://' + mydomain + '/' + 'myFile?field=sound&name=' + item['sound'] + '" />'
          html = html + '</div>'
      pgrps = json.loads(items[0]['publicGroups'])
      for pgrp in pgrps:
        g = get_one('groups',pgrp)
        if len(g) > 0:
          html = html + '<a href="https://' + mydomain + '/#/showgroup/' + g[0]['key'] + '">'
          html = html + '  <h3 style="text-decoration:none;">' + g[0]['name'] + '</h3>'
          html = html + '  <img style="height:auto;padding:10px;display:block;margin-left:auto;margin-right:auto;width:200px;padding:10px;" src="https://' + mydomain + '/grpFile?field=image&name=' + g[0]['image'] + '" />'
          html = html + '</a>'
    response = make_response(html)
    response.mimetype = "text/html"
    regex = re.compile('[^a-zA-Z]')
    finame = regex.sub('', items[0]['name'])
    response.headers["Content-disposition"] = "attachment; filename=" + finame + '.html'
    return response
  return 'Error'

@app.route('/getSubscribers', methods=['GET','POST'])
def getSubscribers():
  subs = []
  curr = current_user()
  ugrps = get_one_by('groups',curr['id'],'user_id')
  ugrids = []
  for gr in ugrps:
    ugrids.append(str(gr['id']))
  if not os.getenv('BT_ID') is None:
    search_results = gateway.subscription.search(
      braintree.SubscriptionSearch.status.in_list(
        braintree.Subscription.Status.Active,
        braintree.Subscription.Status.Canceled,
        braintree.Subscription.Status.Expired,
        braintree.Subscription.Status.PastDue,
        braintree.Subscription.Status.Pending
      )
    )
    for sub in search_results:
      grpid = ''.join(x for x in sub.id if x.isdigit())
      if grpid in ugrids:
        items = get_one( 'groups', grpid )
        if len(items) > 0:
          owner = get_user(items[0]['user_id'])
          grpn = items[0]['name']
          for tr in sub.transactions:
            subs.append({'name':tr.customer_details.first_name,'gallery':grpn,'date':str(sub.created_at),'amount':'${:0,.2f}'.format(round(float(tr.amount) * 0.9,3))})
  return( json.dumps( subs ) )

@app.route('/delSponsor', methods=['GET','POST'])
def delSponsor():
  result = gateway.subscription.cancel(request.form.get('id'))
  return 'OK'

@app.route('/btSubs', methods=['GET','POST'])
def btSubs():
  subs = []
  if not os.getenv('BT_ID') is None:
    curr = current_user()
    if not curr['phone'] == '':
      collection = gateway.customer.search(
        braintree.CustomerSearch.phone == curr['phone']
      )
    if not curr['email'] == '':
      collection = gateway.customer.search(
        braintree.CustomerSearch.email == curr['email']
      )
    if not collection is None:
      if len(list(collection.items)) > 0:
        customer = list(collection.items)[0]
        if len(customer.credit_cards) > 0:
          for sub in customer.credit_cards[0].subscriptions:
            if sub.status == 'Active':
              owner = {'name':''}
              grpn = ''
              grpid = ''.join(x for x in sub.id if x.isdigit())
              items = get_one( 'groups', grpid )
              if len(items) > 0:
                owner = get_user(items[0]['user_id'])
                grpn = items[0]['name']
              subs.append({'name':owner['name'] + '/' + grpn + ' renews ' + str(sub.next_billing_date),'id':str(sub.id)})
  return( json.dumps( [subs] ) )

@app.route('/btSetup', methods=['GET','POST'])
def btSetup():
  subs = []
  tok = ''
  if not os.getenv('BT_ID') is None:
    tok = gateway.client_token.generate()
    return( json.dumps( [tok,subs] ) )
    curr = current_user()
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      collection = gateway.customer.search(
        braintree.CustomerSearch.email == curr['email']
      )
      if len(list(collection.items)) > 0:
        customer = list(collection.items)[0]
    if len(list(collection.items)) > 0:
      for sub in customer.credit_cards[0].subscriptions:
        if sub.status == 'Active':
          subs.append({'name':'bills $3 on ' + str(sub.next_billing_date),'id':str(sub.id)})
  return( json.dumps( [tok,subs] ) )

@app.route('/doSponsor', methods=['GET','POST'])
def doSponsor():
  response = json.loads(request.form.get('method'))
  curr = current_user()
  collection = 0
  if not curr['phone'] == '':
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
  if not curr['email'] == '':
    collection = gateway.customer.search(
      braintree.CustomerSearch.email == curr['email']
    )
  if not collection == 0:
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      result = gateway.customer.create({
        "first_name": curr['name'],
        "payment_method_nonce": response['nonce'],
        "email": curr['email'],
        "phone": curr['phone']
      })
      if result.is_success:
        customer = result.customer
    if not customer is None:
      if not len(customer.payment_methods) > 0:
        result = gateway.payment_method.create({
          "customer_id": customer.id,
          "payment_method_nonce": response['nonce']
        })
        if not curr['phone'] == '':
          collection = gateway.customer.search(
            braintree.CustomerSearch.phone == curr['phone']
          )
        if not curr['email'] == '':
          collection = gateway.customer.search(
            braintree.CustomerSearch.email == curr['email']
          )
        if len(list(collection.items)) > 0:
          customer = list(collection.items)[0]
      result = gateway.subscription.create({
        "payment_method_token": customer.payment_methods[0].token,
        "plan_id": request.form.get('plan_id'),
        "merchant_account_id":'Fleetcoder_instant',
        "id":randomword(6) + request.form.get('group_id')
      })
      if result.is_success:
        if not customer is None:
          notify_sponsor( request.form.get('plan_id'), request.form.get('group_id'), curr['name'] )
        print("success")
      else:
        print(result.errors)
  return 'OK'

@app.route('/doRegistry', methods=['GET','POST'])
def doRegistry():
  response = json.loads(request.form.get('method'))
  curr = current_user()
  collection = 0
  if not curr['phone'] == '':
    collection = gateway.customer.search(
      braintree.CustomerSearch.phone == curr['phone']
    )
  if not curr['email'] == '':
    collection = gateway.customer.search(
      braintree.CustomerSearch.email == curr['email']
    )
  if not collection == 0:
    if len(list(collection.items)) > 0:
      customer = list(collection.items)[0]
    else:
      result = gateway.customer.create({
        "first_name": curr['name'],
        "payment_method_nonce": response['nonce'],
        "email": curr['email'],
        "phone": curr['phone']
      })
      if result.is_success:
        customer = result.customer
    if not customer is None:
      if not len(customer.payment_methods) > 0:
        result = gateway.payment_method.create({
          "customer_id": customer.id,
          "payment_method_nonce": response['nonce']
        })
        if not curr['phone'] == '':
          collection = gateway.customer.search(
            braintree.CustomerSearch.phone == curr['phone']
          )
        if not curr['email'] == '':
          collection = gateway.customer.search(
            braintree.CustomerSearch.email == curr['email']
          )
        if len(list(collection.items)) > 0:
          customer = list(collection.items)[0]
      result = gateway.subscription.create({
        "payment_method_token": customer.payment_methods[0].token,
        "plan_id": request.form.get('plan_id'),
        "merchant_account_id":'ourtownllc_instant',
        "id":randomword(6) + request.form.get('group_id')
      })
      if result.is_success:
        if not customer is None:
          notify_sponsor( request.form.get('plan_id'), request.form.get('group_id'), curr['name'] )
        print("success")
      else:
        print(result.errors)
  return 'OK'

@app.route('/doCode', methods=['GET','POST'])
def doCode():
  item = get_one_by( 'connectcodes', request.form.get('code'), 'num' )
  if len(item) > 0:
    for conn in item:
      if conn['code'] == request.form.get('connect'):
        del_one( 'connectcodes', conn['id'] )
        usr = get_one_by( 'contacts', request.form.get('connect'), 'code' )
        if len(usr) > 0 and usr[0]['user_id'] is None:
          u = usr[0]['id']
        else:
          if len(usr) > 0:
            if int(usr[0]['user_id']) > 0:
              exists = get_parent(usr[0]['id'])
              if exists['user_id'] is None:
                u = exists['id']
              else:
                ra = randomword(6)
                u = add_one('contacts',{
                  'name':usr[0]['name'],
                  'email':usr[0]['email'].lower(),
                  'phone':usr[0]['phone'],
                  'groups':json.dumps([2]),
                  'code':ra,
                  'created':str(datetime.now())
                })
                newrec = {
                  'name' : 'My Photos',
                  'image':'',
                  'maxres':'2000',
                  'allowPosts':'0',
                  'blockDownloads':'0',
                  'user_id' : u,
                  'key' : randomword(8),
                  'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
                }
                gr1 = add_one( 'groups', newrec )
                con = mod_one('contacts',{'groups': json.dumps([2,gr1])},u)
                update_abilities()
                ra = randomword(6)
                copy = get_user(usr[0]['user_id'])
                copy['user_id'] = u
                copy['groups'] = json.dumps([gr1])
                copy['code'] = ra
                del copy['id']
                con = add_one( 'contacts', copy )
        response = make_response(json.dumps( [ 'OK' ] ))
        session.permanent = True
        session['user'] = str(u)
        return response
  return json.dumps( [ 'Error' ] )

@app.route('/doConnect', methods=['GET','POST'])
def doConnect():
  num = randint(100, 999)
  add_one('connectcodes',{
    'num':num,
    'code':request.form.get('code')
  })
  item = get_one_by( 'contacts', request.form.get('code'), 'code' )
  cont = {}
  if 'user' in session:
    if int(session['user']) == int(item[0]['id']):
      return json.dumps( [ 'OK' ] )
    exists = get_parent(item[0]['id'])
    if 'user_id' in exists and exists['user_id'] is None:
      if int(session['user']) == int(exists['id']):
        return json.dumps( [ 'OK' ] )
  cont['phone'] = item[0]['phone']
  cont['email'] = item[0]['email']
  sentto = ''
  if len(cont['phone']) > 0:
    client = Client(twilio_id, twilio_token)
    rl = "Your code is " + str(num)
    message = client.messages.create(
      body=rl,
      from_='+1' + os.getenv('TWILIO_FROM'),
      to=cont['phone']
    )
    sentto = 'phone number'
  if len(cont['email']) > 0:
    em = cont['email']
    message = Mail(
      from_email=' Request at ' + mydomain + ' <' + os.getenv('SENDGRID_FROM') + '>',
      to_emails=em,
      subject='Your ' + mydomain + ' connection code is ' + str(num),
      html_content='<strong>Your code is ' + str(num) + '</strong>')
    sg = SendGridAPIClient(sendgrid_token)
    response = sg.send(message)
    sentto = 'email address'
  if not sentto == '':
    return json.dumps( [ sentto ] )
  return json.dumps( [ 'Error' ] )

@app.route('/freeTrial', methods=['GET','POST'])
def freeTrial():
  cont = {}
  usr = []
  cont['email'] = request.form.get("email").lower()
  cont['name'] = request.form.get("name")
  cont['pass'] = request.form.get("pass")
  newuser = ''
  if len(cont['email']) > 0:
    newuser = cont['email']
    users = get_one_by('contacts',newuser,'email')
    for usr in users:
      if usr['user_id'] is None:
        return json.dumps( [ 'Error' ] )
  else:
    return json.dumps( [ 'Error' ] )
  os.chdir(appdir)
  email = ''
  ra = randomword(6)
  newgrp = [2]
  u = add_one('contacts',{
    'name':cont['name'],
    'email':cont['email'].lower(),
    'phone':'',
    'password':getHashedPass(cont['pass'].encode('utf-8')),
    'groups':json.dumps(newgrp),
    'code':ra,
    'created':str(datetime.now())
  })
  newrec = {
    'name' : 'My Photos',
    'image':'',
    'maxres':'2000',
    'allowPosts':'0',
    'blockDownloads':'0',
    'user_id' : u,
    'key' : randomword(8),
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  gr1 = add_one( 'groups', newrec )
  con = mod_one('contacts',{'groups': json.dumps(newgrp + [gr1])},u)
  update_abilities()
  response = make_response(json.dumps( [ 'OK' ] ))
  session.permanent = True
  session['user'] = str(u)
  return response

@app.route('/freeTrialLogin', methods=['GET','POST'])
def freeTrialLogin():
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email")
    cont['name'] = request.form.get("name")
    newuser = ''
    if len(cont['phone']) > 0:
      loginuser = cont['phone']
      usr = get_one_by('contacts',loginuser,'phone')
      if len(usr) > 0:
        exists = get_parent(usr[0]['id'])
    if len(cont['email']) > 0:
      loginuser = cont['email']
      usr = get_one_by('contacts',loginuser,'email')
      if len(usr) > 0:
        exists = get_parent(usr[0]['id'])
    if not (len(usr) > 0 and exists['user_id'] is None):
      return json.dumps(['error'])
    num = randint(100, 999)
    cont = {}
    cont['phone'] = request.form.get("phone")
    cont['email'] = request.form.get("email").lower()
    if not request.form.get("pass") is None:
      if checkPass( request.form.get("pass").encode('utf-8'), exists['password'] ):
        u = exists['id']
        response = make_response(json.dumps( [ 'OK' ] ))
        session.permanent = True
        session['user'] = str(u)
        return response
      else:
        return json.dumps( [ 'Error' ] )
    else:
      add_one('connectcodes',{
        'num':num,
        'email':cont['email'],
        'phone':cont['phone']
      })
      if len(cont['phone']) > 0:
        client = Client(twilio_id, twilio_token)
        rl = "Your " + mydomain + " code is " + str(num)
        message = client.messages.create(
          body=rl,
          from_='+1' + os.getenv('TWILIO_FROM'),
          to=cont['phone']
        )
      if len(cont['email']) > 0:
        em = cont['email']
        message = Mail(
          from_email=os.getenv('SENDGRID_FROM'),
          to_emails=em,
          subject='Your ' + mydomain + ' connection code is ' + str(num),
          html_content='<strong>Your code is ' + str(num) + '</strong>')
        sg = SendGridAPIClient(sendgrid_token)
        response = sg.send(message)
    return 'OK'

@app.route('/freeTrialStart', methods=['GET','POST'])
def freeTrialStart():
  addgrp = None
  if not request.form.get('grp') is None:
    items = get_one_by( 'groups', request.form.get('grp'), 'key' )
    addgrp = items[0]['id']
  cont = {}
  usr = []
  cont['phone'] = request.form.get("phone")
  cont['email'] = request.form.get("email").lower()
  cont['name'] = request.form.get("name")
  newuser = ''
  if len(cont['phone']) > 0:
    newuser = cont['phone']
    usr = get_one_by('contacts',newuser,'phone')
  if len(cont['email']) > 0:
    newuser = cont['email']
    usr = get_one_by('contacts',newuser,'email')
  os.chdir(appdir)
  tri = get_one_by('connectcodes',request.form.get("code"),'num')
  email = ''
  phone = ''
  for cocode in tri:
    email = cocode['email']
    phone = cocode['phone']
    if cont['email'] is None:
      cont['email'] = ''
    if (cont['phone'] == phone or cont['email'].lower() == email):
      del_one( 'connectcodes', cocode['id'] )
      break
  if not (cont['phone'] == phone or cont['email'].lower() == email):
    return '0'
  if ('' == phone and '' == email):
    return '0'
  ra = randomword(6)
  if len(usr) > 0 and usr[0]['user_id'] is None:
    u = usr[0]['id']
  else:
    exists = {}
    if len(usr) > 0:
      exists = get_parent(usr[0]['id'])
    if 'user_id' in exists and exists['user_id'] is None:
      u = exists['id']
    else:
      newgrp = [2]
      u = add_one('contacts',{
        'name':cont['name'],
        'email':cont['email'].lower(),
        'phone':cont['phone'],
        'groups':json.dumps(newgrp),
        'code':ra,
        'created':str(datetime.now())
      })
      newrec = {
        'name' : 'My Photos',
        'image':'',
        'maxres':'2000',
        'allowPosts':'0',
        'blockDownloads':'0',
        'user_id' : u,
        'key' : randomword(8),
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      gr1 = add_one( 'groups', newrec )
      con = mod_one('contacts',{'groups': json.dumps(newgrp + [gr1])},u)
      update_abilities()
  response = make_response(json.dumps( [ 'OK' ] ))
  session.permanent = True
  session['user'] = str(u)
  if not addgrp is None:
    usr = current_user()
    grpdata = get_one('groups',addgrp)
    if 'user_id' in grpdata[0]:
      growner = get_user(grpdata[0]['user_id'])
      share_my_contact(growner,[addgrp])
  return response

@app.route("/isAuthed", methods=['GET'])
def isAuthed():
  os.chdir(appdir)
  if 'user' in session:
    if int(session['user']) > 0:
      return '1'
  return '0'

@app.route("/logout", methods=['POST','GET'])
def logout():
  os.chdir(appdir)
  response = make_response('1')
  session['user'] = '0'
  return response

@app.route('/feed',methods=['GET','POST'])
def feed():
  limit = 25
  items = get_one_by( 'settings', 'https://' + mydomain + '/feed?k=' + request.args.get('k'), 'value' )
  if len(items) > 0:
    user = get_user(items[0]['user_id'])
    recs = get_all('posts')
    groups = json.loads(user['groups'])
    items = []
    for item in recs:
      if can('get','posts',user,item):
        item['title'] = get_user(item['user_id'])['name']
        pgrps = json.loads(item['groups'])
        for pgrp in pgrps:
          if pgrp in groups:
            thisgroup = get_one( 'groups', pgrp )
            if len(thisgroup) > 0:
              item['title'] = item['title'] + ' - ' + thisgroup[0]['name']
        items.append(item)
        if len(items) == limit:
          break
    channel = etree.Element('channel')
    etree.SubElement(channel,'title').text = 'Feed'
    etree.SubElement(channel,'link').text = 'https://' + mydomain
    etree.SubElement(channel,'description').text = ''
    for post in items:
      item = etree.Element('item')
      etree.SubElement(item,'title').text = post['title']
      d = post['created']
      if ":" == d[-3]:
        d = d[:-3]+d[-2:]
      etree.SubElement(item,'pubDate').text = utils.format_datetime(datetime.strptime(d, "%Y-%m-%d %H:%M:%S.%f%z"))
      enc = etree.Element('enclosure')
      if not post['sound'] is None:
        mtype = mimetypes.MimeTypes().guess_type(post['sound'])[0]
      if not mtype is None:
        if post['sound'][-3:] == 'mp3':
          enc.set('url', 'https://' + mydomain + '/myFile?name=' + urllib.parse.quote(post['sound']) + '&field=sound')
          if os.path.exists('myfiles/' + post['sound']):
            enc.set('length', str(os.path.getsize('myfiles/' + post['sound'])))
            enc.set('type', mtype)
            item.append(enc)
      elif not post['video'] is None:
        mtype = mimetypes.MimeTypes().guess_type(post['video'])[0]
        if post['video'][-3:].lower() in ['mov','mp4']:
          enc.set('url', 'https://' + mydomain + '/myFile?name=' + urllib.parse.quote(post['video']) + '&field=video')
          if os.path.exists('myfiles/' + post['video']):
            enc.set('length', str(os.path.getsize('myfiles/' + post['video'])))
            enc.set('type', mtype)
            item.append(enc)
        else:
          enc = etree.Element('enclosure')
          if not post['image'] is None:
            mtype = mimetypes.MimeTypes().guess_type(post['image'])[0]
          if not mtype is None:
            enc.set('url', 'https://' + mydomain + '/myFile?name=' + urllib.parse.quote(post['image']) + '&field=image')
            if os.path.exists('myfiles/' + post['image']):
              enc.set('length', str(os.path.getsize('myfiles/' + post['image'])))
              enc.set('type', mtype)
              item.append(enc)
      channel.append(item)
    root = etree.Element('rss')
    root.set('version', '2.0')
    root.append(channel)
    resp = make_response(etree.tostring(root, pretty_print=True).decode('utf-8'))
    resp.mimetype = "application/rss+xml"
    return resp
  return str(0)

@app.route('/getSettings',methods=['GET','POST'])
def getSettings():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  has_key = False
  if len(items) > 0:
    for sett in items:
      if sett['name'] == 'feedLink':
        has_key = True
  if not len(items) > 0 or not has_key:
    sett = add_one('settings',{
      'name':'feedLink',
      'value':'https://' + mydomain + '/feed?k=' + randomword(19),
      'user_id':session['user']
    })
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
    sett = add_one('settings',{
      'name':'filterDisabled',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  sett = {}
  for it in items:
    sett[it['name']] = it['value']
  return json.dumps(sett)

@app.route('/getPost',methods=['POST'])
def getPost():
  p = get_one_by( 'posts', request.form.get('postid'), 'key' )
  post = []
  if len(p) > 0:
    grps = json.loads(p[0]['groups'])
    if len(grps) == 1:
      thisgroup = get_one( 'groups', grps[0] )
      if len(thisgroup) == 1:
        if int(thisgroup[0]['public']) > 0:
          post.append(p[0])
  authd = ''
  if 'user' in session:
    if int(session['user']) > 0:
      authd = 'AUTHED'
  return json.dumps([post[0],authd])

@app.route('/getCal',methods=['GET'])
def getCal():
  user = current_user()
  recs = get_all('posts')
  posts = []
  cangrps = []
  groups = json.loads(user['groups'])
  ugrps = []
  if 'id' in user:
    ugrps = get_one_by('groups',user['id'],'user_id')
  ugrids = []
  for gr in ugrps:
    ugrids.append(gr['id'])
  posts_limit = 10
  posts_skipped = 0
  public_group = 0
  group_id = 0
  gall_counts = {}
  if not request.args.get('grp') is None:
    thisgroup = get_one_by( 'groups', request.args.get('grp'), 'key' )
    if len(thisgroup) > 0:
      if int(thisgroup[0]['public']) > 0:
        public_group = thisgroup[0]['id']
        public_group_entry = {'value':int(thisgroup[0]['id']),'label':thisgroup[0]['name'],'links':thisgroup[0]['shareLinks']}
  for item in recs:
    is_public = False
    if not item['inreplyto'] == '':
      continue
    if public_group > 0:
      grps = json.loads(item['groups'])
      if len(grps) > 0:
        if public_group in grps:
          is_public = True
    if is_public:
      item['to'] = ''
      item['imageHidden'] = False
      item['allowDownload'] = False
      item['isOwner'] = False
      item['textHidden'] = True
      item['showCommentField'] = False
      item['comments'] = []
      item['published'] = item['created']
      item['isHtml'] = False
      if not item['link'] is None:
        if len(item['link']) > 0:
          item['isHtml'] = True
      item['flagged'] = False
      comms = get_one_by('posts',item['id'],'inreplyto')
      for comm in list(reversed(comms)):
        comm['author'] = get_user(comm['user_id'])['name']
        item['comments'].append(comm)
      if item['image'] == '':
        item['imageHidden'] = True
      if 'event' in item:
        if not item['event'] is None:
          if len(item['event']) > 0:
            d = item['event']
            if ":" == d[-3]:
              d = d[:-3]+d[-2:]
            item['pubDate'] = datetime.strptime(d, "%Y-%m-%d %H:%M:%S%z").strftime('%Y-%m-%d')
            item['title'] = re.sub('<[^<]+?>', '', item['title'])
            posts.append(item)
  return( json.dumps( [posts] ) )

@app.route('/getPosts',methods=['GET','POST'])
def getPosts():
  allowgroups = get_one_by('groups','0','blockDownloads')
  allowdownload = []
  if len(allowgroups) > 0:
    for all in allowgroups:
      allowdownload.append(int(all['id']))
  user = current_user()
  recs = get_all('posts')
  posts = []
  cangrps = []
  groups = json.loads(user['groups'])
  ugrps = []
  if 'id' in user:
    ugrps = get_one_by('groups',user['id'],'user_id')
  ugrids = []
  for gr in ugrps:
    ugrids.append(gr['id'])
  posts_limit = 10
  posts_skipped = 0
  public_group = 0
  group_id = 0
  gall_counts = {}
  merged_groups = []
  if not request.args.get('grp') is None:
    thisgroup = get_one_by( 'groups', request.args.get('grp'), 'key' )
    if len(thisgroup) > 0:
      if int(thisgroup[0]['public']) > 0:
        public_group = thisgroup[0]['id']
        public_group_entry = {'value':int(thisgroup[0]['id']),'label':thisgroup[0]['name'],'links':thisgroup[0]['shareLinks']}
        try:
          merged_groups = json.loads(thisgroup[0]['mergeGroups'])
        except:
          merged_groups = []
      if not request.args.get('mine') is None:
        linkedgrps = []
        newrecs = []
        linked = json.loads(thisgroup[0]['publicGroups'])
        for item in recs:
          grps = json.loads(item['groups'])
          if len(grps) > 0:
            if set(grps).intersection(set(linked)):
              newrecs.append(item)
        recs = newrecs
  if not request.args.get('grpid') is None:
    thisgroup = get_one( 'groups', request.args.get('grpid') )
    group_id = thisgroup[0]['id']
  for item in recs:
    is_public = False
    if not item['inreplyto'] == '':
      continue
    if public_group > 0:
      grps = json.loads(item['groups'])
      if len(grps) > 0:
        if public_group in grps:
          is_public = True
      if set(grps).intersection(set(merged_groups)):
        is_public = True
    if not request.args.get('mine') is None:
      is_public = True
    if can('get','posts',user,item) or is_public:
      if int(item['user_id']) > 0:
        item['author'] = get_user(item['user_id'])['name']
      else:
        item['author'] = ''
      item['to'] = ''
      item['imageHidden'] = False
      item['allowDownload'] = False
      item['isOwner'] = False
      item['textHidden'] = True
      item['showCommentField'] = False
      item['comments'] = []
      item['published'] = item['created']
      item['isHtml'] = False
      if not item['link'] is None:
        if len(item['link']) > 0:
          item['isHtml'] = True
      comms = get_one_by('posts',item['id'],'inreplyto')
      for comm in list(reversed(comms)):
        comm['author'] = get_user(comm['user_id'])['name']
        item['comments'].append(comm)
      if item['image'] == '':
        item['imageHidden'] = True
      item['soundHidden'] = False
      if item['sound'] == '':
        item['soundHidden'] = True
      if item['image'] == '' and item['sound'] == '':
        item['textHidden'] = False
        if item['title'] == '':
          item['title'] = '(untitled)'
      item['isVideo'] = False
      if not item['video'] == '':
        item['imageHidden'] = True
        item['isVideo'] = True
        if item['title'] == '':
          item['title'] = '(untitled)'
      pgrps = json.loads(item['groups'])
      if request.args.get('mine') is None:
        if not set(pgrps).intersection(set(merged_groups)):
          if public_group > 0:
            if not public_group in pgrps:
              continue
          if group_id > 0:
            if not group_id in pgrps:
              continue
      for p in pgrps:
        if p in allowdownload:
          item['allowDownload'] = True
      if 'id' in user:
        if int(user['id']) == int(item['user_id']):
          item['isOwner'] = True
      if not request.args.get('mine') is None:
        if not item['isOwner']:
          continue
      if request.args.get('mine') is None:
        if 'flagged' in item:
          if not item['flagged'] is None:
            if len(item['flagged']) > 0:
              if (int(item['flagged']) > 0):
                continue
      item['flagged'] = False
      gall_limit = False
      for pgrp in pgrps:
        if pgrp in groups:
          thisgroup = get_one( 'groups', pgrp )
          if len(thisgroup) > 0:
            item['to'] = thisgroup[0]['name']
            item['toid'] = thisgroup[0]['id']
            if thisgroup[0]['id'] in gall_counts:
              gall_counts[thisgroup[0]['id']] = gall_counts[thisgroup[0]['id']] + 1
              #if gall_counts[thisgroup[0]['id']] > 0:
              #  gall_limit = True
            else:
              gall_counts[thisgroup[0]['id']] = 1
        if not pgrp in cangrps and not pgrp in ugrids and pgrp in groups:
          cangrps.append(pgrp)
      if not request.args.get('cursor') is None:
        if posts_skipped < int(request.args.get('cursor')):
          if not gall_limit or not request.args.get('grpid') is None:
            posts_skipped = posts_skipped + 1
        else:
          if not gall_limit or not request.args.get('grpid') is None:
            posts.append(item)
      else:
        if not gall_limit or not request.args.get('grpid') is None:
          posts.append(item)
      if len(posts) == posts_limit:
        break
    if expired(item):
      notify_del(item['user_id'])
      img = appdir + 'myfiles/' + item['image']
      if os.path.exists(img) and not item['image'] == '':
        os.remove(img)
      mus = appdir + 'myfiles/' + item['sound']
      if os.path.exists(mus) and not item['sound'] == '':
        os.remove(mus)
      del_one( 'posts', item['id'] )
  contacts = get_all('contacts')
  for cgrp in cangrps:
    newrec = {
      'title' : 'this is an example <a href="/">link</a>',
      'image' : '',
      'sound' : '',
      'groups' : '',
      'user_id' : '',
      'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) ),
      'imageHidden' : True,
      'soundHidden' : True,
      'textHidden' : False
    }
    #posts.append(newrec)
  abils = []
  grps = []
  if public_group > 0:
    grps.append(public_group_entry)
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    ispublic = False
    allowposts = False
    if len(group) > 0:
      groupname = group[0]['name']
      if 'allowPosts' in group[0]:
        if not group[0]['allowPosts'] is None:
          if int(group[0]['allowPosts']) > 0:
            allowposts = True
      if not int(group[0]['user_id']) == int(user['id']) and not allowposts:
        continue
      if 'public' in group[0]:
        if not group[0]['public'] is None:
          if int(group[0]['public']) > 0:
            ispublic = True
      glabel = ''
      comma = ''
      for con in contacts:
        if not con['groups'] is None:
          cgrps = json.loads(con['groups'])
          if grp in cgrps and not grp == 2:
            glabel = glabel + comma + con['name']
            comma = ', '
      if ispublic == False:
        grpnam = groupname + ': ' + glabel
      else:
        grpnam = groupname
      if not grpnam == '':
        grps.append({'value':grp,'label':grpnam,'links':group[0]['shareLinks']})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  feeds = []
  items = []
  if 'user' in session:
    settings = get_one_by( 'settings', session['user'], 'user_id' )
    filterdisabled = []
    if len(settings) > 1:
      for it in settings:
        if it['name'] == 'feedSubs':
          feeds = json.loads(it['value'])
        if it['name'] == 'filterDisabled':
          filterdisabled = json.loads(it['value'])
  if request.args.get('grpid') is None and request.args.get('grp') is None:
    for fd in feeds:
      feed = feedparser.parse(fd)
      for item in feed.entries:
        item['imageHidden'] = True
        item['textHidden'] = False
        item['soundHidden'] = True
        item['isHtml'] = True
        item['flagged'] = False
        if 'link' in item and not fd in filterdisabled:
          result = moderationCheck(item['link'], False)
          if int(result) > 0:
            item['flagged'] = True
        if 'enclosures' in item:
          if len(item['enclosures']) > 0:
            if 'href' in item['enclosures'][0]:
              if 'type' in item['enclosures'][0]:
                item['media'] = html.unescape(item['enclosures'][0]['href'])
                item['mediatype'] = item['enclosures'][0]['type']
                item['isVideo'] = False
                if 'mp3' in item['enclosures'][0]['href']:
                  item['soundHidden'] = False
                elif any([substring in item['enclosures'][0]['href'].lower() for substring in ['.mov','.mp4']]):
                  item['textHidden'] = True
                  item['isVideo'] = True
                  print(item['media'])
                else:
                  item['imageHidden'] = False
        if not 'title' in item:
          if 'description' in item:
            item['title'] = item['description']
          else:
            if 'content' in item:
              item['title'] = item['content']
            else:
              continue
        if item['title'] == '':
          item['title'] = '(untitled)'
        upd = ''
        if 'published' in item:
          upd = item['published']
        if 'published_parsed' in item:
          try:
            if not item['published_parsed'] is None:
              upd = datetime.fromtimestamp(round(time.mktime(item['published_parsed'][:8] + (-1,))))
          except (ValueError):
            pass
        elif 'updated_parsed' in item:
          try:
            if not item['updated_parsed'] is None:
              upd = datetime.fromtimestamp(round(time.mktime(item['updated_parsed'][:8] + (-1,))))
          except (ValueError):
            pass
        if not upd == '' and len(items) < 26:
          item['published'] = str(upd)
          items.append(item)
    print( 'POSTS ' + str(len(posts)) + ' and ITEMS ' + str(len(items)))
    posts = posts + items
  posts.sort(key=lambda p: p['published'], reverse=True)
  following = []
  for pgrp in groups:
    if not pgrp in ugrids:
      group = get_one( 'groups', pgrp )
      groupname = ''
      if len(group) > 0:
        groupname = group[0]['name']
        mysett = {
          'name':groupname,
          'id':group[0]['id'],
          'phone':True,
          'email':True,
          'freq':2,
          'interval':'Day',
          'last_notif':str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) )
        }
        settkey = 'group_' + str(group[0]['id'])
        items = get_one_by( 'settings', settkey, 'name' )
        for sett in items:
          if int(session['user']) == int(sett['user_id']):
            mysett = json.loads(sett['value'])
            mysett['name'] = groupname
            mysett['id'] = group[0]['id']
            mysett['freq'] = int(mysett['freq'])
            if mysett['phone'] == '1':
              mysett['phone'] = True
            else:
              mysett['phone'] = False
            if mysett['email'] == '1':
              mysett['email'] = True
            else:
              mysett['email'] = False
        following.append(mysett)
  return( json.dumps( [posts,grps,abils,user['code'],cangrps,following] ) )

@app.route('/dropFeed',methods=['GET','POST'])
def dropFeed():
  if not 'user' in session:
    return json.dumps([])
  feeds = []
  items = get_one_by( 'settings', session['user'], 'user_id' )
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
      for idx, fe in enumerate(feeds):
        if int(request.form.get('feed')) == idx:
          feeds.remove(fe)
          mod_one('settings',{'value':json.dumps(feeds)},sid)
  return json.dumps(feeds)

@app.route('/addFeeds',methods=['GET','POST'])
def addFeeds():
  if not 'user' in session:
    return json.dumps([])
  items = get_one_by( 'settings', session['user'], 'user_id' )
  if not len(items) > 1:
    sett = add_one('settings',{
      'name':'feedSubs',
      'value':'[]',
      'user_id':session['user']
    })
  items = get_one_by( 'settings', session['user'], 'user_id' )
  feeds = []
  sid = 0
  for it in items:
    if it['name'] == 'feedSubs':
      feeds = json.loads(it['value'])
      sid = it['id']
      feeds.append(request.form.get('feed'))
      mod_one('settings',{'value':json.dumps(feeds)},sid)
  return json.dumps(feeds)

@app.route('/addPosts',methods=['GET','POST'])
def addPosts():
  setHdr = -1
  if not request.form.get('doSetHeader') is None:
    if int(request.form.get('doSetHeader')) > -1:
      setHdr = int(request.form.get('doSetHeader'))
  maxRes = 0
  curr = current_user()
  saveImage = [saveFile( 'image' )]
  senditems = []
  imageupl = saveFile('imagemulti')
  if len(imageupl) > 0:
    saveImage = json.loads(imageupl)
  if not can('add','posts',curr):
    return( json.dumps( [ 'Error' ] ) )
  imgcount = -1
  firstimg = ''
  titles = json.loads(request.form.get('title'))
  for savedImage in saveImage:
    imgcount = imgcount + 1
    if imgcount == setHdr:
      firstimg = savedImage
  imgcount = -1
  postto = request.form.get('recips')
  if not request.form.get('newGallery') is None:
    if len(request.form.get('newGallery')) > 0:
      newrec = {
        'name' : request.form.get('newGallery'),
        'image' : '',
        'key':randomword(8),
        'maxres' : '0',
        'allowPosts' : '0',
        'shareLinks' : '0',
        'blockDownloads' : '0',
        'public':'0',
        'publicImage': '',
        'publicName': '',
        'publicBio': '',
        'publicLink': '',
        'publicPath': '',
        'publicGroups': '[]',
        'user_id' : session['user'],
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      rid = add_one( 'groups', newrec )
      if rid > 0:
        grps = json.loads(get_user(current_user()['id'])['groups'])
        grps.append(rid)
        mod_one('contacts',{'groups': json.dumps(grps)},current_user()['id'])
        recips = json.loads(postto)
        recips.append(rid)
        postto = json.dumps(recips)
  for savedImage in saveImage:
    imgcount = imgcount + 1
    doSetHeader = False
    if imgcount == setHdr:
      doSetHeader = True
    soundFile = saveFile( 'sound' )
    videoFile = ''
    if (savedImage[-7:].lower() in ['mov.jpg','mp4.jpg']):
      videoFile = savedImage[:-4]
    if (savedImage[-3:].lower() in ['mp3']):
      soundFile = savedImage
      savedImage = ''
    in_reply_to = ''
    if not request.form.get('inreplyto') is None:
      if not request.form.get('flagpost') is None:
        p = get_one_by( 'posts', request.form.get('flagpost'), 'key' )
        post = []
        if len(p) > 0:
          in_reply_to = str(p[0]['id'])
        unique = []
        comms = get_one_by('posts',p[0]['id'],'inreplyto')
        for comm in list(reversed(comms)):
          if not comm['user_id'] in unique:
            unique.append(comm['user_id'])
        if len(unique) > 4:
          mod_one('posts',{"flagged":"1"},p[0]['id'])
      else:
        in_reply_to = request.form.get('inreplyto')
    if request.form.get('shareLink') is None and request.form.get('shareText') is None:
      if len(titles) < (imgcount + 1):
        continue
    else:
      titles = [""]
    contactInfo = ''
    if not request.form.get('contactInfo') is None:
      contactInfo = request.form.get('contactInfo')
    newrec = {
      'title' : titles[imgcount],
      'image' : savedImage,
      'sound' : soundFile,
      'video' : videoFile,
      'groups' : postto,
      'inreplyto' : in_reply_to,
      'link':'',
      'user_id' : session['user'],
      'flagged' : '0',
      'contact': contactInfo,
      'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
    }
    if not request.form.get('shareText') is None:
      postkey = randomword(8)
      newrec['title'] = request.form.get('headline')
      newrec['key'] = postkey
      newrec['link'] = 'https://' + mydomain + '/post/' + postkey
      newrec['body'] = request.form.get('shareText')
    if not request.form.get('publicPost') is None:
      postkey = randomword(8)
      newrec['key'] = postkey
      newrec['link'] = 'https://' + mydomain + '/post/' + postkey
    if not request.form.get('eventDate') is None:
      if len(request.form.get('eventDate')) > 0:
        eventdate = datetime.strptime(request.form.get('eventDate'), "%Y-%m-%d")
        eventtime = request.form.get('eventTime').split(':')
        newrec['event'] = str( timezone( request.form.get('timeZone') ).localize( 
          eventdate.replace(hour=int(eventtime[0]), minute=int(eventtime[1]))
        ))
    if not request.form.get('shareLink') is None:
      newrec['link'] = request.form.get('shareLink')
      user_agent = 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.143 Safari/537.36'
      headers = {'User-Agent': user_agent}
      try:
        html = requests.get(newrec['link'],headers=headers,timeout=5)
        opengraphe = OpenGraphExtractor()
        titleset = False
        imageset = False
        data = opengraphe.extract(str(html.text))
        mytitle = ''
        myimage = ''
        for prop in data[0]['properties']:
          foundtit = False
          foundimg = False
          for ogdata in prop:
            print(str(ogdata))
            if not titleset or not imageset:
              if foundtit:
                mytitle = '<h1 class="article_hed">' + ogdata + '</h1>'
                titleset = True
                foundtit = False
              if ogdata == 'og:title':
                foundtit = True
              if foundimg:
                myimage = '<div class="feedimages"><img class="article_img" src="' + ogdata + '" alt="Image" /></div>'
                imageset = True
                foundimg = False
              if ogdata == 'og:image':
                foundimg = True
        if mytitle != '':
          newrec['title'] = mytitle + myimage
      except:
        print('EXC')
    if (newrec['sound'][-3:] == 'mp3'):
      #speedup = request.form.get('speedup')
      speedup = 0.9
      sound = AudioSegment.from_file(appdir + 'myfiles/' + newrec['sound'])
      sound_with_altered_frame_rate = sound._spawn(sound.raw_data, overrides={"frame_rate": int(sound.frame_rate * float(speedup))})
      sound_with_altered_frame_rate.export(appdir + 'myfiles/' + newrec['sound'], format="mp3")
    if (int(request.form.get('expirehours')) > 0):
      now_plus_hours = datetime.now() + timedelta(hours=int(request.form.get('expirehours')))
      newrec['expires'] = str( timezone( 'US/Pacific' ).localize( now_plus_hours ) )
    if not len(in_reply_to) > 0:
      for g in json.loads(postto):
         grpdata = get_one('groups',g)
         if len(grpdata) > 0:
           allowposts = False
           if 'allowPosts' in grpdata[0]:
             if not grpdata[0]['allowPosts'] is None:
               if int(grpdata[0]['allowPosts']) > 0:
                 allowposts = True
           if not int(curr['id']) == int(grpdata[0]['user_id']) and not allowposts:
             return( json.dumps( [ 'Error' ] ) )
    rid = add_one( 'posts', newrec )
    if rid > 0:
      if doSetHeader and firstimg is not '':
        newobj = {'image':firstimg}
        for g in json.loads(postto):
          grpdata = get_one('groups',g)
          growner = get_user(grpdata[0]['user_id'])
          if int(curr['id']) == int(growner['id']):
            mod_one( 'groups', newobj, g )
      dt = timezone( 'US/Pacific' ).localize( datetime.now() )
      newrec['id'] = rid
      contacts = get_all('contacts')
      recips = []
      sentgrps = []
      for con in contacts:
        if can('get','posts',con,newrec):
          grp = [value for value in json.loads(postto) if value in json.loads(con['groups'])][0]
          grpdata = get_one('groups',grp)
          notifprefs = get_one_by( 'settings', 'group_' + str(grp), 'name' )
          if 'maxres' in grpdata[0]:
            if not grpdata[0]['maxres'] is None:
              maxRes = int(grpdata[0]['maxres'])
          if not 'last_notif' in grpdata[0] or grpdata[0]['last_notif'] == None:
            rid = add_one( 'groups', {'last_notif':''} )
            if rid > 0:
              del_one('groups',rid)
          if not 'key' in grpdata[0] or grpdata[0]['key'] == None:
            newobj = { 'key' : randomword(8) }
            mod_one( 'groups', newobj, grpdata[0]['id'] )
            grpdata[0]['key'] = newobj['key']
          if not 'last_notif' in grpdata[0] or grpdata[0]['last_notif'] == None:
            newobj = { 'last_notif' : str( timezone( 'US/Pacific' ).localize( datetime.now() - timedelta(hours=25) ) ) }
            mod_one( 'groups', newobj, grpdata[0]['id'] )
            grpdata[0]['last_notif'] = newobj['last_notif']
          from dateutil import tz
          tzinfos = {"-08:00": tz.gettz('US/Pacific')}
          hasprefs = False
          for nprefs in notifprefs:
            pcontact = get_parent(con['id'])
            if int(nprefs['user_id']) == int(pcontact['id']):
              hasprefs = True
              notiprefs = json.loads(nprefs['value'])
              prefid = nprefs['id']
          if 'last_notif' in grpdata[0]:
            if hasprefs:
              interv = 24
              sendemail = False
              if int(notiprefs['email']) == 1:
                sendemail = True
              sendphone = False
              if int(notiprefs['phone']) == 1:
                sendphone = True
              if notiprefs['interval'] == 'Week':
                interv = 168
              hrs = interv / int(notiprefs['freq'])
              if 'last_notif' in notiprefs:
                dt = parser.parse(notiprefs['last_notif'], tzinfos=tzinfos) + timedelta(hours=int(hrs))
                if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
                  notify_photo( con['id'], grpdata[0]['key'], sendemail, sendphone )
                  notiprefs['last_notif'] = str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
                  mod_one('settings',{'value':json.dumps(notiprefs)},prefid)
            else:
              dt = parser.parse(grpdata[0]['last_notif'], tzinfos=tzinfos) + timedelta(hours=12)
              if dt < timezone( 'US/Pacific' ).localize( datetime.now() ):
                notify_photo( con['id'], grpdata[0]['key'], True, True )
                if not grpdata[0]['id'] in sentgrps:
                  sentgrps.append(grpdata[0]['id'])
          else:
            notify_photo( con['id'], grpdata[0]['key'], True, True )
            if not grpdata[0]['id'] in sentgrps:
              sentgrps.append(grpdata[0]['id'])
          recips.append( con['id'] )
      newobj = { 'last_notif' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) ) }
      for sentgrp in sentgrps:
        mod_one( 'groups', newobj, sentgrp )
      item = newrec
      item['imageHidden'] = False
      item['textHidden'] = True
      if item['image'] == '':
        item['imageHidden'] = True
      item['soundHidden'] = False
      if item['sound'] == '':
        item['soundHidden'] = True
      if item['image'] == '' and item['sound'] == '':
        item['textHidden'] = False
      senditems.append(item)
      clearSession('sound')
  clearSession('image')
  clearSession('imagemulti')
  if maxRes > 0:
    for savedImage in saveImage:
      filepath = appdir + 'myfiles/' + savedImage
      if filepath[-3:].lower() == 'jpg' or filepath[-3:].lower() == 'jpeg':
        try:
          image=Image.open(filepath)
          icc = image.info.get("icc_profile")
          resized_width = maxRes
          resized_height = int(round((maxRes/float(image.size[0]))*image.size[1])) 
          image = image.resize((resized_width, resized_height), Image.ANTIALIAS)
          resized_file = open(filepath.split('.')[0] + '_resized.jpg', "w")
          image.save(resized_file, 'JPEG', icc_profile=icc)
          #original_size = max(image.size[0], image.size[1])
          #if original_size >= maxRes:
          #  resized_file = open(filepath.split('.')[0] + '_resized.jpg', "w")
          #  if (image.size[0] > image.size[1]):
          #    resized_width = maxRes
          #    resized_height = int(round((maxRes/float(image.size[0]))*image.size[1])) 
          #  else:
          #    resized_height = maxRes
          #    resized_width = int(round((maxRes/float(image.size[1]))*image.size[0]))
          #  image = image.resize((resized_width, resized_height), Image.ANTIALIAS)
          #  image.save(resized_file, 'JPEG')
          image.save(filepath)
          image.close()
        except (AttributeError, KeyError, IndexError):
          pass
  resp = 'OK'
  if request.form.get('inreplyto') is None:
    ugrps = get_one_by( 'groups', curr['id'], 'user_id' )
    rcps = json.loads(postto)
    gname = ''
    for g in rcps:
      grpdata = get_one('groups',g)
      gname = str(grpdata[0]['name'])
      linkpath = '/grp/' + str(grpdata[0]['key'])
      resp = 'Updated gallery: ' + gname + ' ðŸ“· https://' + mydomain + linkpath
    for ug in ugrps:
      if not ug['public'] is None:
        if int(ug['public']) > 0:
          if not ug['publicGroups'] is None:
            for g in json.loads(ug['publicGroups']):
              if g in rcps:
                linkpath = '/grp/' + str(ug['key'])
                if not ug['publicPath'] == '':
                  linkpath = '/' + ug['publicPath']
                resp = ' ðŸ“· 1 of ' + str(len(saveImage)) + ' new in ' + gname + ' #shareinanewway #rplyphoto #rplyshare https://' + mydomain + linkpath
                if doSetHeader and firstimg is not '':
                  newobj = {'image':firstimg}
                  mod_one( 'groups', newobj, ug['id'] )
                break
  response = make_response(json.dumps( [ resp ] ))
  for item in senditems:
    item['author'] = get_user(item['user_id'])['name']
    sendcomet(recips,item)
  if not request.form.get('inreplyto') is None:
    for grp in json.loads(postto):
      try:
        notify_comment( grp, curr['name'] )
      except:
        print('comment error')
  return response

@app.route('/modPosts',methods=['GET','POST'])
def modPosts():
  item = get_one( 'posts', request.form.get('id') )[0]
  user = current_user()
  if not can('mod','posts',current_user(),item):
    grps = json.loads(item['groups'])
    ownerid = 0
    if len(grps) == 1:
      grpdata = get_one('groups',grps[0])
      if len(grpdata) > 0:
        ownerid = grpdata[0]['user_id']
    if not int(user['id']) == int(ownerid):
      return( json.dumps( [ 'Error' ] ) )
  linkVal = ''
  if not request.form.get('link') is None:
    linkVal = request.form.get('link')
  newobj = {
    'title' : request.form.get('title'),
    'body' : request.form.get('body'),
    'image' : saveFile( 'image' ),
    'sound' : saveFile( 'sound' ),
    'link' : linkVal
  }
  if newobj['image'] == '':
    del newobj['image']
  if newobj['sound'] == '':
    del newobj['sound']
  if mod_one( 'posts', newobj, request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/delPosts',methods=['GET','POST'])
def delPosts():
  item = get_one( 'posts', request.form.get('id') )[0]
  if not can('del','posts',current_user(),item):
    user = current_user()
    grps = json.loads(item['groups'])
    ownerid = 0
    if len(grps) == 1:
      grpdata = get_one('groups',grps[0])
      if len(grpdata) > 0:
        ownerid = grpdata[0]['user_id']
    if not int(user['id']) == int(ownerid):
      return( json.dumps( [ 'Error' ] ) )
  if del_one( 'posts', request.form.get('id') ):
    img = appdir + 'myfiles/' + item['image']
    if os.path.exists(img) and not item['image'] == '':
      os.remove(img)
    mus = appdir + 'myfiles/' + item['sound']
    if os.path.exists(mus) and not item['sound'] == '':
      os.remove(mus)
    item = get_one_by( 'groups', item['image'], 'image' )
    if len(item) > 0:
      mod_one( 'groups', {'image':''}, item[0]['id'] )
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/getGroups',methods=['GET','POST'])
def getGroups():
  user = current_user()
  recs = get_all('groups')
  items = []
  groups = json.loads(user['groups'])
  othergrps = []
  for item in recs:
    if can('get','groups',user,item) or item['id'] in groups:
      item['isOwner'] = False
      if 'id' in user:
        if int(user['id']) == int(item['user_id']):
          item['isOwner'] = True
          items.append(item)
        else:
          growner = get_user(item['user_id'])
          if 'name' in growner:
            item['name'] = item['name'] + ' - ' + growner['name']
          othergrps.append(item)
  contacts = get_all('contacts')
  abils = []
  grps = []
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    if len(group) > 0:
      groupname = group[0]['name']
      if not int(group[0]['user_id']) == int(user['id']):
        continue
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] == None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not con['name'] == 'Me':
          glabel = glabel + comma + con['name']
          comma = ', '
      if not glabel == '':
        grps.append({'value':grp,'label':groupname + ': ' + glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  return( json.dumps( [items,grps,abils,user['code'],othergrps] ) )

@app.route('/joinGroup',methods=['GET','POST'])
def joinGroup():
  os.chdir(appdir)
  authd = ''
  member = ''
  groups = []
  if 'user' in session:
    if int(session['user']) > 0:
      authd = 'AUTHED'
  items = get_one_by( 'groups', request.form.get('grp'), 'key' )
  if not len(items) > 0:
    items = get_one( 'groups', request.form.get('grp') )
  result = []
  if len(items) > 0:
    if 'user' in session:
      if int(session['user']) > 0:
        curr = current_user()
        groups = json.loads(curr['groups'])
        if int(items[0]['id']) in groups:
          member = 'MEMBER'
    owner = get_user(items[0]['user_id'])
    if not 'name' in owner:
      owner = {'name':''}
    imgsrc = ''
    if not items[0]['image'] is None:
      imgsrc = 'https://' + mydomain + '/grpFile?field=image&name=' + items[0]['image']
    publicData = '{}'
    shareLinks = '0'
    allowPosts = '0'
    if not items[0]['shareLinks'] is None:
      if int(items[0]['shareLinks']) > 0:
        shareLinks = '1'
    if not items[0]['allowPosts'] is None:
      if int(items[0]['allowPosts']) > 0:
        allowPosts = '1'
    if not items[0]['public'] is None:
      if int(items[0]['public']) > 0:
        linkedgrps = []
        linked = json.loads(items[0]['publicGroups'])
        for grp in linked:
          grpdata = get_one('groups',grp)
          if len(grpdata) > 0:
            if not grpdata[0]['image'] is None:
              if int(grpdata[0]['public']) > 0:
                grpLink = '/pubgroup/' + grpdata[0]['key']
              else:
                grpLink = '/showgroup/' + grpdata[0]['key']
              linkedgrps.append({
                'grp':grpdata[0]['key'],
                'name':grpdata[0]['name'],
                'image':'https://' + mydomain + '/grpFile?field=image&name=' + grpdata[0]['image'],
                'grpLink':grpLink,
                'open':grpdata[0]['allowPosts']
              })
        shareCal = '0'
        if 'shareCal' in items[0]:
          shareCal = items[0]['shareCal']
        publicData = json.dumps({
          'publicImage':items[0]['publicImage'],
          'publicName':items[0]['publicName'],
          'publicBio':items[0]['publicBio'],
          'publicLink':items[0]['publicLink'],
          'publicPath':items[0]['publicPath'],
          'publicGroups':linkedgrps,
          'shareCal':shareCal
        })
    result = [owner['name'],items[0]['name'],imgsrc,authd,items[0]['id'],member,publicData,shareLinks,allowPosts]
  return json.dumps(result)

@app.route('/addGroups',methods=['GET','POST'])
def addGroups():
  if not can('add','groups',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  newrec = {
    'name' : request.form.get('name'),
    'image' : '',
    'key':randomword(8),
    'maxres' : '0',
    'key':randomword(8),
    'allowPosts' : '0',
    'shareLinks' : '0',
    'shareCal' : '0',
    'blockDownloads' : '0',
    'public':'0',
    'publicImage': saveFile( 'publicImage' ),
    'publicName': request.form.get('publicName'),
    'publicBio': request.form.get('publicBio'),
    'publicLink': request.form.get('publicLink'),
    'publicPath': request.form.get('publicPath'),
    'publicGroups': request.form.get('publicGroups'),
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  if str(request.form.get('public')) == 'true':
    newrec['public'] = '1'
  if not '' == newrec['publicPath']:
    reserved = []
    for rule in app.url_map.iter_rules():
      reserved.append(rule.endpoint)
    if newrec['publicPath'] in reserved:
      return 'Error'
    grps = get_one_by( 'groups', newrec['publicPath'], 'publicPath' )
    if len(grps) > 0:
      return 'Error'
  rid = add_one( 'groups', newrec )
  grps = json.loads(get_user(current_user()['id'])['groups'])
  grps.append(rid)
  mod_one('contacts',{'groups': json.dumps(grps)},current_user()['id'])
  if rid > 0:
    clearSession('image')
    clearSession('publicImage')
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modGroups',methods=['GET','POST'])
def modGroups():
  item = get_one( 'groups', request.form.get('id') )[0]
  curr = current_user()
  if not can('mod','groups',curr,item):
    return( json.dumps( [ 'Error' ] ) )
  if not 'image' in item or not 'key' or not 'maxres' in item or not 'allowPosts' in item or not 'blockDownloads' in item:
    rid = add_one( 'groups', {'image':'','key':'','maxres':'2000','allowPosts':'0','blockDownloads':'1'} )
    if rid > 0:
      del_one('groups',rid)
  if not 'mergeGroups' in item:
    rid = add_one( 'groups', {'mergeGroups':''} )
    if rid > 0:
      del_one('groups',rid)
  scale = '0'
  if (int(request.form.get('maxres')) > 0):
    scale = request.form.get('maxres')
  feeds = '[]'
  if not request.form.get('feeds') is None:
    feeds = request.form.get('feeds')
  newobj = {
    'name' : request.form.get('name'),
    'image' : saveFile( 'image' ),
    'maxres' : scale,
    'allowPosts' : '0',
    'shareLinks' : '0',
    'shareCal' : '0',
    'blockDownloads' : '0',
    'public':'0',
    'publicImage': saveFile( 'publicImage' ),
    'publicName': request.form.get('publicName'),
    'publicBio': request.form.get('publicBio'),
    'publicLink': request.form.get('publicLink'),
    'publicGroups': request.form.get('publicGroups'),
    'publicPath': request.form.get('publicPath'),
    'feeds': feeds,
    'mergeGroups': request.form.get('mergeGroups')
  }
  if str(request.form.get('allowPosts')) == 'true':
    newobj['allowPosts'] = '1'
  if str(request.form.get('shareLinks')) == 'true':
    newobj['shareLinks'] = '1'
  if str(request.form.get('shareCal')) == 'true':
    newobj['shareCal'] = '1'
  if str(request.form.get('blockDownloads')) == 'true':
    newobj['blockDownloads'] = '1'
  if str(request.form.get('public')) == 'true':
    newobj['public'] = '1'
  if newobj['image'] == '':
    del newobj['image']
  if newobj['publicImage'] == '':
    del newobj['publicImage']
  reserved = []
  if not newobj['publicPath'] == '':
    if not item['publicPath'] == newobj['publicPath']:
      for rule in app.url_map.iter_rules():
        reserved.append(rule.endpoint)
      if newobj['publicPath'] in reserved:
        return 'Error'
      grps = get_one_by( 'groups', newobj['publicPath'], 'publicPath' )
      for chckgrp in grps:
        if not chckgrp['id'] == item['id']:
          return 'Error'
  if not 'key' in item or item['key'] == None:
    newobj['key'] = randomword(8)
    item['key'] = newobj['key']
  if mod_one( 'groups', newobj, request.form.get('id') ):
    items = get_one_by( 'groups', curr['id'], 'user_id' )
    if len(items) == 1:
      savedImage = saveFile( 'image' )
      in_reply_to = ''
      newrec = {
        'title' : '',
        'image' : savedImage,
        'sound' : '',
        'video' : '',
        'groups' : json.dumps([int(request.form.get('id'))]),
        'inreplyto' : in_reply_to,
        'link':'',
        'user_id' : session['user'],
        'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
      }
      rid = add_one( 'posts', newrec )
    clearSession('image')
    clearSession('publicImage')
    return( 'https://' + mydomain + '/grp/' + item['key'] )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/delGroups',methods=['GET','POST'])
def delGroups():
  item = get_one( 'groups', request.form.get('id') )[0]
  if not can('del','groups',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  else:
    delid = int(request.form.get('id'))
    if del_one( 'groups', delid):
      cons = get_all('contacts')
      for con in cons:
        groups = json.loads(con['groups'])
        if delid in groups:
          groups.remove(delid)
          mod_one('contacts',{'groups': json.dumps(groups)},con['id'])
      posts = get_all('posts')
      for pos in posts:
        groups = json.loads(pos['groups'])
        if delid in groups:
          groups.remove(delid)
          mod_one('posts',{'groups': json.dumps(groups)},pos['id'])
      return( json.dumps( [ 'OK' ] ) )
    else:
      return( json.dumps( [ 'Error' ] ) )

@app.route('/getContacts',methods=['GET','POST'])
def getContacts():
  user = current_user()
  recs = get_all('contacts')
  items = []
  for item in recs:
    if can('get','contacts',user,item):
      if not item['name'] == None and not item['user_id'] == None:
        items.append(item)
  contacts = get_all('contacts')
  groups = json.loads(user['groups'])
  abils = []
  grps = []
  for grp in groups:
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] == None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not con['name'] == 'Me':
          glabel = glabel + comma + con['name']
          comma = ', '
      if not glabel == '':
        grps.append({'value':grp,'label':glabel})
    for abb in abilities:
      if abb['group_id'] == grp:
        for act in abb['actions']:
          abils.append(act + abb['resource'])
  return( json.dumps( [items,grps,abils,user['code']] ) )

@app.route('/addContacts',methods=['GET','POST'])
def addContacts():
  if not can('add','contacts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : request.form.get('recips'),
    'code':ra,
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    share_my_contact(newrec,[])
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/quickAddContacts',methods=['GET','POST'])
def quickAddContacts():
  if not can('add','contacts',current_user()):
    return( json.dumps( [ 'Error' ] ) )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  user = current_user()
  groups = json.loads(user['groups'])
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : json.dumps([groups[1]]),
    'code':ra,
    'user_id' : session['user'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    share_my_contact(newrec,[])
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/doJoin',methods=['GET','POST'])
def doJoin():
  if request.form.get("phone") == '' and request.form.get("email") == '':
    grpdata = get_one_by( 'groups', request.form.get('grp'), 'key' )
    if 'user_id' in grpdata[0]:
      addgrp = grpdata[0]['id']
      growner = get_user(grpdata[0]['user_id'])
      share_my_contact(growner,[addgrp])
    return 'OK'
  items = get_one_by( 'groups', request.form.get('grp'), 'key' )
  ra = randomword(6)
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  cont = {}
  cont['phone'] = newph
  cont['email'] = request.form.get("email")
  cont['name'] = request.form.get("name")
  newuser = ''
  if len(cont['phone']) > 0:
    loginuser = cont['phone']
    usr = get_one_by('contacts',loginuser,'phone')
  if len(cont['email']) > 0:
    loginuser = cont['email']
    usr = get_one_by('contacts',loginuser,'email')
  num = randint(100, 999)
  cont = {}
  cont['phone'] = request.form.get("phone")
  cont['email'] = request.form.get("email").lower()
  add_one('connectcodes',{
    'num':num,
    'email':cont['email'],
    'phone':cont['phone']
  })
  if len(cont['phone']) > 0:
    client = Client(twilio_id, twilio_token)
    rl = "Your " + mydomain + " code is " + str(num)
    message = client.messages.create(
      body=rl,
      from_='+1' + os.getenv('TWILIO_FROM'),
      to=cont['phone']
    )
  if len(cont['email']) > 0:
    em = cont['email']
    message = Mail(
      from_email=os.getenv('SENDGRID_FROM'),
      to_emails=em,
      subject='Your ' + mydomain + ' connection code is ' + str(num),
      html_content='<strong>Your code is ' + str(num) + '</strong>')
    sg = SendGridAPIClient(sendgrid_token)
    response = sg.send(message)
  return 'OK'
  newrec = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph,
    'groups' : json.dumps([items[0]['id']]),
    'code':ra,
    'user_id' : items[0]['user_id'],
    'created' : str( timezone( 'US/Pacific' ).localize( datetime.now() ) )
  }
  rid = add_one( 'contacts', newrec )
  if rid > 0:
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modContacts',methods=['GET','POST'])
def modContacts():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('mod','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newph = ''.join(re.findall(r'[0-9]+', request.form.get('phone')))
  if len(newph) == 11:
    newph = newph[1:]
  newobj = {
    'name' : request.form.get('name'),
    'email' : request.form.get('email'),
    'phone' : newph
  }
  if mod_one( 'contacts', newobj, request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/modContactGroups',methods=['GET','POST'])
def modContactGroups():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('mod','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  newobj = {
    'groups' : request.form.get('groups')
  }
  mod_one( 'contacts', newobj, request.form.get('id') )
  contacts = get_all('contacts')
  user = current_user()
  groups = json.loads(user['groups'])
  grps = []
  for grp in groups:
    group = get_one( 'groups', grp )
    groupname = ''
    if len(group) > 0:
      groupname = group[0]['name']
      if not int(group[0]['user_id']) == int(user['id']):
        continue
    glabel = ''
    comma = ''
    for con in contacts:
      if not con['groups'] is None:
        cgrps = json.loads(con['groups'])
        if grp in cgrps and not grp == 2:
          glabel = glabel + comma + con['name']
          comma = ', '
    if not glabel == '':
      grps.append({'value':grp,'label':groupname + ': ' + glabel})
  update_abilities()
  return( json.dumps( [ grps ] ) )

@app.route('/delContacts',methods=['GET','POST'])
def delContacts():
  item = get_one( 'contacts', request.form.get('id') )[0]
  if not can('del','contacts',current_user(),item):
    return( json.dumps( [ 'Error' ] ) )
  if del_one( 'contacts', request.form.get('id') ):
    return( json.dumps( [ 'OK' ] ) )
  else:
    return( json.dumps( [ 'Error' ] ) )

@app.route('/uploadFile',methods=['GET','POST'])
def uploadFile():
  filedata = {}
  if not os.path.exists(appdir + 'myfiles'):
    os.makedirs(appdir + 'myfiles')
  if request.method == 'POST':
    if (sys.getsizeof(request.get_data()) > 5000):
      fi = tempfile.NamedTemporaryFile(delete=False)
      f = open(fi.name, 'w+b')
      f.write(request.get_data())
      f.close()
      filedata['tmp_name'] = fi.name
      filedata['name'] = time.strftime("%d_%m_%Y_%H_%M_%S_") + '.mp3'
    if 'file' in request.files:
      file = request.files['file']
      if not file.filename == '':
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
  if 'name' in filedata:
    fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
    filepath = appdir + 'myfiles/' + fname
    copyfile(filedata['tmp_name'], filepath)
    if not filepath[-3:].lower() in ['opml','xml','mp3']:
      try:
        image=Image.open(filepath)
        for orientation in ExifTags.TAGS.keys():
          if ExifTags.TAGS[orientation]=='Orientation':
            break
        exif=dict(image._getexif().items())
        if exif[orientation] == 3:
          image=image.rotate(180, expand=True)
        elif exif[orientation] == 6:
          image=image.rotate(270, expand=True)
        elif exif[orientation] == 8:
          image=image.rotate(90, expand=True)
        image.save(filepath)
        image.close()
      except (AttributeError, KeyError, IndexError):
        # cases: image don't have getexif
        pass
    response = make_response(json.dumps( [ 'OK' ] ))
    setSession(request.args.get('field'),fname)
    return response
  return 'OK'

@app.route('/uploadMulti',methods=['GET','POST'])
def uploadMulti():
  filedata = {}
  filenames = []
  uploaded = []
  if not os.path.exists(appdir + 'myfiles'):
    os.makedirs(appdir + 'myfiles')
  if request.method == 'POST':
    if not request.files.getlist('photos') is None:
      files = request.files.getlist('photos')
      for file in files:
        if file and allowed_file(file.filename):
          fi = tempfile.NamedTemporaryFile(delete=False)
          file.save(fi.name)
          filedata['tmp_name'] = fi.name
          filedata['name'] = file.filename
          if 'name' in filedata:
            fname = time.strftime("%Y%m%d-%H%M%S") + filedata['name']
            filepath = appdir + 'myfiles/' + fname
            copyfile(filedata['tmp_name'], filepath)
            if filepath[-3:].lower() in ['mov','mp4']:
              if filepath[-3:].lower() == 'mov':
                outfile = filepath.lower().replace('.mov','.mp4')
                fname = fname.lower().replace('.mov','.mp4')
                command = [
                  'ffmpeg',
                  '-i', filepath,
                  '-q:v', '0',
                  '-strict', '-2',
                  '-y', '-hide_banner',
                  '-nostats',
                  '-loglevel', 'quiet',
                  outfile ]
                pipe = subprocess.call( command )
                filepath = outfile
              uploaded.append({'url':fname + '.jpg','originalName':filedata['name'] + '.jpg'})
              filenames.append(fname + '.jpg')
            else:
              uploaded.append({'url':fname,'originalName':filedata['name']})
              filenames.append(fname)
            if filepath[-3:].lower() in ['mov','mp4']:
              vidcap = cv2.VideoCapture(filepath)
              success,image = vidcap.read()
              filepath = filepath + '.jpg'
              cv2.imwrite(filepath, image)
              image=Image.open(filepath)
              #image=image.rotate(180, expand=True)
              image.save(filepath)
              image.close()
            if not (filepath[-3:] == 'mp3'):
              try:
                image=Image.open(filepath)
                for orientation in ExifTags.TAGS.keys():
                  if ExifTags.TAGS[orientation]=='Orientation':
                    break
                exif=dict(image._getexif().items())
                rotated = False
                if exif[orientation] == 3:
                  image=image.rotate(180, expand=True)
                  rotated = True
                elif exif[orientation] == 6:
                  image=image.rotate(270, expand=True)
                  rotated = True
                elif exif[orientation] == 8:
                  image=image.rotate(90, expand=True)
                  rotated = True
                if rotated:
                  image.save(filepath)
                image.close()
              except (AttributeError, KeyError, IndexError):
                # cases: image don't have getexif
                pass
    response = make_response(json.dumps( [ uploaded ] ))
    setSession('imagemulti',json.dumps(filenames))
    return response
  return 'OK'

@app.route('/stagedFile',methods=['GET','POST'])
def stagedFile():
  return(saveFile(request.args.get('field')))

@app.route('/grpFile',methods=['GET','POST'])
def grpFile():
  thefile = False
  item = get_one_by( 'posts', request.args.get('name'), request.args.get('field') )
  if len(item) > 0:
    thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
    if os.path.exists(thefile) and not os.path.isdir(thefile):
      ftype = 'image/jpeg'
      print(thefile,file=sys.stderr)
      if 'svg' == thefile[-3:].lower():
        ftype = 'image/svg+xml'
      return send_file( thefile, mimetype=ftype)
  else:
    thefile = appdir + 'myfiles/' + request.args.get('name')
    if os.path.exists(thefile) and not os.path.isdir(thefile):
      limit = datetime.strptime('Nov 6 2020','%b %d %Y')
      mod = datetime.fromtimestamp(os.path.getmtime(thefile))
      if mod < limit or request.args.get('field') == 'publicImage':
        ftype = 'image/jpeg'
        print(thefile,file=sys.stderr)
        return send_file( thefile, mimetype=ftype)
  return 'Error'

@app.route('/myFile',methods=['GET','POST'])
def myFile():
  thefile = False
  if not request.args.get('staged') is None:
    if not request.args.get('multiname') is None:
      thefile = appdir + 'myfiles/' + request.args.get('multiname')
    else:
      if not saveFile(request.args.get('field')) == '':
        thefile = appdir + 'myfiles/' + saveFile(request.args.get('field'))
      else:
        item = get_one_by( 'groups', request.args.get('name'), request.args.get('field') )
        if len(item) > 0:
          thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
  else:
    item = get_one_by( 'posts', request.args.get('name'), request.args.get('field') )
    if len(item) > 0:
      thefile = appdir + 'myfiles/' + item[0][request.args.get('field')]
  ftype = 'image/jpeg'
  if thefile and not os.path.isdir(thefile):
    if (thefile[-3:].lower() == 'mp3'):
      ftype = 'audio/mp3'
    if (thefile[-3:].lower() in ['mov','mp4']):
      return send_from_directory(appdir + 'myfiles/', request.args.get('name'), conditional=True)
    print(thefile,file=sys.stderr)
    return send_file( thefile, mimetype=ftype)
  return 'Error'

abilities = [
  {
    'group_id':2,
    'resource':'posts',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'posts',
    'actions':['get'],
    'conditions':[['groups','groups']]
  },
  {
    'group_id':2,
    'resource':'posts',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['get'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'contacts',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['add']
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['get'],
    'conditions':[['user_id','id']]
  },
  {
    'group_id':2,
    'resource':'groups',
    'actions':['mod','del'],
    'conditions':[['user_id','id']]
  }
]

  </script>
</html>

